

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="彭">
  <meta name="keywords" content="">
  
    <meta name="description" content="JUC在Java中，线程部分是一个重点，本篇文章说的JUC也是关于线程的。JUC就是java.util.concurrent工具包的简称。这是一个处理线程的工具包。 进程与线程进程 是计算机中程序关于某数据集合的一次运行活动，是系统进行资源分配和调度的基本单位，是操作系统结构的基础。 线程是操作系统能够进行运算调度的最小单位。它被包含在进程之中，是进程中的实际运作单位。一个进程中可以并发多个线程，">
<meta property="og:type" content="article">
<meta property="og:title" content="Juc">
<meta property="og:url" content="http://example.com/2023/02/22/Juc/index.html">
<meta property="og:site_name" content="PJF">
<meta property="og:description" content="JUC在Java中，线程部分是一个重点，本篇文章说的JUC也是关于线程的。JUC就是java.util.concurrent工具包的简称。这是一个处理线程的工具包。 进程与线程进程 是计算机中程序关于某数据集合的一次运行活动，是系统进行资源分配和调度的基本单位，是操作系统结构的基础。 线程是操作系统能够进行运算调度的最小单位。它被包含在进程之中，是进程中的实际运作单位。一个进程中可以并发多个线程，">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/JUC_pic/31.png">
<meta property="og:image" content="http://example.com/JUC_pic/40.png">
<meta property="og:image" content="http://example.com/JUC_pic/32.png">
<meta property="og:image" content="http://example.com/JUC_pic/33.png">
<meta property="og:image" content="http://example.com/JUC_pic/34.png">
<meta property="og:image" content="http://example.com/JUC_pic/35.png">
<meta property="og:image" content="http://example.com/JUC_pic/1.png">
<meta property="og:image" content="http://example.com/JUC_pic/2.png">
<meta property="og:image" content="http://example.com/JUC_pic/3.png">
<meta property="og:image" content="http://example.com/JUC_pic/4.png">
<meta property="og:image" content="http://example.com/JUC_pic/5.png">
<meta property="og:image" content="http://example.com/JUC_pic/39.png">
<meta property="og:image" content="http://example.com/JUC_pic/6.png">
<meta property="og:image" content="http://example.com/JUC_pic/7.png">
<meta property="og:image" content="http://example.com/JUC_pic/38.png">
<meta property="og:image" content="http://example.com/JUC_pic/8.png">
<meta property="og:image" content="http://example.com/JUC_pic/9.png">
<meta property="og:image" content="http://example.com/JUC_pic/12.png">
<meta property="og:image" content="http://example.com/JUC_pic/13.png">
<meta property="og:image" content="http://example.com/JUC_pic/14.png">
<meta property="og:image" content="http://example.com/JUC_pic/15.png">
<meta property="og:image" content="http://example.com/JUC_pic/16.png">
<meta property="og:image" content="http://example.com/JUC_pic/17.png">
<meta property="og:image" content="http://example.com/JUC_pic/18.png">
<meta property="og:image" content="http://example.com/JUC_pic/19.png">
<meta property="og:image" content="http://example.com/JUC_pic/20.png">
<meta property="og:image" content="http://example.com/JUC_pic/21.png">
<meta property="og:image" content="http://example.com/JUC_pic/22.png">
<meta property="og:image" content="http://example.com/JUC_pic/23.png">
<meta property="og:image" content="http://example.com/JUC_pic/24.png">
<meta property="og:image" content="http://example.com/JUC_pic/25.png">
<meta property="og:image" content="http://example.com/JUC_pic/26.png">
<meta property="og:image" content="http://example.com/JUC_pic/27.png">
<meta property="og:image" content="http://example.com/JUC_pic/28.png">
<meta property="og:image" content="http://example.com/JUC_pic/29.png">
<meta property="og:image" content="http://example.com/JUC_pic/30.png">
<meta property="og:image" content="http://example.com/JUC_pic/36.png">
<meta property="og:image" content="http://example.com/JUC_pic/37.png">
<meta property="og:image" content="http://example.com/JUC_pic/37.png">
<meta property="og:image" content="http://example.com/JUC_pic/26.png">
<meta property="og:image" content="http://example.com/JUC_pic/27.png">
<meta property="og:image" content="http://example.com/JUC_pic/41.png">
<meta property="og:image" content="http://example.com/JUC_pic/42.png">
<meta property="og:image" content="c:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230707214957383.png">
<meta property="og:image" content="c:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230707215340412.png">
<meta property="og:image" content="c:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230707220135160.png">
<meta property="og:image" content="c:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230707222542359.png">
<meta property="og:image" content="c:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230707224418765.png">
<meta property="og:image" content="c:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230707224718299.png">
<meta property="og:image" content="c:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230708192343346.png">
<meta property="og:image" content="c:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230708192435387.png">
<meta property="og:image" content="c:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230707234808169.png">
<meta property="og:image" content="c:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230708192534371.png">
<meta property="og:image" content="c:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230708192704187.png">
<meta property="og:image" content="c:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230708203312284.png">
<meta property="og:image" content="c:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230708205155910.png">
<meta property="og:image" content="c:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230708205902062.png">
<meta property="og:image" content="c:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230708211016744.png">
<meta property="og:image" content="c:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230709102151941.png">
<meta property="og:image" content="c:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230709102042785.png">
<meta property="og:image" content="c:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230708115509974.png">
<meta property="og:image" content="c:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230708121608334.png">
<meta property="og:image" content="c:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230708124934452.png">
<meta property="og:image" content="c:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230708144718535.png">
<meta property="og:image" content="c:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230709215715775.png">
<meta property="og:image" content="c:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230709215859835.png">
<meta property="og:image" content="c:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230709215920057.png">
<meta property="og:image" content="c:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230709220045966.png">
<meta property="og:image" content="c:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230709220711944.png">
<meta property="og:image" content="c:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230709220737276.png">
<meta property="og:image" content="c:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230709220749139.png">
<meta property="og:image" content="c:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230709220844407.png">
<meta property="og:image" content="c:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230709221118587.png">
<meta property="og:image" content="c:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230709221724573.png">
<meta property="og:image" content="c:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230709221953856.png">
<meta property="og:image" content="c:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230709222007039.png">
<meta property="article:published_time" content="2023-02-22T08:59:34.207Z">
<meta property="article:modified_time" content="2023-07-09T14:48:39.688Z">
<meta property="article:author" content="彭">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/JUC_pic/31.png">
  
  
  
  <title>Juc - PJF</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>PJF</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>Tags</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Juc"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-02-22 16:59" pubdate>
          February 22, 2023 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          72k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          601 mins
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Juc</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="JUC"><a href="#JUC" class="headerlink" title="JUC"></a>JUC</h2><p>在Java中，线程部分是一个重点，本篇文章说的JUC也是关于线程的。JUC就是java.util.concurrent工具包的简称。这是一个处理线程的工具包。</p>
<h2 id="进程与线程"><a href="#进程与线程" class="headerlink" title="进程与线程"></a>进程与线程</h2><p><strong>进程</strong> 是计算机中程序关于某数据集合的一次运行活动，是系统进行资源分配和调度的基本单位，是操作系统结构的基础。</p>
<p><strong>线程</strong>是操作系统能够进行运算调度的最小单位。它被包含在进程之中，是进程中的实际运作单位。一个进程中可以并发多个线程，每条线程并行执行不同的任务。</p>
<p>简单来说：</p>
<p>进程：指系统中正在运行的一个应用程序；程序一旦运行就是进程；进程—–资源配分的最小单位</p>
<p>线程：系统分配处理机时间资源的基本单位，或者说进程之内独立执行的一个单元的执行流。线程—-程序执行的最小单位。</p>
<p>比如360安全卫士，打开这个软件就是一个进程，里面有木马查杀，垃圾清理，优化加速等可以分别执行的线程。</p>
<h2 id="volatile关键字"><a href="#volatile关键字" class="headerlink" title="volatile关键字"></a>volatile关键字</h2><p>一、<strong>简介</strong><br>volatile是Java提供的一种轻量级的同步机制。Java 语言包含两种内在的同步机制：同步块（或方法）和 volatile 变量，相比于synchronized（synchronized通常称为重量级锁），volatile更轻量级，因为它不会引起线程上下文的切换和调度。但是volatile 变量的同步性较差（有时它更简单并且开销更低），而且其使用也更容易出错。</p>
<p>二、<strong>并发编程的3个基本概念</strong><br>1.<strong>原子性</strong><br>     定义： 即一个操作或者多个操作 要么全部执行并且执行的过程不会被任何因素打断，要么就都不执行。</p>
<pre><code class="hljs">原子性是拒绝多线程操作的，不论是多核还是单核，具有原子性的量，同一时刻只能有一个线程来对它进行操作。简而言之，在整个操作过程中不会被线程调度器中断的操作，都可认为是原子性。例如 a=1是原子性操作，但是a++和a +=1就不是原子性操作。Java中的原子性操作包括：
</code></pre>
<p>（1）基本类型的读取和赋值操作，且赋值必须是值赋给变量，变量之间的相互赋值不是原子性操作。</p>
<p>（2）所有引用reference的赋值操作</p>
<p>（3）java.concurrent.Atomic.* 包中所有类的一切操作</p>
<p>2.<strong>可见性</strong><br>   定义：指当多个线程访问同一个变量时，一个线程修改了这个变量的值，其他线程能够立即看得到修改的值。</p>
<p>   在多线程环境下，一个线程对共享变量的操作对其他线程是不可见的。Java提供了volatile来保证可见性，当一个变量被volatile修饰后，表示着线程本地内存无效，当一个线程修改共享变量后他会立即被更新到主内存中，其他线程读取共享变量时，会直接从主内存中读取。当然，synchronize和Lock都可以保证可见性。synchronized和Lock能保证同一时刻只有一个线程获取锁然后执行同步代码，并且在释放锁之前会将对变量的修改刷新到主存当中。因此可以保证可见性。</p>
<p>3.<strong>有序性</strong><br>   定义：即程序执行的顺序按照代码的先后顺序执行。</p>
<p>   Java内存模型中的有序性可以总结为：如果在本线程内观察，所有操作都是有序的；如果在一个线程中观察另一个线程，所有操作都是无序的。前半句是指“线程内表现为串行语义”，后半句是指“指令重排序”现象和“工作内存主主内存同步延迟”现象。</p>
<p>   在Java内存模型中，为了效率是允许编译器和处理器对指令进行重排序，当然重排序不会影响单线程的运行结果，但是对多线程会有影响。Java提供volatile来保证一定的有序性。最著名的例子就是单例模式里面的DCL（双重检查锁）。另外，可以通过synchronized和Lock来保证有序性，synchronized和Lock保证每个时刻是有一个线程执行同步代码，相当于是让线程顺序执行同步代码，自然就保证了有序性。</p>
<p>三、<strong>锁的互斥和可见性</strong><br>   锁提供了两种主要特性：互斥（mutual exclusion） 和可见性（visibility）。</p>
<p>（1）互斥即一次只允许一个线程持有某个特定的锁，一次就只有一个线程能够使用该共享数据。</p>
<p>（2）可见性要更加复杂一些，它必须确保释放锁之前对共享数据做出的更改对于随后获得该锁的另一个线程是可见的。也即当一条线程修改了共享变量的值，新值对于其他线程来说是可以立即得知的。如果没有同步机制提供的这种可见性保证，线程看到的共享变  量可能是修改前的值或不一致的值，这将引发许多严重问题。要使 volatile 变量提供理想的线程安全，必须同时满足下面两个条件：</p>
<pre><code class="hljs">a.对变量的写操作不依赖于当前值。

b.该变量没有包含在具有其他变量的不变式中。
</code></pre>
<p>  实际上，这些条件表明，可以被写入 volatile 变量的这些有效值独立于任何程序的状态，包括变量的当前状态。事实上就是保证操作是原子性操作，才能保证使用volatile关键字的程序在并发时能够正确执行。</p>
<p>四、<strong>Java的内存模型JMM以及共享变量的可见性</strong><br> JMM决定一个线程对共享变量的写入何时对另一个线程可见，JMM定义了线程和主内存之间的抽象关系：共享变量存储在主内存(Main Memory)中，每个线程都有一个私有的本地内存（Local Memory），本地内存保存了被该线程使用到的主内存的副本拷贝，线程对变量的所有操作都必须在工作内存中进行，而不能直接读写主内存中的变量。</p>
<p><img src="/../JUC_pic/31.png" srcset="/img/loading.gif" lazyload alt="juc"></p>
<p>   对于普通的共享变量来讲，线程A将其修改为某个值发生在线程A的本地内存中，此时还未同步到主内存中去；而线程B已经缓存了该变量的旧值，所以就导致了共享变量值的不一致。解决这种共享变量在多线程模型中的不可见性问题，较粗暴的方式自然就是加锁，但是此处使用synchronized或者Lock这些方式太重量级了，比较合理的方式其实就是volatile。</p>
<p>  需要注意的是，JMM是个抽象的内存模型，所以所谓的本地内存，主内存都是抽象概念，并不一定就真实的对应cpu缓存和物理内存</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VolatileTest</span> &#123;<br>    <span class="hljs-type">static</span> <span class="hljs-type">boolean</span> run = <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span> throws InterruptedException </span>&#123;<br>        Thread t = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Thread</span>(()-&gt;&#123;<br>            <span class="hljs-keyword">while</span>(run)&#123;<br>                <br>            &#125;<br>        &#125;,<span class="hljs-string">&quot;t1&quot;</span>);<br>        t.<span class="hljs-built_in">start</span>();<br>        <span class="hljs-built_in">sleep</span>(<span class="hljs-number">1</span>);<br>        run = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 线程t不会如预想的停下来</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行以上代码，可以看到结果，程序并没有结束，而是一直处于运行状态，按道理来说主线程不是将run 置于false了吗？t1应该暂停才对啊，这就涉及到可见性问题，主线程在自己的工作内存修改了run的值，但是t1线程不知道主线程修改了run的值，所以一直在运行。</p>
<p>解决办法：</p>
<ul>
<li>将run用volatile修饰</li>
</ul>
<p>再次运行程序，程序暂停下来了，说明volatile可以将run在任何一个线程中做出的修改马上让其他线程可见。(volatile是Java提供的一种轻量级的同步机制)</p>
<ul>
<li><p>在while(){}里加一个System.out.println();</p>
<p>点开println()方法</p>
<p><img src="/../JUC_pic/40.png" srcset="/img/loading.gif" lazyload alt="juc"></p>
</li>
</ul>
<p>可以看到println()里加了synchronized锁</p>
<p>JMM关于synchronized的两条规定:</p>
<p>1）线程加锁时，将清空工作内存中共享变量的值，从而使用共享变量时需要从主内存中重新获取最新的值</p>
<p>2）线程解锁前，必须把共享变量的最新值刷新到主内存中</p>
<p>（注意：加锁与解锁需要是同一把锁）</p>
<p>synchronized具体过程是：</p>
<p>获得同步锁；<br>清空工作内存；<br>从主内存拷贝对象副本到工作内存；<br>执行代码(计算或者输出等)；<br>刷新主内存数据；<br>释放同步锁。</p>
<p>五、<strong>volatile变量的特性</strong><br> 1.保证可见性，不保证原子性<br>  （1）当写一个volatile变量时，JMM会把该线程本地内存中的变量强制刷新到主内存中去；</p>
<p>  （2）这个写会操作会导致其他线程中的volatile变量缓存无效。</p>
<p> 2.禁止指令重排<br>    重排序是指编译器和处理器为了优化程序性能而对指令序列进行排序的一种手段。重排序需要遵守一定规则：</p>
<p> （1）重排序操作不会对存在数据依赖关系的操作进行重排序。</p>
<p>　 比如：a&#x3D;1;b&#x3D;a; 这个指令序列，由于第二个操作依赖于第一个操作，所以在编译时和处理器运行时这两个操作不会被重排序。</p>
<p> （2）重排序是为了优化性能，但是不管怎么重排序，单线程下程序的执行结果不能被改变</p>
<p>　 比如：a&#x3D;1;b&#x3D;2;c&#x3D;a+b这三个操作，第一步（a&#x3D;1)和第二步(b&#x3D;2)由于不存在数据依赖关系， 所以可能会发生重排序，但是c&#x3D;a+b这个操作是不会被重排序的，因为需要保证最终的结果一定是c&#x3D;a+b&#x3D;3。</p>
<pre><code class="hljs">重排序在单线程下一定能保证结果的正确性，但是在多线程环境下，可能发生重排序，影响结果，下例中的1和2由于不存在数据依赖关系，则有可能会被重排序，先执行status=true再执行a=2。而此时线程B会顺利到达4处，而线程A中a=2这个操作还未被执行，所以b=a+1的结果也有可能依然等于2。
</code></pre>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestVolatile</span>&#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<span class="hljs-comment">//状态切换为true</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> changeStatus&#123;<br>        a = <span class="hljs-number">2</span>;   <span class="hljs-comment">//1</span><br>        status = <span class="hljs-literal">true</span>;  <span class="hljs-comment">//2</span><br>    &#125;<span class="hljs-comment">//若状态为true，则为running</span><br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">if</span>(status)&#123;   <span class="hljs-comment">//3</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> a + <span class="hljs-number">1</span>;  <span class="hljs-comment">//4</span><br>        System.out.println(b);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>​     使用volatile关键字修饰共享变量便可以禁止这种重排序。若用volatile修饰共享变量，在编译时，会在指令序列中插入内存屏障来禁止特定类型的处理器重排序,volatile禁止指令重排序也有一些规则：</p>
<pre><code class="hljs"> a.当程序执行到volatile变量的读操作或者写操作时，在其前面的操作的更改肯定全部已经进行，且结果已经对后面的操作可见；在其后面的操作肯定还没有进行；

 b.在进行指令优化时，不能将对volatile变量访问的语句放在其后面执行，也不能把volatile变量后面的语句放到其前面执行。

 即执行到volatile变量时，其前面的所有语句都执行完，后面所有语句都未执行。且前面语句的结果对volatile变量及其后面语句可见。
</code></pre>
<p>六、<strong>volatile不适用的场景</strong><br> 1.volatile不适合复合操作<br>  例如，int++不是一个原子性操作，可以由读取、加、赋值3步组成，所以结果并不能达到30000。.</p>
<p><img src="/../JUC_pic/32.png" srcset="/img/loading.gif" lazyload></p>
<p>  2.解决方法<br> （1）采用synchronized</p>
<p><img src="/../JUC_pic/33.png" srcset="/img/loading.gif" lazyload></p>
<p> （2）采用Lock</p>
<p><img src="/../JUC_pic/34.png" srcset="/img/loading.gif" lazyload></p>
<p> （3）采用java并发包中的原子操作类，原子操作类是通过CAS循环的方式来保证其原子性的</p>
<p><img src="/../JUC_pic/35.png" srcset="/img/loading.gif" lazyload></p>
<p>七、<strong>volatile原理</strong><br>  volatile可以保证线程可见性且提供了一定的有序性，但是无法保证原子性。在JVM底层volatile是采用“内存屏障”来实现的。观察加入volatile关键字和没有加入volatile关键字时所生成的汇编代码发现，加入volatile关键字时，会多出一个lock前缀指令，lock前缀指令实际上相当于一个内存屏障（也成内存栅栏），内存屏障会提供3个功能：</p>
<p>（1）它确保指令重排序时不会把其后面的指令排到内存屏障之前的位置，也不会把前面的指令排到内存屏障的后面；即在执行到内存屏障这句指令时，在它前面的操作已经全部完成；</p>
<p>（2）它会强制将对缓存的修改操作立即写入主存；</p>
<p>（3）如果是写操作，它会导致其他CPU中对应的缓存行无效。</p>
<p>八、<strong>单例模式的双重锁为什么要加volatile</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestInstance</span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">static</span> TestInstance instance;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TestInstance <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">if</span>(instance == <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">synchronized</span>(TestInstance.class)&#123; <br>                <span class="hljs-keyword">if</span>(instance == <span class="hljs-literal">null</span>)&#123;<br>                    instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TestInstance</span>();<br>                &#125;<br>            &#125;<br>        &#125;<span class="hljs-keyword">return</span> instance;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>




<p>   需要volatile关键字的原因是，在并发情况下，如果没有volatile关键字，在第5行会出现问题。instance &#x3D; new TestInstance();可以分解为3行伪代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">a. memory = allocate() <span class="hljs-comment">//分配内存</span><br>b. ctorInstanc(memory) <span class="hljs-comment">//初始化对象</span><br>c. instance = memory <span class="hljs-comment">//设置instance指向刚分配的地址 </span><br></code></pre></td></tr></table></figure>

<p>   上面的代码在编译运行时，可能会出现重排序从a-b-c排序为a-c-b。在多线程的情况下会出现以下问题。当线程A在执行第5行代码时，B线程进来执行到第2行代码。假设此时A执行的过程中发生了指令重排序，即先执行了a和c，没有执行b。那么由于A线程执行了c导致instance指向了一段地址，所以B线程判断instance不为null，会直接跳到第6行并返回一个未初始化的对象。</p>
<h2 id="创建多线程的几种方式"><a href="#创建多线程的几种方式" class="headerlink" title="创建多线程的几种方式"></a>创建多线程的几种方式</h2><h3 id="继承Thread类创建线程"><a href="#继承Thread类创建线程" class="headerlink" title="继承Thread类创建线程"></a>继承Thread类创建线程</h3><p><strong>通过继承Thread</strong>类来创建并启动多线程的一般步骤如下：</p>
<p>1】定义Tread类的子类MyThread，并重写run()方法.run()方法的方法体（线程执行体）就是线程要执行的任务。</p>
<p>2】创建My<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=Thread%E7%B1%BB&spm=1001.2101.3001.7020">Thread类</a>的实例</p>
<p>3】调用子类实例的start()方法来启动线程</p>
<p>创建Thread1类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Thread1</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>)&#123;<br>            System.out.println(<span class="hljs-string">&quot;a&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>创建Thread2类</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Thread2</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Thread</span></span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    public void run() &#123;<br>        <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>)&#123;<br>            <span class="hljs-type">System</span>.out.println(<span class="hljs-string">&quot;b&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在主方法中：</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> void main(<span class="hljs-keyword">String</span>[] args) &#123;<br>        Thread t1 =<span class="hljs-keyword">new</span> <span class="hljs-type">Thread1</span>();<br>        Thread t2 =<span class="hljs-keyword">new</span> <span class="hljs-type">Thread2</span>();<br>        t1.start();<br>        t2.start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="实现-Runnable接口创建线程"><a href="#实现-Runnable接口创建线程" class="headerlink" title="实现 Runnable接口创建线程"></a><strong>实现 Runnable接口创建线程</strong></h3><p>通过实现Runnable接口创建并启动线程的一般步骤如下：</p>
<p>1】定义Runnable接口的实现类，必须重写run(）方法，这个run()方法和Thread中的run()方法一样，是线程的执行体</p>
<p>2】创建Runnable实现类的实例，并用这个实例作为Thread的target来创建Thread对象，这个Thread对象才是真正的线程对象</p>
<p>3】调用start()方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RunnableTest</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;: &quot;</span>+i);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">RunnableTest</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span><span class="hljs-keyword">new</span> <span class="hljs-title class_">RunnableTest</span>();<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span><span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(r,<span class="hljs-string">&quot;线程1&quot;</span>);<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span><span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(r,<span class="hljs-string">&quot;线程2&quot;</span>);<br>        t1.start();<br>        t2.start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">线程2: 0</span><br><span class="hljs-section">线程2: 1</span><br><span class="hljs-section">线程1: 0</span><br><span class="hljs-section">线程2: 2</span><br><span class="hljs-section">线程1: 1</span><br><span class="hljs-section">线程2: 3</span><br><span class="hljs-section">线程1: 2</span><br><span class="hljs-section">线程2: 4</span><br><span class="hljs-section">线程1: 3</span><br><span class="hljs-section">线程1: 4</span><br></code></pre></td></tr></table></figure>

<h3 id="继承Thread和实现Runnable接口的区别"><a href="#继承Thread和实现Runnable接口的区别" class="headerlink" title="继承Thread和实现Runnable接口的区别"></a>继承Thread和实现Runnable接口的区别</h3><ul>
<li>实现Runnable接口避免单继承局限</li>
<li>当子类实现Runnable接口，此时子类</li>
</ul>
<h3 id="实现Callable接口配合FutureTask"><a href="#实现Callable接口配合FutureTask" class="headerlink" title="实现Callable接口配合FutureTask"></a>实现Callable接口配合FutureTask</h3><p>实现</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs gcode">步骤：<br><span class="hljs-number">1.</span>创建一个实现Callable的实现类<br><span class="hljs-number">2.</span>实现<span class="hljs-keyword">call</span>方法，将此线程需要执行的操作声明在<span class="hljs-keyword">call</span><span class="hljs-comment">()</span>中<br><span class="hljs-number">3.</span>创建Callable接口实现类的对象<br><span class="hljs-number">4.</span>将此Callable接口实现类的对象作为传递到FutureTask构造器中，创建FutureTask的对象<br><span class="hljs-number">5.</span>将FutureTask的对象作为参数传递到Thread类的构造器中，创建Thread对象，并调用start<span class="hljs-comment">()</span><br><span class="hljs-number">6.</span>获取Callable中<span class="hljs-keyword">call</span>方法的返回值<br></code></pre></td></tr></table></figure>

<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gcode">**实现Callable接口的方式创建线程的强大之处**<br><span class="hljs-keyword">call</span><span class="hljs-comment">()</span>可以有返回值的<br><span class="hljs-keyword">call</span><span class="hljs-comment">()</span>可以抛出异常，被外面的操作捕获，获取异常的信息<br>Callable是支持泛型的<br></code></pre></td></tr></table></figure>

<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs axapta"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadNew</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> main(String[] args) &#123;<br>        <span class="hljs-comment">//3.创建Callable接口实现类的对象</span><br>        NumThread numThread = <span class="hljs-keyword">new</span> NumThread();<br><br>        <span class="hljs-comment">//4.将此Callable接口实现类的对象作为传递到FutureTask构造器中，创建FutureTask的对象</span><br>        FutureTask futureTask = <span class="hljs-keyword">new</span> FutureTask(numThread);<br><br>        <span class="hljs-comment">//5.将FutureTask的对象作为参数传递到Thread类的构造器中，创建Thread对象，并调用start()</span><br>        <span class="hljs-keyword">new</span> Thread(futureTask).start();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//6.获取Callable中call方法的返回值</span><br>            <span class="hljs-comment">//get()返回值即为FutureTask构造器参数Callable实现类重写的call()的返回值。</span><br>            Object <span class="hljs-keyword">sum</span> = futureTask.get();<br>            System.out.println(<span class="hljs-string">&quot;总和为：&quot;</span> + <span class="hljs-keyword">sum</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (ExecutionException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NumThread</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_ inherited__">Callable</span> &#123;<br>    <span class="hljs-comment">//2.实现call方法，将此线程需要执行的操作声明在call()中</span><br>    @Override<br>    <span class="hljs-keyword">public</span> Object call() throws Exception &#123;<br>        <span class="hljs-built_in">int</span> <span class="hljs-keyword">sum</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-comment">//把100以内的偶数相加</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">100</span>; i++) &#123;<br>            <span class="hljs-keyword">if</span> (i % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) &#123;<br>                System.out.println(i);<br>                <span class="hljs-keyword">sum</span> += i;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">sum</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="线程池创建"><a href="#线程池创建" class="headerlink" title="线程池创建"></a>线程池创建</h3><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">来自项目中的代码<br><span class="hljs-comment">//定义一个线程池</span><br>    <span class="hljs-keyword">private</span> static final ExecutorService CACHE_REBUILD_EXECUTOR = 			     <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Executors</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">FixedThreadPool(10)</span>;<br>  .<br>  .<br>  .<br>  .<br>      		<span class="hljs-comment">//6.3获取锁成功 ，开启独立线程进行缓存重建</span><br>  			<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">CACHE_REBUILD_EXECUTOR</span>.</span></span>submit(<span class="hljs-literal">()</span>-&gt;&#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-comment">//查询数据库</span><br>                    R r1 = dbFallback.apply(id);<br>                    <span class="hljs-comment">//写入redis</span><br>                    this.set<span class="hljs-constructor">WithLogicExpire(<span class="hljs-params">key</span>,<span class="hljs-params">r1</span>,<span class="hljs-params">time</span>,<span class="hljs-params">unit</span>)</span>;<br>                &#125; catch (Exception e) &#123;<br>                    throw <span class="hljs-keyword">new</span> <span class="hljs-constructor">RuntimeException(<span class="hljs-params">e</span>)</span>;<br>                &#125;finally &#123;<br>                    <span class="hljs-comment">//释放🔒</span><br>                    unlock(lockKey);<br>                &#125;<br>            &#125;);<br>    <br>  <br></code></pre></td></tr></table></figure>

<h2 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h2><h3 id="死锁的四个必要条件"><a href="#死锁的四个必要条件" class="headerlink" title="死锁的四个必要条件"></a>死锁的四个必要条件</h3><ul>
<li><strong>互斥条件</strong>：资源是独占的且排他使用，进程互斥使用资源，即任意时刻一个资源只能给一个进程使用，其他进程若申请一个资源，而该资源被另一进程占有时，则申请者等待直到资源被占有者释放。</li>
<li><strong>不可剥夺条件</strong>：进程所获得的资源在未使用完毕之前，不被其他进程强行剥夺，而只能由获得该资源的进程资源释放。</li>
<li><strong>请求和保持条件</strong>：进程每次申请它所需要的一部分资源，在申请新的资源的同时，继续占用已分配到的资源。</li>
<li><strong>循环等待条件</strong>：在发生死锁时必然存在一个进程等待队列{P1,P2,…,Pn},其中P1等待P2占有的资源，P2等待P3占有的资源，…，Pn等待P1占有的资源，形成一个进程等待环路，环路中每一个进程所占有的资源同时被另一个申请，也就是前一个进程占有后一个进程所深情地资源。</li>
</ul>
<p>以上给出了导致死锁的四个必要条件，只要系统发生死锁则以上四个条件至少有一个成立。事实上循环等待的成立蕴含了前三个条件的成立，似乎没有必要列出然而考虑这些条件对死锁的预防是有利的，因为可以通过破坏四个条件中的任何一个来预防死锁的发生。</p>
<p>面试官：手写一个死锁demo~</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">deadLockDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">lock1</span> <span class="hljs-operator">=</span><span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">lock2</span> <span class="hljs-operator">=</span><span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DeadLockTusk</span>(lock1,lock2,<span class="hljs-literal">true</span>),<span class="hljs-string">&quot;线程1&quot;</span>).start();<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DeadLockTusk</span>(lock1,lock2,<span class="hljs-literal">false</span>),<span class="hljs-string">&quot;线程2&quot;</span>).start();<br>    &#125;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DeadLockTusk</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span>&#123;<br>        <span class="hljs-keyword">private</span> Object lock1;<br>        <span class="hljs-keyword">private</span> Object lock2;<br>        <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> flag;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">DeadLockTusk</span><span class="hljs-params">(Object lock1, Object lock2, <span class="hljs-type">boolean</span> flag)</span> &#123;<br>            <span class="hljs-built_in">this</span>.lock1 = lock1;<br>            <span class="hljs-built_in">this</span>.lock2 = lock2;<br>            <span class="hljs-built_in">this</span>.flag = flag;<br>        &#125;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">if</span>(flag) &#123;<br>                <span class="hljs-keyword">synchronized</span> (lock1)&#123;<br>                    System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;拿到了锁1&quot;</span>);<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        Thread.sleep(<span class="hljs-number">1000</span>);<br>                    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                        e.printStackTrace();<br>                    &#125;<br>                    System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;等待锁2释放&quot;</span>);<br>                    <span class="hljs-keyword">synchronized</span> (lock2)&#123;<br>                        System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;拿到了锁2&quot;</span>);<br>                    &#125;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">if</span>(!flag) &#123;<br>                <span class="hljs-keyword">synchronized</span> (lock2)&#123;<br>                    System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;拿到了锁2&quot;</span>);<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        Thread.sleep(<span class="hljs-number">1000</span>);<br>                    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                        e.printStackTrace();<br>                    &#125;<br>                    System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;等待锁1释放&quot;</span>);<br>                    <span class="hljs-keyword">synchronized</span> (lock1)&#123;<br>                        System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;拿到了锁1&quot;</span>);<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="预防死锁"><a href="#预防死锁" class="headerlink" title="预防死锁"></a>预防死锁</h3><p>我们可以通过破坏死锁产生的4个必要条件来 预防死锁，由于资源互斥是资源使用的固有特性是无法改变的。</p>
<ul>
<li><strong>破坏“不可剥夺”条件</strong>：一个进程不能获得所需要的全部资源时便处于等待状态，等待期间它占有的资源将被隐式的释放重新加入到 系统的资源列表中，可以被其他的进程使用，而等待的进程只有重新获得自己原有的资源以及新申请的资源才可以重新启动，执行。</li>
<li><strong>破坏”请求与保持条件“</strong>：第一种方法静态分配即每个进程在开始执行时就申请他所需要的全部资源。第二种是动态分配即每个进程在申请所需要的资源时他本身不占用系统资源。</li>
<li><strong>破坏“循环等待”条件</strong>：采用资源有序分配其基本思想是将系统中的所有资源顺序编号，将紧缺的，稀少的采用较大的编号，在申请资源时必须按照编号的顺序进行，一个进程只有获得较小编号的进程才能申请较大编号的进程。</li>
</ul>
<h2 id="线程的状态"><a href="#线程的状态" class="headerlink" title="线程的状态"></a>线程的状态</h2><p>Java 线程在运行的生命周期中的指定时刻只可能处于下面 6 种不同状态的其中一个状态：</p>
<ul>
<li>NEW: 初始状态，线程被创建出来但没有被调用 <code>start()</code> 。</li>
<li>RUNNABLE: 运行状态，线程被调用了 <code>start()</code>等待运行的状态。</li>
<li>BLOCKED ：阻塞状态，需要等待锁释放。</li>
<li>WAITING：等待状态，表示该线程需要等待其他线程做出一些特定动作（通知或中断）。(不见不散)</li>
<li>TIME_WAITING：超时等待状态，可以在指定的时间后自行返回而不是像 WAITING 那样一直等待。（过时不候）</li>
<li>TERMINATED：终止状态，表示该线程已经运行完毕。</li>
</ul>
<p><img src="/../JUC_pic/1.png" srcset="/img/loading.gif" lazyload></p>
<p>由上图可以看出：</p>
<ul>
<li><p>线程创建之后它将处于 <strong>NEW（新建）</strong> 状态，调用 <code>start()</code> 方法后开始运行，线程这时候处于 <strong>READY（可运行）</strong> 状态。可运行状态的线程获得了 CPU 时间片（timeslice）后就处于 <strong>RUNNING（运行）</strong> 状态。</p>
</li>
<li><p>当线程执行 <code>wait()</code>方法之后，线程进入 <strong>WAITING（等待）</strong> 状态。进入等待状态的线程需要依靠其他线程的通知才能够返回到运行状态。</p>
</li>
<li><p><strong>TIMED_WAITING(超时等待)</strong> 状态相当于在等待状态的基础上增加了超时限制，比如通过 <code>sleep（long millis）</code>方法或 <code>wait（long millis）</code>方法可以将线程置于 TIMED_WAITING 状态。当超时时间结束后，线程将会返回到 RUNNABLE 状态。</p>
</li>
<li><p>当线程进入 <code>synchronized</code> 方法&#x2F;块或者调用 <code>wait</code> 后（被 <code>notify</code>）重新进入 <code>synchronized</code> 方法&#x2F;块，但是锁被其它线程占有，这个时候线程就会进入 <strong>BLOCKED（阻塞）</strong> 状态。</p>
</li>
<li><p>线程在执行完了 <code>run()</code>方法之后将会进入到 <strong>TERMINATED（终止）</strong> 状态。</p>
</li>
</ul>
<h2 id="同步与异步"><a href="#同步与异步" class="headerlink" title="同步与异步"></a>同步与异步</h2><ul>
<li>需要等待结果返回才能继续运行就是同步</li>
<li>不需要等待结果返回就能继续运行就是异步</li>
</ul>
<h2 id="查看进程和线程的方法"><a href="#查看进程和线程的方法" class="headerlink" title="查看进程和线程的方法"></a>查看进程和线程的方法</h2><p>Windows</p>
<ul>
<li>任务管理器</li>
<li>tasklist查看进程 ( tasklist | findstr “xx”)</li>
<li>taskkill杀死进程</li>
</ul>
<p>Linux</p>
<ul>
<li>ps  -ef查看所有进程(ps -ef | grep 关键字)</li>
<li>ps -fT -p <PID> 查看某个进程(PID)的所有线程</li>
<li>kill 杀死进程</li>
<li>top 按大写H切换是否显示线程</li>
<li>top -H -p <PID> 查看某个进程(PID)的所有线程</li>
</ul>
<p>Java</p>
<ul>
<li>jps命令查看所有Java进程</li>
<li>jstack <PID>查看某个Java进程(PID)的所有线程状态</li>
<li>jconsole来查看某个Java进程中线程的运行情况(图像界面)</li>
</ul>
<h2 id="线程中的常见方法"><a href="#线程中的常见方法" class="headerlink" title="线程中的常见方法"></a>线程中的常见方法</h2><p><img src="/../JUC_pic/2.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/../JUC_pic/3.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/../JUC_pic/4.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="start与run的区别"><a href="#start与run的区别" class="headerlink" title="start与run的区别"></a>start与run的区别</h3><ul>
<li><p>直接调用 run 是在主线程中执行了 run，没有启动新的线程</p>
</li>
<li><p>使用 start 是启动新的线程，通过新的线程间接执行 run 中的代码</p>
</li>
</ul>
<h3 id="Sleep"><a href="#Sleep" class="headerlink" title="Sleep"></a>Sleep</h3><ol>
<li>调用 sleep 会让当前线程从 Running 进入 Timed Waiting 状态（阻塞）</li>
<li>其它线程可以使用 interrupt 方法打断正在睡眠的线程，这时 sleep 方法会抛出 InterruptedException </li>
<li>睡眠结束后的线程未必会立刻得到执行</li>
<li>建议用 TimeUnit 的 sleep 代替 Thread 的 sleep 来获得更好的可读性</li>
</ol>
<h3 id="yield-让出，谦让"><a href="#yield-让出，谦让" class="headerlink" title="yield(让出，谦让)"></a>yield(让出，谦让)</h3><ol>
<li>调用 yield 会让当前线程从 Running 进入 Runnable 就绪状态，然后调度执行其它线程 </li>
<li>具体的实现依赖于操作系统的任务调度器</li>
</ol>
<h3 id="join-重要"><a href="#join-重要" class="headerlink" title="join(重要)"></a>join(重要)</h3><p>下面的代码执行，打印 r 是什么？</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs livescript"><span class="hljs-keyword">static</span> int r = <span class="hljs-number">0</span>;<br>public <span class="hljs-keyword">static</span> <span class="hljs-literal">void</span> main(<span class="hljs-built_in">String</span>[] args) throws InterruptedException &#123;<br> test1();<br>&#125;<br>private <span class="hljs-keyword">static</span> <span class="hljs-literal">void</span> test1() throws InterruptedException &#123;<br> log.debug(<span class="hljs-string">&quot;开始&quot;</span>);<br> Thread t1 = <span class="hljs-keyword">new</span> Thread<span class="hljs-function"><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> log.debug(<span class="hljs-string">&quot;开始&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function"> sleep(<span class="hljs-number">1</span>);</span></span><br><span class="hljs-params"><span class="hljs-function"> log.debug(<span class="hljs-string">&quot;结束&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function"> r = <span class="hljs-number">10</span>;</span></span><br><span class="hljs-params"><span class="hljs-function"> &#125;)</span>;</span><br><span class="hljs-function"> <span class="hljs-title">t1</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function"> <span class="hljs-title">log</span>.<span class="hljs-title">debug</span><span class="hljs-params">(<span class="hljs-string">&quot;结果为:&#123;&#125;&quot;</span>, r)</span>;</span><br><span class="hljs-function"> <span class="hljs-title">log</span>.<span class="hljs-title">debug</span><span class="hljs-params">(<span class="hljs-string">&quot;结束&quot;</span>)</span>;</span><br><span class="hljs-function">&#125;</span><br></code></pre></td></tr></table></figure>

<p>分析</p>
<ul>
<li>因为主线程和线程 t1 是并行执行的，t1 线程需要 1 秒之后才能算出 r&#x3D;10</li>
<li>而主线程一开始就要打印 r 的结果，所以只能打印出 r&#x3D;0</li>
</ul>
<p>解决方法 </p>
<ul>
<li>用 sleep 行不行？为什么？</li>
<li>用 join，加在 t1.start() 之后即可</li>
</ul>
<p>Eg:  t1.join()  &#x3D;&#x3D; 主线程等待t1运行结束再运行后面的内容。</p>
<p>加了join，异步—&gt;同步</p>
<h3 id="interrupt"><a href="#interrupt" class="headerlink" title="interrupt"></a>interrupt</h3><p><strong>注意</strong>：interrupt只会给线程打个标记，不会真的打断线程，要打断线程还是得靠isInterrupted()方法判断再决定是否打断。</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs livescript">public <span class="hljs-keyword">static</span> <span class="hljs-literal">void</span> main(<span class="hljs-built_in">String</span>[] args) throws InterruptedException &#123;<br>        Thread thread=<span class="hljs-keyword">new</span> Thread<span class="hljs-function"><span class="hljs-params">(()-&gt;&#123;</span></span><br><span class="hljs-params"><span class="hljs-function">            <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>)&#123;</span></span><br><span class="hljs-params"><span class="hljs-function">                System.out.println(<span class="hljs-string">&quot;正在运行。。。&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function">            &#125;</span></span><br><span class="hljs-params"><span class="hljs-function">        &#125;,<span class="hljs-string">&quot;t1&quot;</span>)</span>;</span><br><span class="hljs-function"></span><br><span class="hljs-function">        <span class="hljs-title">thread</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">        <span class="hljs-title">Thread</span>.<span class="hljs-title">sleep</span><span class="hljs-params">(<span class="hljs-number">500</span>)</span>;</span><br><span class="hljs-function">        <span class="hljs-title">thread</span>.<span class="hljs-title">interrupt</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">    &#125;</span><br></code></pre></td></tr></table></figure>

<p>结果是不断得打印“正在运行。。。”</p>
<p>可以打断 sleep，wait，join 的线程</p>
<p>这几个方法都会让线程进入阻塞状态</p>
<p>打断sleep,wait,join的线程，会清空打断状态</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs livescript">private <span class="hljs-keyword">static</span> <span class="hljs-literal">void</span> test1() throws InterruptedException &#123;<br> 	Thread t1 = <span class="hljs-keyword">new</span> Thread<span class="hljs-function"><span class="hljs-params">(()-&gt;&#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 		sleep(<span class="hljs-number">1</span>);</span></span><br><span class="hljs-params"><span class="hljs-function"> 	&#125;, <span class="hljs-string">&quot;t1&quot;</span>)</span>;</span><br><span class="hljs-function"> 	<span class="hljs-title">t1</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function"> 	<span class="hljs-title">sleep</span><span class="hljs-params">(<span class="hljs-number">0.5</span>)</span>;</span><br><span class="hljs-function"> 	<span class="hljs-title">t1</span>.<span class="hljs-title">interrupt</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function"> 	<span class="hljs-title">log</span>.<span class="hljs-title">debug</span><span class="hljs-params">(<span class="hljs-string">&quot; 打断状态: &#123;&#125;&quot;</span>, t1.isInterrupted())</span>;</span><br><span class="hljs-function">&#125;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs stylus">输出:<br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.InterruptedException</span>: sleep interrupted<br> at java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.Thread</span><span class="hljs-selector-class">.sleep</span>(Native Method)<br> at java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.Thread</span><span class="hljs-selector-class">.sleep</span>(Thread<span class="hljs-selector-class">.java</span>:<span class="hljs-number">340</span>)<br> at java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.concurrent</span><span class="hljs-selector-class">.TimeUnit</span><span class="hljs-selector-class">.sleep</span>(TimeUnit<span class="hljs-selector-class">.java</span>:<span class="hljs-number">386</span>)<br> at cn<span class="hljs-selector-class">.itcast</span><span class="hljs-selector-class">.n2</span><span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Sleeper</span><span class="hljs-selector-class">.sleep</span>(Sleeper<span class="hljs-selector-class">.java</span>:<span class="hljs-number">8</span>)<br> at cn<span class="hljs-selector-class">.itcast</span><span class="hljs-selector-class">.n4</span><span class="hljs-selector-class">.TestInterrupt</span>.lambda<span class="hljs-variable">$test1</span>$<span class="hljs-number">3</span>(TestInterrupt<span class="hljs-selector-class">.java</span>:<span class="hljs-number">59</span>)<br> at java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.Thread</span><span class="hljs-selector-class">.run</span>(Thread<span class="hljs-selector-class">.java</span>:<span class="hljs-number">745</span>)<br><span class="hljs-number">21</span>:<span class="hljs-number">18</span>:<span class="hljs-number">10.374</span> <span class="hljs-selector-attr">[main]</span> c<span class="hljs-selector-class">.TestInterrupt</span> - 打断状态: false<br></code></pre></td></tr></table></figure>

<p>打断正常运行的线程, 不会清空打断状态</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs livescript">private <span class="hljs-keyword">static</span> <span class="hljs-literal">void</span> test2() throws InterruptedException &#123;<br> Thread t2 = <span class="hljs-keyword">new</span> Thread<span class="hljs-function"><span class="hljs-params">(()-&gt;&#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 	<span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 		Thread thread = Thread.currentThread();</span></span><br><span class="hljs-params"><span class="hljs-function"> 		boolean interrupted = thread.isInterrupted();</span></span><br><span class="hljs-params"><span class="hljs-function"> 		<span class="hljs-keyword">if</span>(interrupted) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 			log.debug(<span class="hljs-string">&quot; 打断状态: &#123;&#125;&quot;</span>, interrupted);</span></span><br><span class="hljs-params"><span class="hljs-function"> 			<span class="hljs-keyword">break</span>;</span></span><br><span class="hljs-params"><span class="hljs-function"> 		&#125;</span></span><br><span class="hljs-params"><span class="hljs-function"> 	&#125;</span></span><br><span class="hljs-params"><span class="hljs-function"> &#125;, <span class="hljs-string">&quot;t2&quot;</span>)</span>;</span><br><span class="hljs-function"> 	<span class="hljs-title">t2</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function"> 	<span class="hljs-title">sleep</span><span class="hljs-params">(<span class="hljs-number">0.5</span>)</span>;</span><br><span class="hljs-function"> 	<span class="hljs-title">t2</span>.<span class="hljs-title">interrupt</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">&#125;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">20</span>:<span class="hljs-number">57</span>:<span class="hljs-number">37</span>.<span class="hljs-number">964</span><span class="hljs-meta"> [t2] c.TestInterrupt - 打断状态: true </span><br></code></pre></td></tr></table></figure>

<h3 id="两阶段终止模式"><a href="#两阶段终止模式" class="headerlink" title="两阶段终止模式"></a>两阶段终止模式</h3><p>Two Phase Termination</p>
<p>在一个线程T1中如何‘优雅“终止线程T2？这里的”优雅“指的是给T2一个料理后事的机会</p>
<p>比如释放资源，避免不释放资源的情况</p>
<p><img src="/../JUC_pic/5.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> &#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>) throws InterruptedException</span> &#123;<br>        TwoPhaseTermination tpt = <span class="hljs-keyword">new</span> TwoPhaseTermination();<br>        tpt.start();<br>        Thread.sleep(<span class="hljs-number">3500</span>);<br>        tpt.stop();<br>    &#125;<br>&#125;<br><span class="hljs-keyword">class</span> <span class="hljs-title">TwoPhaseTermination</span> &#123;<br>    <span class="hljs-keyword">private</span> Thread monitor;<br>    <span class="hljs-comment">// 启动监控线程</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">start</span>()</span> &#123;<br>        monitor = <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Runnable() &#123;<br>            @Override<br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span>()</span> &#123;<br>                <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                    Thread thread = Thread.currentThread();<br>                    <span class="hljs-keyword">if</span> (thread.isInterrupted()) &#123;<span class="hljs-comment">//通过线程自带的是否被中断过标签</span><br>                        <span class="hljs-comment">/*</span><br><span class="hljs-comment">                         *被打断后的操作，业务处理在这里处理</span><br><span class="hljs-comment">                        */</span><br>                        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;后置处理&quot;</span>);<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        Thread.sleep(<span class="hljs-number">1000</span>);					<span class="hljs-comment">// 睡眠</span><br>                        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;执行监控记录&quot;</span>);	<span class="hljs-comment">// 在此被打断不会异常</span><br>                    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;		<span class="hljs-comment">// 在睡眠期间被打断，进入异常处理的逻辑</span><br>                        e.printStackTrace();<br>                        <span class="hljs-comment">// 重新设置打断标记，打断 sleep 会清除打断状态</span><br>                        thread.interrupt();<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;);<br>        monitor.start();<br>    &#125;<br>    <span class="hljs-comment">// 停止监控线程</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stop</span>()</span> &#123;<br>        monitor.interrupt();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="park"><a href="#park" class="headerlink" title="park"></a>park</h3><p>使用park，线程会在该处停止，可以用interrupt方法打断使其继续运行，但是interrupt会使打断标记为true，park接下来会失效，不会阻塞，isInterruped方法不会清除打断标记，打断标记依然为ture，park依然失效，此时使用Interruped方法，会清除打断标记，此时打断标记为false，park又可以生效了，继续阻塞。</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs livescript">private <span class="hljs-keyword">static</span> <span class="hljs-literal">void</span> test3() throws InterruptedException &#123;<br> Thread t1 = <span class="hljs-keyword">new</span> Thread<span class="hljs-function"><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 	log.debug(<span class="hljs-string">&quot;park...&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function"> 	LockSupport.park();</span></span><br><span class="hljs-params"><span class="hljs-function"> 	log.debug(<span class="hljs-string">&quot;unpark...&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function"> 	log.debug(<span class="hljs-string">&quot;打断状态：&#123;&#125;&quot;</span>, Thread.currentThread().isInterrupted());</span></span><br><span class="hljs-params"><span class="hljs-function"> &#125;, <span class="hljs-string">&quot;t1&quot;</span>)</span>;</span><br><span class="hljs-function"> 	<span class="hljs-title">t1</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function"> 	<span class="hljs-title">sleep</span><span class="hljs-params">(<span class="hljs-number">0.5</span>)</span>;</span><br><span class="hljs-function"> 	<span class="hljs-title">t1</span>.<span class="hljs-title">interrupt</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">&#125;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">21</span>:<span class="hljs-number">11</span>:<span class="hljs-number">52.795</span> <span class="hljs-selector-attr">[t1]</span> c<span class="hljs-selector-class">.TestInterrupt</span> - park... <br><span class="hljs-number">21</span>:<span class="hljs-number">11</span>:<span class="hljs-number">53.295</span> <span class="hljs-selector-attr">[t1]</span> c<span class="hljs-selector-class">.TestInterrupt</span> - unpark... <br><span class="hljs-number">21</span>:<span class="hljs-number">11</span>:<span class="hljs-number">53.295</span> <span class="hljs-selector-attr">[t1]</span> c<span class="hljs-selector-class">.TestInterrupt</span> - 打断状态：true<br></code></pre></td></tr></table></figure>

<p>打断标记为真时，park会失效</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs livescript">private <span class="hljs-keyword">static</span> <span class="hljs-literal">void</span> test4() &#123;<br> Thread t1 = <span class="hljs-keyword">new</span> Thread<span class="hljs-function"><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 	<span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 	log.debug(<span class="hljs-string">&quot;park...&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function"> 	LockSupport.park();</span></span><br><span class="hljs-params"><span class="hljs-function"> 	log.debug(<span class="hljs-string">&quot;打断状态：&#123;&#125;&quot;</span>, Thread.currentThread().isInterrupted());</span></span><br><span class="hljs-params"><span class="hljs-function"> &#125;</span></span><br><span class="hljs-params"><span class="hljs-function"> &#125;)</span>;</span><br><span class="hljs-function"> 	<span class="hljs-title">t1</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function"> 	<span class="hljs-title">sleep</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span>;</span><br><span class="hljs-function"> 	<span class="hljs-title">t1</span>.<span class="hljs-title">interrupt</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">&#125;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">21</span>:<span class="hljs-number">13</span>:<span class="hljs-number">48.783</span> <span class="hljs-selector-attr">[Thread-0]</span> c<span class="hljs-selector-class">.TestInterrupt</span> - park... <br><span class="hljs-number">21</span>:<span class="hljs-number">13</span>:<span class="hljs-number">49.809</span> <span class="hljs-selector-attr">[Thread-0]</span> c<span class="hljs-selector-class">.TestInterrupt</span> - 打断状态：true <br><span class="hljs-number">21</span>:<span class="hljs-number">13</span>:<span class="hljs-number">49.812</span> <span class="hljs-selector-attr">[Thread-0]</span> c<span class="hljs-selector-class">.TestInterrupt</span> - park... <br><span class="hljs-number">21</span>:<span class="hljs-number">13</span>:<span class="hljs-number">49.813</span> <span class="hljs-selector-attr">[Thread-0]</span> c<span class="hljs-selector-class">.TestInterrupt</span> - 打断状态：true <br><span class="hljs-number">21</span>:<span class="hljs-number">13</span>:<span class="hljs-number">49.813</span> <span class="hljs-selector-attr">[Thread-0]</span> c<span class="hljs-selector-class">.TestInterrupt</span> - park... <br><span class="hljs-number">21</span>:<span class="hljs-number">13</span>:<span class="hljs-number">49.813</span> <span class="hljs-selector-attr">[Thread-0]</span> c<span class="hljs-selector-class">.TestInterrupt</span> - 打断状态：true <br><span class="hljs-number">21</span>:<span class="hljs-number">13</span>:<span class="hljs-number">49.813</span> <span class="hljs-selector-attr">[Thread-0]</span> c<span class="hljs-selector-class">.TestInterrupt</span> - park... <br><span class="hljs-number">21</span>:<span class="hljs-number">13</span>:<span class="hljs-number">49.813</span> <span class="hljs-selector-attr">[Thread-0]</span> c<span class="hljs-selector-class">.TestInterrupt</span> - 打断状态：true <br><span class="hljs-number">21</span>:<span class="hljs-number">13</span>:<span class="hljs-number">49.813</span> <span class="hljs-selector-attr">[Thread-0]</span> c<span class="hljs-selector-class">.TestInterrupt</span> - park... <br><span class="hljs-number">21</span>:<span class="hljs-number">13</span>:<span class="hljs-number">49.813</span> <span class="hljs-selector-attr">[Thread-0]</span> c<span class="hljs-selector-class">.TestInterrupt</span> - 打断状态：true <br><br></code></pre></td></tr></table></figure>

<p>提示:</p>
<p>可以使用 Thread.interrupted() 清除打断状态</p>
<h3 id="wait-x2F-notify用例"><a href="#wait-x2F-notify用例" class="headerlink" title="wait&#x2F;notify用例"></a>wait&#x2F;notify用例</h3><p>让我们先通过一个示例解析</p>
<p>wait()方法可以使线程进入等待状态，并且会释放synchronized锁,而notify()可以使等待的状态唤醒。这样的同步机制十分适合生产者、消费者模式：消费者消费某个资源，而生产者生产该资源。当该资源缺失时，消费者调用wait()方法进行自我阻塞，等待生产者的生产；生产者生产完毕后调用notify&#x2F;notifyAll()唤醒消费者进行消费。</p>
<p>以下是代码示例，其中flag标志表示资源的有无。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> ThreadTest &#123;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Object obj = <span class="hljs-keyword">new</span> Object();  <span class="hljs-comment">//对象锁</span><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> flag = <span class="hljs-keyword">false</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> main(String[] args) <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        Thread consume = <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Consume(), <span class="hljs-string">&quot;Consume&quot;</span>);<br>        Thread produce = <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Produce(), <span class="hljs-string">&quot;Produce&quot;</span>);<br>        consume.start();<br>        Thread.sleep(<span class="hljs-number">1000</span>);<br>        produce.start();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            produce.<span class="hljs-keyword">join</span>();<br>            consume.<span class="hljs-keyword">join</span>();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 生产者线程</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> Produce <span class="hljs-keyword">implements</span> Runnable &#123;<br><br>        @Override<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> run() &#123;<br>            <span class="hljs-keyword">synchronized</span> (obj) &#123;<br>                System.out.<span class="hljs-keyword">println</span>(<span class="hljs-string">&quot;进入生产者线程&quot;</span>);<br>                System.out.<span class="hljs-keyword">println</span>(<span class="hljs-string">&quot;生产&quot;</span>);<br>                <span class="hljs-keyword">try</span> &#123;<br>                    TimeUnit.MILLISECONDS.sleep(<span class="hljs-number">2000</span>);  <span class="hljs-comment">//模拟生产过程</span><br>                    flag = <span class="hljs-keyword">true</span>;<br>                    obj.notify();  <span class="hljs-comment">//通知消费者</span><br>                    TimeUnit.MILLISECONDS.sleep(<span class="hljs-number">1000</span>);  <span class="hljs-comment">//模拟其他耗时操作</span><br>                    System.out.<span class="hljs-keyword">println</span>(<span class="hljs-string">&quot;退出生产者线程&quot;</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//消费者线程</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> Consume <span class="hljs-keyword">implements</span> Runnable &#123;<br><br>        @Override<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> run() &#123;<br>            <span class="hljs-keyword">synchronized</span> (obj) &#123;<br>                System.out.<span class="hljs-keyword">println</span>(<span class="hljs-string">&quot;进入消费者线程&quot;</span>);<br>                System.out.<span class="hljs-keyword">println</span>(<span class="hljs-string">&quot;wait flag 1:&quot;</span> + flag);<br>                <span class="hljs-keyword">while</span> (!flag) &#123;  <span class="hljs-comment">//判断条件是否满足，若不满足则等待</span><br>                    <span class="hljs-keyword">try</span> &#123;<br>                        System.out.<span class="hljs-keyword">println</span>(<span class="hljs-string">&quot;还没生产，进入等待&quot;</span>);<br>                        obj.wait();<br>                        System.out.<span class="hljs-keyword">println</span>(<span class="hljs-string">&quot;结束等待&quot;</span>);<br>                    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                        e.printStackTrace();<br>                    &#125;<br>                &#125;<br>                System.out.<span class="hljs-keyword">println</span>(<span class="hljs-string">&quot;wait flag 2:&quot;</span> + flag);<br>                System.out.<span class="hljs-keyword">println</span>(<span class="hljs-string">&quot;消费&quot;</span>);<br>                System.out.<span class="hljs-keyword">println</span>(<span class="hljs-string">&quot;退出消费者线程&quot;</span>);<br>            &#125;<br><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出结果为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">进入消费者线程<br><br><span class="hljs-built_in">wait</span> flag 1:<span class="hljs-literal">false</span><br><br>还没生产，进入等待<br><br>进入生产者线程<br><br>生产<br><br>退出生产者线程<br><br>结束等待<br><br><span class="hljs-built_in">wait</span> flag 2:<span class="hljs-literal">true</span><br><br>消费<br><br>退出消费者线程<br></code></pre></td></tr></table></figure>

<p>理解了输出结果的顺序，也就明白了wait&#x2F;notify的基本用法。有以下几点需要知道：</p>
<ol>
<li>在示例中没有体现但很重要的是，<strong>wait&#x2F;notify方法的调用必须处在该对象的锁（Monitor）中，也即，在调用这些方法时首先需要获得该对象的锁。</strong>否则会抛出IllegalMonitorStateException异常。</li>
<li>从输出结果来看，在生产者调用notify()后，消费者并没有立即被唤醒，而是等到生产者退出同步块后才唤醒执行。（这点其实也好理解，synchronized同步方法（块）同一时刻只允许一个线程在里面，生产者不退出，消费者也进不去）</li>
<li>注意，消费者被唤醒后是从wait()方法（被阻塞的地方）后面执行，而不是重新从同步块开始。</li>
</ol>
<p>这一节我们探讨wait&#x2F;notify与线程状态之间的关系。深入了解线程的生命周期。</p>
<p>由前面线程的状态转化图可知，当调用wait()方法后，线程会进入WAITING(等待状态)，后续被notify()后，并没有立即被执行，而是进入等待获取锁的阻塞队列。</p>
<p><img src="/../JUC_pic/39.png" srcset="/img/loading.gif" lazyload></p>
<p>对于每个对象来说，都有自己的等待队列和阻塞队列。以前面的生产者、消费者为例，我们拿obj对象作为对象锁，配合图示。内部流程如下</p>
<ol>
<li>当线程A（消费者）调用wait()方法后，线程A让出锁，自己进入等待状态，同时加入锁对象的等待队列。</li>
<li>线程B（生产者）获取锁后，调用notify方法通知锁对象的等待队列，使得线程A从等待队列进入阻塞队列。</li>
<li>线程A进入阻塞队列后，直至线程B释放锁后，线程A竞争得到锁继续从wait()方法后执行。</li>
</ol>
<h2 id="主线程和守护线程"><a href="#主线程和守护线程" class="headerlink" title="主线程和守护线程"></a>主线程和守护线程</h2><p>默认情况下，Java 进程需要等待所有线程都运行结束，才会结束。有一种特殊的线程叫做守护线程，只要其它非守 护线程运行结束了，即使守护线程的代码没有执行完，也会强制结束。</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs livescript">log.debug(<span class="hljs-string">&quot;开始运行...&quot;</span>);<br>	Thread t1 = <span class="hljs-keyword">new</span> Thread<span class="hljs-function"><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 		log.debug(<span class="hljs-string">&quot;开始运行...&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function"> 		sleep(<span class="hljs-number">2</span>);</span></span><br><span class="hljs-params"><span class="hljs-function"> 		log.debug(<span class="hljs-string">&quot;运行结束...&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function">	&#125;, <span class="hljs-string">&quot;daemon&quot;</span>)</span>;</span><br><span class="hljs-function">// 设置该线程为守护线程</span><br><span class="hljs-function"><span class="hljs-title">t1</span>.<span class="hljs-title">setDaemon</span><span class="hljs-params">(<span class="hljs-literal">true</span>)</span>;</span><br><span class="hljs-function"><span class="hljs-title">t1</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function"><span class="hljs-title">sleep</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span>;</span><br><span class="hljs-function"><span class="hljs-title">log</span>.<span class="hljs-title">debug</span><span class="hljs-params">(<span class="hljs-string">&quot;运行结束...&quot;</span>)</span>;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">08</span>:<span class="hljs-number">26</span>:<span class="hljs-number">38.123</span> <span class="hljs-selector-attr">[main]</span> c<span class="hljs-selector-class">.TestDaemon</span> - 开始运行... <br><span class="hljs-number">08</span>:<span class="hljs-number">26</span>:<span class="hljs-number">38.213</span> <span class="hljs-selector-attr">[daemon]</span> c<span class="hljs-selector-class">.TestDaemon</span> - 开始运行... <br><span class="hljs-number">08</span>:<span class="hljs-number">26</span>:<span class="hljs-number">39.215</span> <span class="hljs-selector-attr">[main]</span> c<span class="hljs-selector-class">.TestDaemon</span> - 运行结束... <br></code></pre></td></tr></table></figure>

<p>注意 </p>
<ul>
<li>垃圾回收器线程就是一种守护线程 </li>
<li>Tomcat 中的 Acceptor 和 Poller 线程都是守护线程，所以 Tomcat 接收到 shutdown 命令后，不会等 待它们处理完当前请求</li>
</ul>
<h2 id="线程的五种状态"><a href="#线程的五种状态" class="headerlink" title="线程的五种状态"></a>线程的五种状态</h2><p>这里的五种状态是从<strong>操作系统</strong>层面描述的</p>
<p><img src="/../JUC_pic/6.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>【初始状态】仅是在语言层面创建了线程对象，还未与操作系统线程关联 </li>
<li>【可运行状态】（就绪状态）指该线程已经被创建（与操作系统线程关联），可以由 CPU 调度执行 </li>
<li>【运行状态】指获取了 CPU 时间片运行中的状态 当 CPU 时间片用完，会从【运行状态】转换至【可运行状态】，会导致线程的上下文切换 </li>
<li>【阻塞状态】 如果调用了阻塞 API，如 BIO 读写文件，这时该线程实际不会用到 CPU，会导致线程上下文切换，进入【阻塞状态】 <ul>
<li>等 BIO 操作完毕，会由操作系统唤醒阻塞的线程，转换至【可运行状态】</li>
<li>与【可运行状态】的区别是，对【阻塞状态】的线程来说只要它们一直不唤醒，调度器就一直不会考虑 调度它们</li>
</ul>
</li>
<li>【终止状态】表示线程已经执行完毕，生命周期已经结束，不会再转换为其它状态</li>
</ul>
<h2 id="线程的六种状态"><a href="#线程的六种状态" class="headerlink" title="线程的六种状态"></a>线程的六种状态</h2><p>这里从<strong>Java API</strong>层面描述的</p>
<p>根据Thread.State，分为六种状态</p>
<p><img src="/../JUC_pic/7.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/../JUC_pic/38.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li><table>
<thead>
<tr>
<th>状态名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>NEW</td>
<td>初始状态，线程被构建，但未调用start()方法</td>
</tr>
<tr>
<td>RUNNABLE</td>
<td>运行状态，调用start()方法后。在java线程中，将操作系统线程的就绪和运行统称运行状态</td>
</tr>
<tr>
<td>BLOCKED</td>
<td>阻塞状态，线程等待进入synchronized代码块或方法中，等待获取锁</td>
</tr>
<tr>
<td>WAITING</td>
<td>等待状态，线程可调用wait、join等操作使自己陷入等待状态，并等待其他线程做出特定操作（如notify或中断）</td>
</tr>
<tr>
<td>TIMED_WAITING</td>
<td>超时等待，线程调用sleep(timeout)、wait(timeout)等操作进入超时等待状态，超时后自行返回</td>
</tr>
<tr>
<td>TERMINATED</td>
<td>终止状态，线程运行结束</td>
</tr>
</tbody></table>
</li>
</ul>
<h2 id="共享模型之管程"><a href="#共享模型之管程" class="headerlink" title="共享模型之管程"></a>共享模型之管程</h2><p>线程安全问题Java体现</p>
<p>两个线程对初始值为 0 的静态变量一个做自增，一个做自减，各做 5000 次，结果是 0 吗？</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs livescript"><span class="hljs-keyword">static</span> int counter = <span class="hljs-number">0</span>;<br>public <span class="hljs-keyword">static</span> <span class="hljs-literal">void</span> main(<span class="hljs-built_in">String</span>[] args) throws InterruptedException &#123;<br> 	Thread t1 = <span class="hljs-keyword">new</span> Thread<span class="hljs-function"><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 		<span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5000</span>; i++) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 			counter++;</span></span><br><span class="hljs-params"><span class="hljs-function"> 		&#125;</span></span><br><span class="hljs-params"><span class="hljs-function"> 		&#125;, <span class="hljs-string">&quot;t1&quot;</span>)</span>;</span><br><span class="hljs-function"> 	<span class="hljs-title">Thread</span> <span class="hljs-title">t2</span> = <span class="hljs-title">new</span> <span class="hljs-title">Thread</span><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">		 <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5000</span>; i++) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 			counter--;</span></span><br><span class="hljs-params"><span class="hljs-function"> 		 &#125;</span></span><br><span class="hljs-params"><span class="hljs-function"> 	&#125;, <span class="hljs-string">&quot;t2&quot;</span>)</span>;</span><br><span class="hljs-function"> 	<span class="hljs-title">t1</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function"> 	<span class="hljs-title">t2</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function"> 	<span class="hljs-title">t1</span>.<span class="hljs-title">join</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function"> 	<span class="hljs-title">t2</span>.<span class="hljs-title">join</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function"> 	<span class="hljs-title">log</span>.<span class="hljs-title">debug</span><span class="hljs-params">(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>,counter)</span>;</span><br><span class="hljs-function">&#125;</span><br></code></pre></td></tr></table></figure>

<p>问题分析</p>
<p>以上的结果可能是正数、负数、零。为什么呢？因为 Java 中对静态变量的自增，自减并不是原子操作，要彻底理 解，必须从字节码来进行分析</p>
<p>例如对于 i++ 而言（i 为静态变量），实际会产生如下的 JVM 字节码指令：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">getstatic i <span class="hljs-regexp">//</span> 获取静态变量i的值<br>iconst_1 <span class="hljs-regexp">//</span> 准备常量<span class="hljs-number">1</span><br>iadd <span class="hljs-regexp">//</span> 自增<br>putstatic i <span class="hljs-regexp">//</span> 将修改后的值存入静态变量i<br></code></pre></td></tr></table></figure>

<p>而对应 i– 也是类似：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">getstatic i <span class="hljs-regexp">//</span> 获取静态变量i的值<br>iconst_1 <span class="hljs-regexp">//</span> 准备常量<span class="hljs-number">1</span><br>isub <span class="hljs-regexp">//</span> 自减<br>putstatic i <span class="hljs-regexp">//</span> 将修改后的值存入静态变量i<br><br></code></pre></td></tr></table></figure>

<p><img src="/../JUC_pic/8.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/../JUC_pic/9.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="临界区-Critical-Section"><a href="#临界区-Critical-Section" class="headerlink" title="临界区 Critical Section"></a>临界区 Critical Section</h3><ul>
<li>一个程序运行多个线程本身是没有问题的 </li>
<li>问题出在多个线程访问<strong>共享资源</strong> <ul>
<li>多个线程读<strong>共享资源</strong>其实也没有问题 </li>
<li>在多个线程对<strong>共享资源</strong>读写操作时发生指令交错，就会出现问题</li>
</ul>
</li>
<li>一段代码块内如果存在对<strong>共享资源</strong>的多线程读写操作，称这段代码块为<strong>临界区</strong></li>
</ul>
<p>例如，下面代码中的临界区</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> counter = <span class="hljs-number">0</span>;<br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">increment</span>() </span><br><span class="hljs-function"><span class="hljs-comment">// 临界区</span></span><br>&#123; <br> counter++;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">decrement</span>() </span><br><span class="hljs-function"><span class="hljs-comment">// 临界区</span></span><br>&#123; <br> counter--;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>解决办法一：加synchronized锁对临界区进行保护</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs livescript">public <span class="hljs-keyword">static</span> final <span class="hljs-built_in">Object</span> lock =<span class="hljs-keyword">new</span> <span class="hljs-built_in">Object</span>();<br>    <span class="hljs-keyword">static</span> int counter = <span class="hljs-number">0</span>;<br>    public <span class="hljs-keyword">static</span> <span class="hljs-literal">void</span> main(<span class="hljs-built_in">String</span>[] args) throws InterruptedException &#123;<br>        Thread t1 = <span class="hljs-keyword">new</span> Thread<span class="hljs-function"><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">                <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5000</span>; i++) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">                    synchronized (lock)&#123;</span></span><br><span class="hljs-params"><span class="hljs-function">                        counter++;</span></span><br><span class="hljs-params"><span class="hljs-function">                    &#125;</span></span><br><span class="hljs-params"><span class="hljs-function">                &#125;</span></span><br><span class="hljs-params"><span class="hljs-function">        &#125;, <span class="hljs-string">&quot;t1&quot;</span>)</span>;</span><br><span class="hljs-function">        <span class="hljs-title">Thread</span> <span class="hljs-title">t2</span> = <span class="hljs-title">new</span> <span class="hljs-title">Thread</span><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">                <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5000</span>; i++) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">                    synchronized (lock)&#123;</span></span><br><span class="hljs-params"><span class="hljs-function">                        counter--;</span></span><br><span class="hljs-params"><span class="hljs-function">                    &#125;</span></span><br><span class="hljs-params"><span class="hljs-function">                &#125;</span></span><br><span class="hljs-params"><span class="hljs-function">        &#125;, <span class="hljs-string">&quot;t2&quot;</span>)</span>;</span><br><span class="hljs-function">        <span class="hljs-title">t1</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">        <span class="hljs-title">t2</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">        <span class="hljs-title">t1</span>.<span class="hljs-title">join</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">        <span class="hljs-title">t2</span>.<span class="hljs-title">join</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">        <span class="hljs-title">log</span>.<span class="hljs-title">debug</span><span class="hljs-params">(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>,counter)</span>;</span><br><span class="hljs-function">    &#125;</span><br></code></pre></td></tr></table></figure>

<p>你可以做这样的类比：</p>
<ul>
<li>synchronized(对象) 中的对象，可以想象为一个房间（room），有唯一入口（门）房间只能一次进入一人 进行计算，线程 t1，t2 想象成两个人</li>
<li>当线程 t1 执行到 synchronized(room) 时就好比 t1 进入了这个房间，并锁住了门拿走了钥匙，在门内执行 count++ 代码</li>
<li>这时候如果 t2 也运行到了 synchronized(room) 时，它发现门被锁住了，只能在门外等待，发生了上下文切 换，阻塞住了</li>
<li>这中间即使 t1 的 cpu 时间片不幸用完，被踢出了门外（不要错误理解为锁住了对象就能一直执行下去哦）， 这时门还是锁住的，t1 仍拿着钥匙，t2 线程还在阻塞状态进不来，只有下次轮到 t1 自己再次获得时间片时才 能开门进入</li>
<li>当 t1 执行完 synchronized{} 块内的代码，这时候才会从 obj 房间出来并解开门上的锁，唤醒 t2 线程把钥 匙给他。t2 线程这时才可以进入 obj 房间，锁住了门拿上钥匙，执行它的 count– 代码</li>
</ul>
<p><strong>synchronized 实际是用对象锁保证了临界区内代码的原子性，临界区内的代码对外是不可分割的，不会被线程切换 所打断。</strong>确保了一个操作的原子性。</p>
<h3 id="方法上的-synchronized"><a href="#方法上的-synchronized" class="headerlink" title="方法上的 synchronized"></a>方法上的 synchronized</h3><p>一：加在普通方法上</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span>&#123;<br> <span class="hljs-keyword">public</span> synchronized <span class="hljs-built_in">void</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>) &#123;<br> <br> &#125;<br>&#125;<br>等价于<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span>&#123;<br> 	<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>) &#123;<br> 		<span class="hljs-title function_">synchronized</span>(<span class="hljs-params"><span class="hljs-variable language_">this</span></span>) &#123;<br> <br> 		&#125;<br> 	&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>相当于锁住this对象</p>
<p>二：加在静态方法上</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span>&#123;<br> 	<span class="hljs-keyword">public</span> synchronized <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>) &#123;<br> 	<br> 	&#125;<br>&#125;<br>等价于<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span>&#123;<br> 	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>) &#123;<br> 		<span class="hljs-title function_">synchronized</span>(<span class="hljs-params">Test.<span class="hljs-keyword">class</span></span>) &#123;<br> <br> 		&#125;<br> 	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>加在静态方法上相当于锁住类对象。</p>
<h2 id="变量的线程安全分析"><a href="#变量的线程安全分析" class="headerlink" title="变量的线程安全分析"></a>变量的线程安全分析</h2><h3 id="成员变量和静态变量是否线程安全？"><a href="#成员变量和静态变量是否线程安全？" class="headerlink" title="成员变量和静态变量是否线程安全？"></a>成员变量和静态变量是否线程安全？</h3><ul>
<li>如果它们没有共享，则线程安全</li>
<li>如果它们被共享了，根据它们的状态是否能够改变，又分两种情况<ul>
<li>如果只有读操作，则线程安全</li>
<li>如果有读写操作，则这段代码是临界区，需要考虑线程安全</li>
</ul>
</li>
</ul>
<h3 id="局部变量是否线程安全"><a href="#局部变量是否线程安全" class="headerlink" title="局部变量是否线程安全"></a>局部变量是否线程安全</h3><ul>
<li>局部变量是线程安全的</li>
<li>但局部变量引用的对象未必<ul>
<li>如果该对象没有逃离方法的作用访问，它是线程安全的</li>
<li>如果该对象逃离方法的作用范围，需要考虑线程安全</li>
</ul>
</li>
</ul>
<h3 id="局部变量线程安全分析"><a href="#局部变量线程安全分析" class="headerlink" title="局部变量线程安全分析"></a>局部变量线程安全分析</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs csharp">这里的<span class="hljs-keyword">static</span>是加在方法上，test1()是一个静态方法，i还是局部变量<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test1</span>()</span> &#123;<br> 	<span class="hljs-built_in">int</span> i = <span class="hljs-number">10</span>;<br> 	i++;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>每个线程调用 test1() 方法时局部变量 i，会在每个线程的栈帧内存中被创建多份，因此不存在共享</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">public</span> static void test1();<br> <span class="hljs-attribute">descriptor</span>: ()V<br> <span class="hljs-attribute">flags</span>: ACC_PUBLIC, ACC_STATIC<br> <span class="hljs-attribute">Code</span>:<br> <span class="hljs-attribute">stack</span>=<span class="hljs-number">1</span>, locals=<span class="hljs-number">1</span>, args_size=<span class="hljs-number">0</span><br> <span class="hljs-attribute">0</span>: bipush <span class="hljs-number">10</span><br> <span class="hljs-attribute">2</span>: istore_0<br> <span class="hljs-attribute">3</span>: iinc <span class="hljs-number">0</span>, <span class="hljs-number">1</span><br> <span class="hljs-attribute">6</span>: return<br> <span class="hljs-attribute">LineNumberTable</span>:<br> <span class="hljs-attribute">line</span> <span class="hljs-number">10</span>: <span class="hljs-number">0</span><br> <span class="hljs-attribute">line</span> <span class="hljs-number">11</span>: <span class="hljs-number">3</span><br> <span class="hljs-attribute">line</span> <span class="hljs-number">12</span>: <span class="hljs-number">6</span><br> <span class="hljs-attribute">LocalVariableTable</span>:<br> <span class="hljs-attribute">Start</span> Length Slot Name Signature<br> <span class="hljs-attribute">3</span> <span class="hljs-number">4</span> <span class="hljs-number">0</span> i I<br></code></pre></td></tr></table></figure>

<p><img src="/../JUC_pic/12.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="局部变量的引用"><a href="#局部变量的引用" class="headerlink" title="局部变量的引用"></a>局部变量的引用</h3><p>在类里，方法外的变量的成员变量。方法里的叫局部变量。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadUnsafe</span> &#123;<br>	<span class="hljs-comment">//这里的list是成员变量</span><br> 	ArrayList&lt;String&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br> 	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">method1</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> loopNumber</span>)</span> &#123;<br> 		<span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; loopNumber; i++) &#123;<br> 			<span class="hljs-comment">// &#123; 临界区, 会产生竞态条件</span><br> 			method2();<br> 			method3();<br>  			<span class="hljs-comment">// &#125; 临界区</span><br> 		&#125;<br> 	&#125;<br> 	<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">method2</span>()</span> &#123;<br> 		list.<span class="hljs-keyword">add</span>(<span class="hljs-string">&quot;1&quot;</span>);<br> 	&#125;<br> 	<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">method3</span>()</span> &#123;<br> 		list.<span class="hljs-keyword">remove</span>(<span class="hljs-number">0</span>);<br> 	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>执行</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> THREAD_NUMBER = <span class="hljs-number">2</span>;<br><span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> LOOP_NUMBER = <span class="hljs-number">200</span>;<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span> </span>&#123;<br> 	ThreadUnsafe test = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ThreadUnsafe</span>();<br> 	<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; THREAD_NUMBER; i++) &#123;<br> 		<span class="hljs-keyword">new</span> <span class="hljs-built_in">Thread</span>(() -&gt; &#123;<br> 			test.<span class="hljs-built_in">method1</span>(LOOP_NUMBER);<br> 		&#125;, <span class="hljs-string">&quot;Thread&quot;</span> + i).<span class="hljs-built_in">start</span>();<br> 	&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>其中一种情况是，如果线程2 还未 add，线程1 remove 就会报错：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs stylus">Exception <span class="hljs-keyword">in</span> thread <span class="hljs-string">&quot;Thread1&quot;</span> java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.IndexOutOfBoundsException</span>: Index: <span class="hljs-number">0</span>, Size: <span class="hljs-number">0</span> <br> at java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.ArrayList</span><span class="hljs-selector-class">.rangeCheck</span>(ArrayList<span class="hljs-selector-class">.java</span>:<span class="hljs-number">657</span>) <br> at java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.ArrayList</span><span class="hljs-selector-class">.remove</span>(ArrayList<span class="hljs-selector-class">.java</span>:<span class="hljs-number">496</span>) <br> at cn<span class="hljs-selector-class">.itcast</span><span class="hljs-selector-class">.n6</span><span class="hljs-selector-class">.ThreadUnsafe</span><span class="hljs-selector-class">.method3</span>(TestThreadSafe<span class="hljs-selector-class">.java</span>:<span class="hljs-number">35</span>) <br> at cn<span class="hljs-selector-class">.itcast</span><span class="hljs-selector-class">.n6</span><span class="hljs-selector-class">.ThreadUnsafe</span><span class="hljs-selector-class">.method1</span>(TestThreadSafe<span class="hljs-selector-class">.java</span>:<span class="hljs-number">26</span>) <br> at cn<span class="hljs-selector-class">.itcast</span><span class="hljs-selector-class">.n6</span><span class="hljs-selector-class">.TestThreadSafe</span>.lambda<span class="hljs-variable">$main</span>$<span class="hljs-number">0</span>(TestThreadSafe<span class="hljs-selector-class">.java</span>:<span class="hljs-number">14</span>) <br> at java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.Thread</span><span class="hljs-selector-class">.run</span>(Thread<span class="hljs-selector-class">.java</span>:<span class="hljs-number">748</span>) <br></code></pre></td></tr></table></figure>

<p>分析：</p>
<ul>
<li>无论哪个线程中的 method2 引用的都是同一个对象中的 list 成员变量 </li>
<li>method3 与 method2 分析相同</li>
</ul>
<p><img src="/../JUC_pic/13.png" srcset="/img/loading.gif" lazyload></p>
<p>解决办法：将list修改为局部变量</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadSafe</span> &#123;<br> 	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">void</span> <span class="hljs-title">method1</span><span class="hljs-params">(<span class="hljs-type">int</span> loopNumber)</span> </span>&#123;<br> 		<span class="hljs-comment">//这里的list就是局部变量</span><br> 		ArrayList&lt;<span class="hljs-type">String</span>&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br> 		<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; loopNumber; i++) &#123;<br> 			<span class="hljs-built_in">method2</span>(list);<br> 			<span class="hljs-built_in">method3</span>(list);<br> 		&#125;<br> 	&#125;<br> <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-type">void</span> <span class="hljs-title">method2</span><span class="hljs-params">(ArrayList&lt;<span class="hljs-type">String</span>&gt; list)</span> </span>&#123;<br> 	list.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;1&quot;</span>);<br> &#125;<br> <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-type">void</span> <span class="hljs-title">method3</span><span class="hljs-params">(ArrayList&lt;<span class="hljs-type">String</span>&gt; list)</span> </span>&#123;<br> 	list.<span class="hljs-built_in">remove</span>(<span class="hljs-number">0</span>);<br> &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>分析：</p>
<ul>
<li>list 是局部变量，每个线程调用时会创建其不同实例，没有共享 </li>
<li>而 method2 的参数是从 method1 中传递过来的，与 method1 中引用同一个对象 </li>
<li>method3 的参数分析与 method2 相同</li>
</ul>
<p><img src="/../JUC_pic/14.png" srcset="/img/loading.gif" lazyload></p>
<p>方法访问修饰符带来的思考，如果把 method2 和 method3 的方法修改为 public 会不会代理线程安全问题？</p>
<ul>
<li>情况1：有其它线程调用 method2 和 method3</li>
</ul>
<p>不会，因为method2 和 method3传进来的参数list只能是线程自己的。</p>
<ul>
<li>情况2：在 情况1 的基础上，为 ThreadSafe 类添加子类，子类覆盖 method2 或 method3 方法，即</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadSafe</span> &#123;<br> 	<span class="hljs-keyword">public</span> final <span class="hljs-built_in">void</span> <span class="hljs-title function_">method1</span>(<span class="hljs-params">int loopNumber</span>) &#123;<br> 		<span class="hljs-title class_">ArrayList</span>&lt;<span class="hljs-title class_">String</span>&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br> 		<span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; loopNumber; i++) &#123;<br> 			<span class="hljs-title function_">method2</span>(list);<br> 			<span class="hljs-title function_">method3</span>(list);<br> 		&#125;<br> 	&#125;<br> <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">method2</span>(<span class="hljs-params">ArrayList&lt;<span class="hljs-built_in">String</span>&gt; list</span>) &#123;<br> 	list.<span class="hljs-title function_">add</span>(<span class="hljs-string">&quot;1&quot;</span>);<br> &#125;<br> <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">method3</span>(<span class="hljs-params">ArrayList&lt;<span class="hljs-built_in">String</span>&gt; list</span>) &#123;<br> 	list.<span class="hljs-title function_">remove</span>(<span class="hljs-number">0</span>);<br> 	&#125;<br>&#125;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadSafeSubClass</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">ThreadSafe</span>&#123;<br> 	<span class="hljs-meta">@Override</span><br> 	<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">method3</span>(<span class="hljs-params">ArrayList&lt;<span class="hljs-built_in">String</span>&gt; list</span>) &#123;<br> 	<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br> 		list.<span class="hljs-title function_">remove</span>(<span class="hljs-number">0</span>);<br> 	&#125;).<span class="hljs-title function_">start</span>();<br> 	&#125;<br>&#125;<br>被子类继承的话，那么子类可以另外开启一个线程进行相应操作，可能会出现线程安全问题。所以做好开闭原则中的闭。<br></code></pre></td></tr></table></figure>

<p><strong>从这个例子可以看出 private 或 final 提供【安全】的意义所在，请体会开闭原则中的【闭】</strong>加上private 或 final 不然子类继承</p>
<h2 id="常见的线程安全类"><a href="#常见的线程安全类" class="headerlink" title="常见的线程安全类"></a>常见的线程安全类</h2><ul>
<li>String</li>
<li>Integer</li>
<li>StringBuffer</li>
<li>Random</li>
<li>Vector</li>
<li>Hashtable(线程安全的Map实现)</li>
<li>java.util.concurrent 包下的类</li>
</ul>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs livescript">Hashtable table = <span class="hljs-keyword">new</span> Hashtable();<br><br><span class="hljs-keyword">new</span> Thread<span class="hljs-function"><span class="hljs-params">(()-&gt;&#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 	table.put(<span class="hljs-string">&quot;key&quot;</span>, <span class="hljs-string">&quot;value1&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function">&#125;)</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-title">new</span> <span class="hljs-title">Thread</span><span class="hljs-params">(()-&gt;&#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 	table.put(<span class="hljs-string">&quot;key&quot;</span>, <span class="hljs-string">&quot;value2&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function">&#125;)</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function"></span><br><span class="hljs-function">打开<span class="hljs-title">Put</span>源码</span><br><span class="hljs-function">	<span class="hljs-title">public</span> <span class="hljs-title">synchronized</span> <span class="hljs-title">V</span> <span class="hljs-title">put</span><span class="hljs-params">(K key, V value)</span> &#123;</span><br><span class="hljs-function">        // <span class="hljs-title">Make</span> <span class="hljs-title">sure</span> <span class="hljs-title">the</span> <span class="hljs-title">value</span> <span class="hljs-title">is</span> <span class="hljs-title">not</span> <span class="hljs-title">null</span></span><br><span class="hljs-function">        <span class="hljs-title">if</span> <span class="hljs-params">(value == <span class="hljs-literal">null</span>)</span> &#123;</span><br><span class="hljs-function">            <span class="hljs-title">throw</span> <span class="hljs-title">new</span> <span class="hljs-title">NullPointerException</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">        &#125;</span><br><span class="hljs-function">可见<span class="hljs-title">synchronized</span></span><br></code></pre></td></tr></table></figure>

<p>ctrl+N查找类。</p>
<p>ctrl+F12查找类中的方法。</p>
<ul>
<li>它们的每个方法是原子的 </li>
<li>但注意它们多个方法的组合不是原子的，</li>
</ul>
<h3 id="线程安全类方法的组合"><a href="#线程安全类方法的组合" class="headerlink" title="线程安全类方法的组合"></a>线程安全类方法的组合</h3><p>分析下面代码是否线程安全？</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">Hashtable table = <span class="hljs-built_in">new</span> Hashtable();<br>// 线程<span class="hljs-number">1</span>，线程<span class="hljs-number">2</span><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">table</span>.<span class="hljs-keyword">get</span>(&quot;key&quot;) == <span class="hljs-keyword">null</span>) &#123;<br> 	<span class="hljs-keyword">table</span>.put(&quot;key&quot;, <span class="hljs-keyword">value</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/../JUC_pic/15.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="不可变类线程安全性"><a href="#不可变类线程安全性" class="headerlink" title="不可变类线程安全性"></a>不可变类线程安全性</h3><p>String、Integer 等都是不可变类，因为其内部的状态不可以改变，因此它们的方法都是线程安全的 有同学或许有疑问，String 有 replace，substring 等方法【可以】改变值啊，那么这些方法又是如何保证线程安 全的呢？</p>
<p>比如substring(),其实没有修改，而是创建了一个新的String对象</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs abnf">String s <span class="hljs-operator">=</span> <span class="hljs-string">&quot;123&quot;</span><span class="hljs-comment">;</span><br><span class="hljs-attribute">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;456&quot;</span><span class="hljs-comment">;</span><br>编译可以通过，看上去好像改变了字符串的值，实际上是创建了新的对象，可以使用hashcode()得出结论。<br></code></pre></td></tr></table></figure>

<h3 id="不可变性的好处"><a href="#不可变性的好处" class="headerlink" title="不可变性的好处"></a>不可变性的好处</h3><p>String类的不可变性带来的好处总结主要有两点：</p>
<ul>
<li><p>因为String类的不可变性，才能使得JVM可以实现字符串常量池；字符串常量池可以在程序运行时节约很多内存空间，因为不同的字符串变量指向相同的字面量时，都是指向字符串常量池中的同一个对象。这样一方面能够节约内存，另一方面也提升了性能。</p>
</li>
<li><p>因为String类的不可变性，从而保证了字符串对象在多线程环境下是线程安全的。如果String类是可变的，那么会引起很严重的安全问题。我们在很多情况下都是直接通过字符串传递数据，比如数据库的用户名密码、网络编程中的ip和端口，因为字符串是不可变的，所以它的值不能被修改，如果字符串是可变的，那么可以通过改变引用地址指向的值去修改字符串的值，从而导致安全漏洞。</p>
</li>
<li><p>同时也非常适合作为HashMap的key，因为HashMap的工作原理是hashcode，如果String作为key可变，那么hashcode会发送改变，那么就找不到之前存储的数据了。</p>
</li>
</ul>
<h2 id="Monitor概念"><a href="#Monitor概念" class="headerlink" title="Monitor概念"></a>Monitor概念</h2><p>一个对象主要由两部分组成：Java对象头+成员变量</p>
<h3 id="Java对象头"><a href="#Java对象头" class="headerlink" title="Java对象头"></a>Java对象头</h3><p>以32位虚拟机为例：</p>
<p><strong>普通对象</strong></p>
<p><img src="/../JUC_pic/16.png" srcset="/img/loading.gif" lazyload></p>
<p>一个类是什么对象靠的就是Klass Word(是一个指针)，通过Klass Word找到对象的类型。</p>
<p><strong>数组对象</strong></p>
<p><img src="/../JUC_pic/17.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>其中Mark Word结构为</strong></p>
<p><img src="/../JUC_pic/18.png" srcset="/img/loading.gif" lazyload></p>
<p>其中先看Normal,hashcode懂得都懂，age是JVM中新生代到老年代晋升的那个年龄，biased_lock是偏向锁(后面学习)，01是加锁状态。</p>
<p><strong>64位虚拟机</strong></p>
<p><img src="/../JUC_pic/19.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="synchronized"><a href="#synchronized" class="headerlink" title="synchronized"></a>synchronized</h2><h3 id="synchronized-底层原理-Monitor"><a href="#synchronized-底层原理-Monitor" class="headerlink" title="synchronized 底层原理(Monitor)"></a>synchronized 底层原理(Monitor)</h3><p>Monitor 被翻译为<strong>监视器</strong>或<strong>管程</strong></p>
<p>每个 Java 对象都可以关联一个 Monitor 对象，如果使用 synchronized 给对象上锁（重量级）之后，该对象头的 Mark Word 中就被设置指向 Monitor 对象的指针</p>
<p><img src="/../JUC_pic/20.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>刚开始 Monitor 中 Owner 为 null</li>
<li>当 Thread-2 执行 synchronized(obj) 就会将 Monitor 的所有者 Owner 置为 Thread-2，Monitor中只能有一 个 Owner</li>
<li>在 Thread-2 上锁的过程中，如果 Thread-3，Thread-4，Thread-5 也来执行 synchronized(obj)，就会进入 EntryList BLOCKED</li>
<li>Thread-2 执行完同步代码块的内容，然后唤醒 EntryList 中等待的线程来竞争锁，竞争的时是非公平的</li>
<li>图中 WaitSet 中的 Thread-0，Thread-1 是之前获得过锁，但条件不满足进入 WAITING 状态的线程，后面讲 wait-notify 时会分析</li>
</ul>
<h3 id="synchronized-底层原理字节码分析"><a href="#synchronized-底层原理字节码分析" class="headerlink" title="synchronized 底层原理字节码分析"></a>synchronized 底层原理字节码分析</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br><span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">counter</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br> 	<span class="hljs-keyword">synchronized</span> (lock) &#123;<br> 		counter++;<br> 	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs awk">public static void main(java.lang.String[]);<br> 	descriptor: ([Ljava<span class="hljs-regexp">/lang/</span>String;)V<br> 	flags: ACC_PUBLIC, ACC_STATIC<br>  	Code:<br> 		stack=<span class="hljs-number">2</span>, locals=<span class="hljs-number">3</span>, args_size=<span class="hljs-number">1</span><br> 			<span class="hljs-number">0</span>: getstatic <span class="hljs-comment">#2 // &lt;- lock引用 （synchronized开始）</span><br> 			<span class="hljs-number">3</span>: dup<br> 			<span class="hljs-number">4</span>: astore_1 <span class="hljs-regexp">//</span> lock引用 -&gt; slot <span class="hljs-number">1</span><br> 			<span class="hljs-number">5</span>: monitorenter <span class="hljs-regexp">//</span> 将 lock对象 MarkWord 置为 Monitor 指针<br> 			<span class="hljs-number">6</span>: getstatic <span class="hljs-comment">#3 // &lt;- i</span><br> 			<span class="hljs-number">9</span>: iconst_1 <span class="hljs-regexp">//</span> 准备常数 <span class="hljs-number">1</span><br> 			<span class="hljs-number">10</span>: iadd <span class="hljs-regexp">//</span> +<span class="hljs-number">1</span><br> 			<span class="hljs-number">11</span>: putstatic <span class="hljs-comment">#3 // -&gt; i</span><br> 			<span class="hljs-number">14</span>: aload_1 <span class="hljs-regexp">//</span> &lt;- lock引用<br> 			<span class="hljs-number">15</span>: monitorexit <span class="hljs-regexp">//</span> 将 lock对象 MarkWord 重置, 唤醒 EntryList<br> 			<span class="hljs-number">16</span>: goto <span class="hljs-number">24</span><br> 			<span class="hljs-number">19</span>: astore_2 <span class="hljs-regexp">//</span> e -&gt; slot <span class="hljs-number">2</span> <br> 			<span class="hljs-number">20</span>: aload_1 <span class="hljs-regexp">//</span> &lt;- lock引用<br> 			<span class="hljs-number">21</span>: monitorexit <span class="hljs-regexp">//</span> 将 lock对象 MarkWord 重置, 唤醒 EntryList<br> 			<span class="hljs-number">22</span>: aload_2 <span class="hljs-regexp">//</span> &lt;- slot <span class="hljs-number">2</span> (e)<br> 			<span class="hljs-number">23</span>: athrow <span class="hljs-regexp">//</span> throw e<br> 			<span class="hljs-number">24</span>: return<br> 		Exception table:<br> 			from to target type<br> 			<span class="hljs-number">6</span>    <span class="hljs-number">16</span> <span class="hljs-number">19</span>     any<br> 			<span class="hljs-number">19</span>   <span class="hljs-number">22</span> <span class="hljs-number">19</span>     any<br> 		LineNumberTable:<br> 			line <span class="hljs-number">8</span>: <span class="hljs-number">0</span><br> 			line <span class="hljs-number">9</span>: <span class="hljs-number">6</span><br> 			line <span class="hljs-number">10</span>: <span class="hljs-number">14</span><br> 			line <span class="hljs-number">11</span>: <span class="hljs-number">24</span><br> 		LocalVariableTable:<br> 		Start Length Slot Name Signature<br> 		 <span class="hljs-number">0</span>     <span class="hljs-number">25</span>      <span class="hljs-number">0</span>   args [Ljava<span class="hljs-regexp">/lang/</span>String;<br> 		StackMapTable: number_of_entries = <span class="hljs-number">2</span><br> 			frame_type = <span class="hljs-number">255</span> <span class="hljs-regexp">/* full_frame */</span><br> 			offset_delta = <span class="hljs-number">19</span><br> 			locals = [ class <span class="hljs-string">&quot;[Ljava/lang/String;&quot;</span>, class java<span class="hljs-regexp">/lang/</span>Object ]<br> 			stack = [ class java<span class="hljs-regexp">/lang/</span>Throwable ]<br> 			frame_type = <span class="hljs-number">250</span> <span class="hljs-regexp">/* chop */</span><br> 			offset_delta = <span class="hljs-number">4</span><br></code></pre></td></tr></table></figure>

<p><strong>总结</strong></p>
<p><code>synchronized</code> 同步语句块的实现使用的是 <code>monitorenter</code> 和 <code>monitorexit</code> 指令，其中 <code>monitorenter</code> 指令指向同步代码块的开始位置，<code>monitorexit</code> 指令则指明同步代码块的结束位置。</p>
<p><code>synchronized</code> 修饰的方法并没有 <code>monitorenter</code> 指令和 <code>monitorexit</code> 指令，取得代之的确实是 <code>ACC_SYNCHRONIZED</code> 标识，该标识指明了该方法是一个同步方法。</p>
<p>不过两者的本质都是对对象监视器 monitor 的获取。(Monitor是由操作系统提供的)。</p>
<h3 id="synchronized升级之小故事"><a href="#synchronized升级之小故事" class="headerlink" title="synchronized升级之小故事"></a>synchronized升级之小故事</h3><p>故事角色 </p>
<ul>
<li><p>老王 - JVM </p>
</li>
<li><p>小南 - 线程 </p>
</li>
<li><p>小女 - 线程 </p>
</li>
<li><p>房间 - 对象 </p>
</li>
<li><p>房间门上 - 防盗锁 - Monitor </p>
</li>
<li><p>房间门上 - 小南书包 - 轻量级锁 </p>
</li>
<li><p>房间门上 - 刻上小南大名 - 偏向锁 </p>
</li>
<li><p>批量重刻名 - 一个类的偏向锁撤销到达 20 阈值 </p>
</li>
<li><p>不能刻名字 - 批量撤销该类对象的偏向锁，设置该类不可偏向 </p>
<p>小南要使用房间保证计算不被其它人干扰（原子性），最初，他用的是防盗锁，当上下文切换时，锁住门。这样， 即使他离开了，别人也进不了门，他的工作就是安全的。</p>
<p>但是，很多情况下没人跟他来竞争房间的使用权。小女是要用房间，但使用的时间上是错开的，小南白天用，小女 晚上用。每次上锁太麻烦了，有没有更简单的办法呢？ </p>
<p>小南和小女商量了一下，约定不锁门了，而是谁用房间，谁把自己的书包挂在门口，但他们的书包样式都一样，因 此每次进门前得翻翻书包(查看对象头的线程ID)，看课本是谁的，如果是自己的，那么就可以进门，这样省的上锁解锁了。万一书包不是 自己的，那么就在门外等，并通知对方下次用锁门的方式(因为有了竞争，所以升级为重量级锁)。 </p>
<p>后来，小女回老家了，很长一段时间都不会用这个房间。小南每次还是挂书包，翻书包，虽然比锁门省事了，但仍 然觉得麻烦。 </p>
<p>于是，小南干脆在门上刻上了自己的名字：【小南专属房间，其它人勿用】，下次来用房间时，只要名字还在，那 么说明没人打扰，还是可以安全地使用房间。如果这期间有其它人要用这个房间，那么由使用者将小南刻的名字擦 掉，升级为挂书包的方式。</p>
<p> 同学们都放假回老家了，小南就膨胀了，在 20 个房间刻上了自己的名字，想进哪个进哪个。后来他自己放假回老 家了，这时小女回来了（她也要用这些房间），结果就是得一个个地擦掉小南刻的名字，升级为挂书包的方式。老 王觉得这成本有点高，提出了一种批量重刻名的方法，他让小女不用挂书包了，可以直接在门上刻上自己的名字 </p>
<p>后来，刻名的现象越来越频繁，老王受不了了：算了，这些房间都不能刻名了，只能挂书包</p>
</li>
</ul>
<h3 id="轻量级锁"><a href="#轻量级锁" class="headerlink" title="轻量级锁"></a>轻量级锁</h3><p>轻量级锁的使用场景：如果一个对象虽然有多线程要加锁，但加锁的时间是错开的（也就是没有竞争），那么可以 使用轻量级锁来优化。 轻量级锁对使用者是透明的，即语法仍然是 synchronized </p>
<p>假设有两个方法同步块，利用同一个对象加锁</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">static</span> final <span class="hljs-title class_">Object</span> obj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">method1</span>(<span class="hljs-params"></span>) &#123;<br> 	<span class="hljs-title function_">synchronized</span>(<span class="hljs-params"> obj </span>) &#123;<br> 		<span class="hljs-comment">// 同步块 A</span><br> 		<span class="hljs-title function_">method2</span>();<br> 	&#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">method2</span>(<span class="hljs-params"></span>) &#123;<br> 	<span class="hljs-title function_">synchronized</span>(<span class="hljs-params"> obj </span>) &#123;<br> 		<span class="hljs-comment">// 同步块 B</span><br> 	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>创建锁记录（Lock Record）对象，每个线程都的每个栈帧都会包含一个锁记录的结构，内部可以存储锁定对象的 Mark Word</li>
</ul>
<p><img src="/../JUC_pic/21.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>让锁记录中 Object reference 指向锁对象，并尝试用 cas 替换 Object 的 Mark Word，将对象的 Mark Word 的值存 入锁记录</li>
</ul>
<p><img src="/../JUC_pic/22.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>如果 cas 替换成功，对象头中存储了 锁记录地址和状态 00 ，表示由该线程给对象加锁，这时图示如下</li>
</ul>
<p><img src="/../JUC_pic/23.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li><p>如果 cas 失败，有两种情况 </p>
<ul>
<li><p>如果是其它线程已经持有了该 Object 的轻量级锁，这时表明有竞争，进入锁膨胀过程 </p>
</li>
<li><p>如果是自己执行了 synchronized 锁重入，那么再添加一条 Lock Record 作为重入的计数</p>
</li>
</ul>
</li>
</ul>
<p><img src="/../JUC_pic/24.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>当退出 synchronized 代码块（解锁时）如果有取值为 null 的锁记录，表示有重入，这时重置锁记录，表示重 入计数减一</li>
</ul>
<p><img src="/../JUC_pic/25.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>当退出 synchronized 代码块（解锁时）锁记录的值不为 null，这时使用 cas 将 Mark Word 的值恢复给对象 头 <ul>
<li>成功，则解锁成功 </li>
<li>失败，说明轻量级锁进行了锁膨胀或已经升级为重量级锁，进入重量级锁解锁流程</li>
</ul>
</li>
</ul>
<h3 id="锁膨胀"><a href="#锁膨胀" class="headerlink" title="锁膨胀"></a>锁膨胀</h3><p>如果在尝试加轻量级锁的过程中，CAS 操作无法成功，这时一种情况就是有其它线程为此对象加上了轻量级锁（有 竞争），这时需要进行锁膨胀，将轻量级锁变为重量级锁。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">static</span> <span class="hljs-title class_">Object</span> obj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">method1</span>(<span class="hljs-params"></span>) &#123;<br> 	<span class="hljs-title function_">synchronized</span>(<span class="hljs-params"> obj </span>) &#123;<br> 		<span class="hljs-comment">// 同步块</span><br> 	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>当 Thread-1 进行轻量级加锁时，Thread-0 已经对该对象加了轻量级锁</li>
</ul>
<p><img src="/../JUC_pic/26.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>这时 Thread-1 加轻量级锁失败，进入锁膨胀流程 <ul>
<li>即为 Object 对象申请 Monitor 锁，让 Object 指向重量级锁地址 </li>
<li>然后自己进入 Monitor 的 EntryList BLOCKED</li>
</ul>
</li>
</ul>
<p><img src="/../JUC_pic/27.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>当 Thread-0 退出同步块解锁时，使用 cas 将 Mark Word 的值恢复给对象头，失败。这时会进入重量级解锁 流程，即按照 Monitor 地址找到 Monitor 对象，设置 Owner 为 null，唤醒 EntryList 中 BLOCKED 线程</li>
</ul>
<h3 id="自旋优化"><a href="#自旋优化" class="headerlink" title="自旋优化"></a>自旋优化</h3><p>重量级锁竞争的时候，还可以使用自旋来进行优化，如果当前线程自旋成功（即这时候持锁线程已经退出了同步 块，释放了锁），这时当前线程就可以避免阻塞。(阻塞会发生上下文切换，上下文切换影响性能)。</p>
<p><strong>自旋重试成功的情况</strong></p>
<p><img src="/../JUC_pic/28.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>自旋重试失败的情况</strong></p>
<p><img src="/../JUC_pic/29.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>自旋会占用 CPU 时间，单核 CPU 自旋就是浪费，多核 CPU 自旋才能发挥优势。 </li>
<li>在 Java 6 之后自旋锁是自适应的，比如对象刚刚的一次自旋操作成功过，那么认为这次自旋成功的可能性会 高，就多自旋几次；反之，就少自旋甚至不自旋，总之，比较智能。</li>
<li>Java 7 之后不能控制是否开启自旋功能</li>
</ul>
<h3 id="偏向锁"><a href="#偏向锁" class="headerlink" title="偏向锁"></a>偏向锁</h3><p>轻量级锁在没有竞争时（就自己这个线程），每次重入仍然需要执行 CAS（Compare And Swap） 操作。</p>
<p>Java 6 中引入了偏向锁来做进一步优化：只有第一次使用 CAS 将线程 ID 设置到对象的 Mark Word 头，之后发现 这个线程 ID 是自己的就表示没有竞争，不用重新 CAS。以后只要不发生竞争，这个对象就归该线程所有</p>
<p>例如：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">static</span> final <span class="hljs-title class_">Object</span> obj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">m1</span>(<span class="hljs-params"></span>) &#123;<br> 	<span class="hljs-title function_">synchronized</span>(<span class="hljs-params"> obj </span>) &#123;<br> 		<span class="hljs-comment">// 同步块 A</span><br> 		<span class="hljs-title function_">m2</span>();<br> 	&#125;<br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">m2</span>(<span class="hljs-params"></span>) &#123;<br> 	<span class="hljs-title function_">synchronized</span>(<span class="hljs-params"> obj </span>) &#123;<br> 		<span class="hljs-comment">// 同步块 B</span><br> 		<span class="hljs-title function_">m3</span>();<br> 	&#125;<br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">m3</span>(<span class="hljs-params"></span>) &#123;<br> 	<span class="hljs-title function_">synchronized</span>(<span class="hljs-params"> obj </span>) &#123;<br> 		<span class="hljs-comment">// 同步块 C</span><br> 	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/../JUC_pic/30.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/../JUC_pic/36.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="偏向状态"><a href="#偏向状态" class="headerlink" title="偏向状态"></a>偏向状态</h3><p>回忆一下对象头格式</p>
<p><img src="/../JUC_pic/37.png" srcset="/img/loading.gif" lazyload></p>
<p>分别是：无锁，偏向锁，轻量级锁，重量级锁，已被GC回收</p>
<p>一个对象创建时：</p>
<ul>
<li>如果开启了偏向锁（默认开启），那么对象创建后，markword 值为 0x05 即最后 3 位为 101，这时它的 thread、epoch、age 都为 0。</li>
<li>偏向锁是默认是延迟的，不会在程序启动时立即生效，如果想避免延迟，可以加 VM 参数 - XX:BiasedLockingStartupDelay&#x3D;0 来禁用延迟。(偏向锁的延迟性)</li>
<li>如果没有开启偏向锁，那么对象创建后，markword 值为 0x01 即最后 3 位为 001，这时它的 hashcode、 age 都为 0，第一次用到 hashcode 时才会赋值。</li>
</ul>
<p>1） 测试偏向锁的延迟特性</p>
<p>2） 测试偏向锁</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">class</span> <span class="hljs-symbol">Dog</span> &#123;&#125;<br></code></pre></td></tr></table></figure>

<p>利用 jol 第三方工具来查看对象头信息（注意这里我扩展了 jol 让它输出更为简洁）</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">// 添加虚拟机参数 -XX:BiasedLockingStartupDelay=<span class="hljs-number">0</span> <br><span class="hljs-built_in">public</span> static <span class="hljs-type">void</span> main(String[] args) throws IOException &#123;<br> 	Dog d = <span class="hljs-built_in">new</span> Dog();<br> 	ClassLayout classLayout = ClassLayout.parseInstance(d);<br> 	<br> 	<span class="hljs-built_in">new</span> Thread(() -&gt; &#123;<br> 		<span class="hljs-keyword">log</span>.<span class="hljs-keyword">debug</span>(&quot;synchronized 前&quot;);<br> 		<span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>.println(classLayout.toPrintableSimple(<span class="hljs-keyword">true</span>));<br> 		synchronized (d) &#123;<br> 			<span class="hljs-keyword">log</span>.<span class="hljs-keyword">debug</span>(&quot;synchronized 中&quot;);<br> 			<span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>.println(classLayout.toPrintableSimple(<span class="hljs-keyword">true</span>));<br> 		&#125;<br> 		<span class="hljs-keyword">log</span>.<span class="hljs-keyword">debug</span>(&quot;synchronized 后&quot;);<br> 		<span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>.println(classLayout.toPrintableSimple(<span class="hljs-keyword">true</span>));<br> &#125;, &quot;t1&quot;).<span class="hljs-keyword">start</span>();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs text">11:08:58.117 c.TestBiased [t1] - synchronized 前<br>00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000101 <br>11:08:58.121 c.TestBiased [t1] - synchronized 中<br>00000000 00000000 00000000 00000000 00011111 11101011 11010000 00000101 <br>11:08:58.121 c.TestBiased [t1] - synchronized 后<br>00000000 00000000 00000000 00000000 00011111 11101011 11010000 00000101<br></code></pre></td></tr></table></figure>

<p><strong>注意 处于偏向锁的对象解锁后，线程 id 仍存储于对象头中</strong></p>
<p>3）测试禁用 </p>
<p>在上面测试代码运行时在添加 VM 参数 -XX:-UseBiasedLocking 禁用偏向锁</p>
<p>输出</p>
<figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-number">11</span>:<span class="hljs-number">13</span>:<span class="hljs-number">10.018</span> c.TestBiased [t1] - synchronized 前<br><span class="hljs-symbol">00000000 </span><span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000001</span> <br><span class="hljs-number">11</span>:<span class="hljs-number">13</span>:<span class="hljs-number">10.021</span> c.TestBiased [t1] - synchronized 中<br><span class="hljs-symbol">00000000 </span><span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00100000</span> <span class="hljs-number">00010100</span> <span class="hljs-number">11110011</span> <span class="hljs-number">10001000</span> <br><span class="hljs-number">11</span>:<span class="hljs-number">13</span>:<span class="hljs-number">10.021</span> c.TestBiased [t1] - synchronized 后<br><span class="hljs-symbol">00000000 </span><span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000001</span><br></code></pre></td></tr></table></figure>

<ol start="4">
<li><p>测试 hashCode </p>
<p>正常状态对象一开始是没有 hashCode 的，第一次调用才生成,注意。调用Hashcode()方法会使偏向锁失效</p>
<p><img src="/../JUC_pic/37.png" srcset="/img/loading.gif" lazyload></p>
</li>
</ol>
<p>调用Hashcode()后生成31位hashCode ，这时候没有空间再存储thread(操作系统方面的线程ID)，所以偏向锁失效，但是为什么轻量级锁和重量级锁不失效呢？</p>
<p><img src="/../JUC_pic/26.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/../JUC_pic/27.png" srcset="/img/loading.gif" lazyload></p>
<p>因为对象在使用轻量级锁时把hashcode存储在线程栈帧的Lock Record(所记录)中。</p>
<p>而对象在使用重量级锁时把hashcode存储在Monitor对象中，释放锁时再还原给对象头中。</p>
<h3 id="撤销-调用对象-hashCode"><a href="#撤销-调用对象-hashCode" class="headerlink" title="撤销 - 调用对象 hashCode"></a>撤销 - 调用对象 hashCode</h3><p>调用了对象的 hashCode，但偏向锁的对象 MarkWord 中存储的是线程 id，如果调用 hashCode 会导致偏向锁被 撤销</p>
<ul>
<li>轻量级锁会在锁记录中记录 hashCode</li>
<li>重量级锁会在 Monitor 中记录 hashCode</li>
</ul>
<p>在调用 hashCode 后使用偏向锁，记得去掉 -XX:-UseBiasedLocking</p>
<p>输出</p>
<figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-number">11</span>:<span class="hljs-number">22</span>:<span class="hljs-number">10.386</span> c.TestBiased [main] - 调用 hashCode:<span class="hljs-number">1778535015</span> <br><span class="hljs-number">11</span>:<span class="hljs-number">22</span>:<span class="hljs-number">10.391</span> c.TestBiased [t1] - synchronized 前<br><span class="hljs-symbol">00000000 </span><span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">01101010</span> <span class="hljs-number">00000010</span> <span class="hljs-number">01001010</span> <span class="hljs-number">01100111</span> <span class="hljs-number">00000001</span> <br><span class="hljs-number">11</span>:<span class="hljs-number">22</span>:<span class="hljs-number">10.393</span> c.TestBiased [t1] - synchronized 中<br><span class="hljs-symbol">00000000 </span><span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00100000</span> <span class="hljs-number">11000011</span> <span class="hljs-number">11110011</span> <span class="hljs-number">01101000</span> <br><span class="hljs-number">11</span>:<span class="hljs-number">22</span>:<span class="hljs-number">10.393</span> c.TestBiased [t1] - synchronized 后<br><span class="hljs-symbol">00000000 </span><span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">01101010</span> <span class="hljs-number">00000010</span> <span class="hljs-number">01001010</span> <span class="hljs-number">01100111</span> <span class="hljs-number">00000001</span><br></code></pre></td></tr></table></figure>

<h3 id="撤销-其它线程使用对象"><a href="#撤销-其它线程使用对象" class="headerlink" title="撤销 - 其它线程使用对象"></a>撤销 - 其它线程使用对象</h3><p>当有其它线程使用偏向锁对象时，会将偏向锁升级为轻量级锁</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs livescript">private <span class="hljs-keyword">static</span> <span class="hljs-literal">void</span> test2() throws InterruptedException &#123;<br> 	Dog d = <span class="hljs-keyword">new</span> Dog();<br> 	Thread t1 = <span class="hljs-keyword">new</span> Thread<span class="hljs-function"><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 		synchronized (d) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 			log.debug(ClassLayout.parseInstance(d).toPrintableSimple(<span class="hljs-literal">true</span>));</span></span><br><span class="hljs-params"><span class="hljs-function"> 		&#125;</span></span><br><span class="hljs-params"><span class="hljs-function">	 synchronized (TestBiased.<span class="hljs-keyword">class</span>) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 		TestBiased.<span class="hljs-keyword">class</span>.notify();</span></span><br><span class="hljs-params"><span class="hljs-function"> 	&#125;</span></span><br><span class="hljs-params"><span class="hljs-function"> 	<span class="hljs-regexp">// 如果不用 wait/notify 使用 join 必须打开下面的注释</span></span></span><br><span class="hljs-regexp"><span class="hljs-params"><span class="hljs-function"> 	//</span> 因为：t1 线程不能结束，否则底层线程可能被 jvm 重用作为 t2 线程，底层线程 id 是一样的</span></span><br><span class="hljs-params"><span class="hljs-function"> 	/*<span class="hljs-keyword">try</span> &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 		System.<span class="hljs-keyword">in</span>.read();</span></span><br><span class="hljs-params"><span class="hljs-function"> 	&#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 		e.printStackTrace();</span></span><br><span class="hljs-params"><span class="hljs-function"> 	&#125;*/</span></span><br><span class="hljs-params"><span class="hljs-function"> &#125;, <span class="hljs-string">&quot;t1&quot;</span>)</span>;</span><br><span class="hljs-function"> <span class="hljs-title">t1</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function"> </span><br><span class="hljs-function">	 <span class="hljs-title">Thread</span> <span class="hljs-title">t2</span> = <span class="hljs-title">new</span> <span class="hljs-title">Thread</span><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 		synchronized (TestBiased.<span class="hljs-keyword">class</span>) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 			<span class="hljs-keyword">try</span> &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 				TestBiased.<span class="hljs-keyword">class</span>.wait();</span></span><br><span class="hljs-params"><span class="hljs-function"> 			&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 				e.printStackTrace();</span></span><br><span class="hljs-params"><span class="hljs-function"> 			&#125;</span></span><br><span class="hljs-params"><span class="hljs-function"> 		&#125;</span></span><br><span class="hljs-params"><span class="hljs-function">	    log.debug(ClassLayout.parseInstance(d).toPrintableSimple(<span class="hljs-literal">true</span>));</span></span><br><span class="hljs-params"><span class="hljs-function">		 synchronized (d) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 			log.debug(ClassLayout.parseInstance(d).toPrintableSimple(<span class="hljs-literal">true</span>));</span></span><br><span class="hljs-params"><span class="hljs-function"> 		&#125;</span></span><br><span class="hljs-params"><span class="hljs-function"> 		log.debug(ClassLayout.parseInstance(d).toPrintableSimple(<span class="hljs-literal">true</span>));</span></span><br><span class="hljs-params"><span class="hljs-function"> 	&#125;, <span class="hljs-string">&quot;t2&quot;</span>)</span>;</span><br><span class="hljs-function"> 	<span class="hljs-title">t2</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">&#125;</span><br></code></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dns">[t1] - <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">01000001</span> <span class="hljs-number">00010000</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">01000001</span> <span class="hljs-number">00010000</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">10110101</span> <span class="hljs-number">11110000</span> <span class="hljs-number">01000000</span> <br>[t2] - <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000001</span> <br></code></pre></td></tr></table></figure>

<h3 id="撤销-调用-wait-x2F-notify"><a href="#撤销-调用-wait-x2F-notify" class="headerlink" title="撤销 - 调用 wait&#x2F;notify"></a>撤销 - 调用 wait&#x2F;notify</h3><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs livescript">public <span class="hljs-keyword">static</span> <span class="hljs-literal">void</span> main(<span class="hljs-built_in">String</span>[] args) throws InterruptedException &#123;<br> 	Dog d = <span class="hljs-keyword">new</span> Dog();<br> 	Thread t1 = <span class="hljs-keyword">new</span> Thread<span class="hljs-function"><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 		log.debug(ClassLayout.parseInstance(d).toPrintableSimple(<span class="hljs-literal">true</span>));</span></span><br><span class="hljs-params"><span class="hljs-function"> 		synchronized (d) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 			log.debug(ClassLayout.parseInstance(d).toPrintableSimple(<span class="hljs-literal">true</span>));</span></span><br><span class="hljs-params"><span class="hljs-function"> 			<span class="hljs-keyword">try</span> &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 				d.wait();</span></span><br><span class="hljs-params"><span class="hljs-function"> 			&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 				e.printStackTrace();</span></span><br><span class="hljs-params"><span class="hljs-function"> 		&#125;</span></span><br><span class="hljs-params"><span class="hljs-function"> 		log.debug(ClassLayout.parseInstance(d).toPrintableSimple(<span class="hljs-literal">true</span>));</span></span><br><span class="hljs-params"><span class="hljs-function"> 		&#125;</span></span><br><span class="hljs-params"><span class="hljs-function"> 	&#125;, <span class="hljs-string">&quot;t1&quot;</span>)</span>;</span><br><span class="hljs-function"> 	<span class="hljs-title">t1</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function"> 	</span><br><span class="hljs-function"> 	<span class="hljs-title">new</span> <span class="hljs-title">Thread</span><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 		<span class="hljs-keyword">try</span> &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">			 Thread.sleep(<span class="hljs-number">6000</span>);</span></span><br><span class="hljs-params"><span class="hljs-function">		 &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 			e.printStackTrace();</span></span><br><span class="hljs-params"><span class="hljs-function">		 &#125;</span></span><br><span class="hljs-params"><span class="hljs-function"> 		synchronized (d) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 			log.debug(<span class="hljs-string">&quot;notify&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function"> 			d.notify();</span></span><br><span class="hljs-params"><span class="hljs-function"> 		&#125;</span></span><br><span class="hljs-params"><span class="hljs-function"> 	&#125;, <span class="hljs-string">&quot;t2&quot;</span>)</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">&#125;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dns">[t1] - <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000101</span> <br>[t1] - <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">10110011</span> <span class="hljs-number">11111000</span> <span class="hljs-number">00000101</span> <br>[t2] - notify <br>[t1] - <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011100</span> <span class="hljs-number">11010100</span> <span class="hljs-number">00001101</span> <span class="hljs-number">11001010</span> <br></code></pre></td></tr></table></figure>

<p>因为wait&#x2F;notify只有在重量锁(两个线程存在竞争)的情况下才能使用。</p>
<p><strong>wait&#x2F;notify方法的调用必须处在该对象的锁（Monitor）中，也即，在调用这些方法时首先需要获得该对象的锁。</strong>否则会抛出IllegalMonitorStateException异常。</p>
<h3 id="批量重偏向"><a href="#批量重偏向" class="headerlink" title="批量重偏向"></a>批量重偏向</h3><p>如果对象虽然被多个线程访问，但没有竞争，这时偏向了线程 T1 的对象仍有机会重新偏向 T2，重偏向会重置对象 的 Thread ID</p>
<p>当撤销偏向锁阈值超过 20 次后，jvm 会这样觉得，我是不是偏向错了呢，于是会在给这些对象加锁时重新偏向至 加锁线程,并且这些对象在synchronized同步代码块之外的状态依然处于偏向T2的状态，而在20次之前这些对象被撤销锁处于不可偏向状态(normal).</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs livescript">private <span class="hljs-keyword">static</span> <span class="hljs-literal">void</span> test3() throws InterruptedException &#123;<br> 	Vector&lt;Dog&gt; <span class="hljs-keyword">list</span> = <span class="hljs-keyword">new</span> Vector&lt;&gt;();<br> 	Thread t1 = <span class="hljs-keyword">new</span> Thread<span class="hljs-function"><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 		<span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">30</span>; i++) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 			Dog d = <span class="hljs-keyword">new</span> Dog();</span></span><br><span class="hljs-params"><span class="hljs-function"> 			<span class="hljs-keyword">list</span>.add(d);</span></span><br><span class="hljs-params"><span class="hljs-function"> 			synchronized (d) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 				log.debug(i + <span class="hljs-string">&quot;\t&quot;</span> + ClassLayout.parseInstance(d).toPrintableSimple(<span class="hljs-literal">true</span>));</span></span><br><span class="hljs-params"><span class="hljs-function"> 			&#125;</span></span><br><span class="hljs-params"><span class="hljs-function"> 		&#125;</span></span><br><span class="hljs-params"><span class="hljs-function"> 			synchronized (<span class="hljs-keyword">list</span>) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 				<span class="hljs-keyword">list</span>.notify();</span></span><br><span class="hljs-params"><span class="hljs-function"> 			&#125; </span></span><br><span class="hljs-params"><span class="hljs-function"> 		&#125;, <span class="hljs-string">&quot;t1&quot;</span>)</span>;</span><br><span class="hljs-function"> 		<span class="hljs-title">t1</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function"> </span><br><span class="hljs-function"> 	<span class="hljs-title">Thread</span> <span class="hljs-title">t2</span> = <span class="hljs-title">new</span> <span class="hljs-title">Thread</span><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 		synchronized (<span class="hljs-keyword">list</span>) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 			<span class="hljs-keyword">try</span> &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 				<span class="hljs-keyword">list</span>.wait();</span></span><br><span class="hljs-params"><span class="hljs-function"> 			&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 				e.printStackTrace();</span></span><br><span class="hljs-params"><span class="hljs-function"> 			&#125;</span></span><br><span class="hljs-params"><span class="hljs-function"> 	&#125;</span></span><br><span class="hljs-params"><span class="hljs-function"> 	log.debug(<span class="hljs-string">&quot;===============&gt; &quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function"> 	<span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">30</span>; i++) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 		Dog d = <span class="hljs-keyword">list</span>.get(i);</span></span><br><span class="hljs-params"><span class="hljs-function"> 		log.debug(i + <span class="hljs-string">&quot;\t&quot;</span> + ClassLayout.parseInstance(d).toPrintableSimple(<span class="hljs-literal">true</span>));</span></span><br><span class="hljs-params"><span class="hljs-function"> 		synchronized (d) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 			log.debug(i + <span class="hljs-string">&quot;\t&quot;</span> + ClassLayout.parseInstance(d).toPrintableSimple(<span class="hljs-literal">true</span>));</span></span><br><span class="hljs-params"><span class="hljs-function"> 		&#125;</span></span><br><span class="hljs-params"><span class="hljs-function">	 log.debug(i + <span class="hljs-string">&quot;\t&quot;</span> + ClassLayout.parseInstance(d).toPrintableSimple(<span class="hljs-literal">true</span>));</span></span><br><span class="hljs-params"><span class="hljs-function"> 		&#125;</span></span><br><span class="hljs-params"><span class="hljs-function"> 	&#125;, <span class="hljs-string">&quot;t2&quot;</span>)</span>;</span><br><span class="hljs-function"> 		<span class="hljs-title">t2</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">&#125;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><code class="hljs dns">[t1] - <span class="hljs-number">0 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t1] - <span class="hljs-number">1 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t1] - <span class="hljs-number">2 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t1] - <span class="hljs-number">3 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t1] - <span class="hljs-number">4 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t1] - <span class="hljs-number">5 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t1] - <span class="hljs-number">6 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t1] - <span class="hljs-number">7 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t1] - <span class="hljs-number">8 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t1] - <span class="hljs-number">9 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t1] - <span class="hljs-number">10 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t1] - <span class="hljs-number">11 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t1] - <span class="hljs-number">12 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t1] - <span class="hljs-number">13 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t1] - <span class="hljs-number">14 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t1] - <span class="hljs-number">15 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t1] - <span class="hljs-number">16 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t1] - <span class="hljs-number">17 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t1] - <span class="hljs-number">18 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t1] - <span class="hljs-number">19 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t1] - <span class="hljs-number">20 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t1] - <span class="hljs-number">21 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t1] - <span class="hljs-number">22 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t1] - <span class="hljs-number">23 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t1] - <span class="hljs-number">24 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t1] - <span class="hljs-number">25 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t1] - <span class="hljs-number">26 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t1] - <span class="hljs-number">27 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t1] - <span class="hljs-number">28 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t1] - <span class="hljs-number">29 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t2] - ===============&gt; <br>[t2] - <span class="hljs-number">0 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">0 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00100000</span> <span class="hljs-number">01011000</span> <span class="hljs-number">11110111</span> <span class="hljs-number">00000000</span> <br>[t2] - <span class="hljs-number">0 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000001</span> <br>[t2] - <span class="hljs-number">1 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">1 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00100000</span> <span class="hljs-number">01011000</span> <span class="hljs-number">11110111</span> <span class="hljs-number">00000000</span> <br>[t2] - <span class="hljs-number">1 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000001</span> <br>[t2] - <span class="hljs-number">2 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">2 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00100000</span> <span class="hljs-number">01011000</span> <span class="hljs-number">11110111</span> <span class="hljs-number">00000000</span> <br>[t2] - <span class="hljs-number">2 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000001</span> <br>[t2] - <span class="hljs-number">3 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">3 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00100000</span> <span class="hljs-number">01011000</span> <span class="hljs-number">11110111</span> <span class="hljs-number">00000000</span> <br>[t2] - <span class="hljs-number">3 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000001</span> <br>[t2] - <span class="hljs-number">4 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">4 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00100000</span> <span class="hljs-number">01011000</span> <span class="hljs-number">11110111</span> <span class="hljs-number">00000000</span> <br>[t2] - <span class="hljs-number">4 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000001</span> <br>[t2] - <span class="hljs-number">5 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">5 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00100000</span> <span class="hljs-number">01011000</span> <span class="hljs-number">11110111</span> <span class="hljs-number">00000000</span> <br>[t2] - <span class="hljs-number">5 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000001</span> <br>[t2] - <span class="hljs-number">6 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">6 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00100000</span> <span class="hljs-number">01011000</span> <span class="hljs-number">11110111</span> <span class="hljs-number">00000000</span> <br>[t2] - <span class="hljs-number">6 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000001</span> <br>[t2] - <span class="hljs-number">7 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">7 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00100000</span> <span class="hljs-number">01011000</span> <span class="hljs-number">11110111</span> <span class="hljs-number">00000000</span> <br>[t2] - <span class="hljs-number">7 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000001</span> <br>[t2] - <span class="hljs-number">8 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">8 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00100000</span> <span class="hljs-number">01011000</span> <span class="hljs-number">11110111</span> <span class="hljs-number">00000000</span> <br>[t2] - <span class="hljs-number">8 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000001</span> <br>[t2] - <span class="hljs-number">9 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">9 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00100000</span> <span class="hljs-number">01011000</span> <span class="hljs-number">11110111</span> <span class="hljs-number">00000000</span> <br>[t2] - <span class="hljs-number">9 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000001</span> <br>[t2] - <span class="hljs-number">10 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">10 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00100000</span> <span class="hljs-number">01011000</span> <span class="hljs-number">11110111</span> <span class="hljs-number">00000000</span> <br>[t2] - <span class="hljs-number">10 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000001</span> <br>[t2] - <span class="hljs-number">11 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">11 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00100000</span> <span class="hljs-number">01011000</span> <span class="hljs-number">11110111</span> <span class="hljs-number">00000000</span> <br>[t2] - <span class="hljs-number">11 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000001</span> <br>[t2] - <span class="hljs-number">12 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">12 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00100000</span> <span class="hljs-number">01011000</span> <span class="hljs-number">11110111</span> <span class="hljs-number">00000000</span> <br>[t2] - <span class="hljs-number">12 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000001</span> <br>[t2] - <span class="hljs-number">13 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">13 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00100000</span> <span class="hljs-number">01011000</span> <span class="hljs-number">11110111</span> <span class="hljs-number">00000000</span> <br>[t2] - <span class="hljs-number">13 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000001</span> <br>[t2] - <span class="hljs-number">14 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">14 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00100000</span> <span class="hljs-number">01011000</span> <span class="hljs-number">11110111</span> <span class="hljs-number">00000000</span> <br>[t2] - <span class="hljs-number">14 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000001</span> <br>[t2] - <span class="hljs-number">15 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">15 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00100000</span> <span class="hljs-number">01011000</span> <span class="hljs-number">11110111</span> <span class="hljs-number">00000000</span> <br>[t2] - <span class="hljs-number">15 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000001</span> <br>[t2] - <span class="hljs-number">16 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">16 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00100000</span> <span class="hljs-number">01011000</span> <span class="hljs-number">11110111</span> <span class="hljs-number">00000000</span> <br>[t2] - <span class="hljs-number">16 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000001</span> <br>[t2] - <span class="hljs-number">17 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">17 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00100000</span> <span class="hljs-number">01011000</span> <span class="hljs-number">11110111</span> <span class="hljs-number">00000000</span> <br>[t2] - <span class="hljs-number">17 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000001</span> <br>[t2] - <span class="hljs-number">18 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">18 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00100000</span> <span class="hljs-number">01011000</span> <span class="hljs-number">11110111</span> <span class="hljs-number">00000000</span> <br>[t2] - <span class="hljs-number">18 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000001</span> <br>[t2] - <span class="hljs-number">19 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">19 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11110001</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">19 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11110001</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">20 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">20 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11110001</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">20 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11110001</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">21 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">21 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11110001</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">21 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11110001</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">22 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">22 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11110001</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">22 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11110001</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">23 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">23 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11110001</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">23 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11110001</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">24 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">24 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11110001</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">24 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11110001</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">25 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">25 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11110001</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">25 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11110001</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">26 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">26 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11110001</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">26 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11110001</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">27 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">27 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11110001</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">27 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11110001</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">28 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">28 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11110001</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">28 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11110001</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">29 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11100000</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">29 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11110001</span> <span class="hljs-number">00000101</span> <br>[t2] - <span class="hljs-number">29 00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00011111</span> <span class="hljs-number">11110011</span> <span class="hljs-number">11110001</span> <span class="hljs-number">00000101</span> <br><br></code></pre></td></tr></table></figure>

<h3 id="批量撤销"><a href="#批量撤销" class="headerlink" title="批量撤销"></a>批量撤销</h3><p>当撤销偏向锁阈值超过 40 次后，jvm 会这样觉得，自己确实偏向错了，根本就不该偏向。于是整个类的所有对象 都会变为不可偏向的，新建的对象也是不可偏向的。</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs livescript"><span class="hljs-keyword">static</span> Thread t1,t2,t3;<br>   private <span class="hljs-keyword">static</span> <span class="hljs-literal">void</span> test4() throws InterruptedException &#123;<br>		 Vector&lt;Dog&gt; <span class="hljs-keyword">list</span> = <span class="hljs-keyword">new</span> Vector&lt;&gt;();<br> 		 int loopNumber = <span class="hljs-number">39</span>;<br> 		t1 = <span class="hljs-keyword">new</span> Thread<span class="hljs-function"><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 			<span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; loopNumber; i++) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 			Dog d = <span class="hljs-keyword">new</span> Dog();</span></span><br><span class="hljs-params"><span class="hljs-function"> 			<span class="hljs-keyword">list</span>.add(d);</span></span><br><span class="hljs-params"><span class="hljs-function"> 			synchronized (d) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 				log.debug(i + <span class="hljs-string">&quot;\t&quot;</span> + ClassLayout.parseInstance(d).toPrintableSimple(<span class="hljs-literal">true</span>));</span></span><br><span class="hljs-params"><span class="hljs-function"> 			&#125;</span></span><br><span class="hljs-params"><span class="hljs-function"> 		&#125;</span></span><br><span class="hljs-params"><span class="hljs-function"> 			LockSupport.unpark(t2);</span></span><br><span class="hljs-params"><span class="hljs-function"> 		&#125;, <span class="hljs-string">&quot;t1&quot;</span>)</span>;</span><br><span class="hljs-function"> 		<span class="hljs-title">t1</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function"> 	  <span class="hljs-title">t2</span> = <span class="hljs-title">new</span> <span class="hljs-title">Thread</span><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 		LockSupport.park();</span></span><br><span class="hljs-params"><span class="hljs-function"> 		log.debug(<span class="hljs-string">&quot;===============&gt; &quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function"> 		<span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; loopNumber; i++) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 			Dog d = <span class="hljs-keyword">list</span>.get(i);</span></span><br><span class="hljs-params"><span class="hljs-function"> 			log.debug(i + <span class="hljs-string">&quot;\t&quot;</span> + ClassLayout.parseInstance(d).toPrintableSimple(<span class="hljs-literal">true</span>));</span></span><br><span class="hljs-params"><span class="hljs-function"> 			synchronized (d) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 				log.debug(i + <span class="hljs-string">&quot;\t&quot;</span> + ClassLayout.parseInstance(d).toPrintableSimple(<span class="hljs-literal">true</span>));</span></span><br><span class="hljs-params"><span class="hljs-function"> 			&#125;</span></span><br><span class="hljs-params"><span class="hljs-function">			 log.debug(i + <span class="hljs-string">&quot;\t&quot;</span> + ClassLayout.parseInstance(d).toPrintableSimple(<span class="hljs-literal">true</span>));</span></span><br><span class="hljs-params"><span class="hljs-function"> 		&#125;</span></span><br><span class="hljs-params"><span class="hljs-function"> 		LockSupport.unpark(t3);</span></span><br><span class="hljs-params"><span class="hljs-function"> 		&#125;, <span class="hljs-string">&quot;t2&quot;</span>)</span>;</span><br><span class="hljs-function"></span><br><span class="hljs-function">5. 锁消除</span><br><span class="hljs-function">锁消除</span><br><span class="hljs-function"> 		<span class="hljs-title">t2</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">	    <span class="hljs-title">t3</span> = <span class="hljs-title">new</span> <span class="hljs-title">Thread</span><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 			LockSupport.park();</span></span><br><span class="hljs-params"><span class="hljs-function"> 			log.debug(<span class="hljs-string">&quot;===============&gt; &quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function"> 			<span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; loopNumber; i++) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 				Dog d = <span class="hljs-keyword">list</span>.get(i);</span></span><br><span class="hljs-params"><span class="hljs-function"> 				log.debug(i + <span class="hljs-string">&quot;\t&quot;</span> + ClassLayout.parseInstance(d).toPrintableSimple(<span class="hljs-literal">true</span>));</span></span><br><span class="hljs-params"><span class="hljs-function"> 				synchronized (d) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> 				log.debug(i + <span class="hljs-string">&quot;\t&quot;</span> + ClassLayout.parseInstance(d).toPrintableSimple(<span class="hljs-literal">true</span>));</span></span><br><span class="hljs-params"><span class="hljs-function"> 			&#125;</span></span><br><span class="hljs-params"><span class="hljs-function"> 			log.debug(i + <span class="hljs-string">&quot;\t&quot;</span> + ClassLayout.parseInstance(d).toPrintableSimple(<span class="hljs-literal">true</span>));</span></span><br><span class="hljs-params"><span class="hljs-function"> 		&#125;</span></span><br><span class="hljs-params"><span class="hljs-function">	 &#125;, <span class="hljs-string">&quot;t3&quot;</span>)</span>;</span><br><span class="hljs-function"> <span class="hljs-title">t3</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function"> <span class="hljs-title">t3</span>.<span class="hljs-title">join</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function"> <span class="hljs-title">log</span>.<span class="hljs-title">debug</span><span class="hljs-params">(ClassLayout.parseInstance(<span class="hljs-keyword">new</span> Dog()).toPrintableSimple(<span class="hljs-literal">true</span>))</span>;</span><br><span class="hljs-function">&#125;</span><br></code></pre></td></tr></table></figure>

<h2 id="Wait-notify原理"><a href="#Wait-notify原理" class="headerlink" title="Wait notify原理"></a>Wait notify原理</h2><p><img src="/../JUC_pic/41.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li><p>Owner 线程发现条件不满足，调用 wait 方法，即可进入 WaitSet 变为 WAITING 状态 </p>
</li>
<li><p>BLOCKED 和 WAITING 的线程都处于阻塞状态，不占用 CPU 时间片 </p>
</li>
<li><p>BLOCKED 线程会在 Owner 线程释放锁时唤醒</p>
</li>
<li><p>WAITING 线程会在 Owner 线程调用 notify 或 notifyAll 时唤醒，但唤醒后并不意味者立刻获得锁，仍需进入 EntryList 重新竞争</p>
</li>
</ul>
<h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><ul>
<li>obj.wait() 让进入 object 监视器的线程到 waitSet 等待</li>
<li>obj.notify() 在 object 上正在 waitSet 等待的线程中挑一个唤醒</li>
<li>obj.notifyAll() 让 object 上正在 waitSet 等待的线程全部唤醒</li>
</ul>
<p>它们都是线程之间进行协作的手段，都属于 Object 对象的方法。必须获得此对象的锁，才能调用这几个方法,比如</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs scss">new <span class="hljs-built_in">Thread</span>(() -&gt; &#123;<br> synchronized (obj) &#123;<br> log<span class="hljs-selector-class">.debug</span>(&quot;执行....&quot;);<br> try &#123;<br> obj<span class="hljs-selector-class">.wait</span>(); <span class="hljs-comment">// 让线程在obj上一直等待下去</span><br> &#125; catch (InterruptedException e) &#123;<br> e<span class="hljs-selector-class">.printStackTrace</span>();<br> &#125;<br> log<span class="hljs-selector-class">.debug</span>(&quot;其它代码....&quot;);<br> &#125;<br> &#125;)<span class="hljs-selector-class">.start</span>();<br></code></pre></td></tr></table></figure>

<h3 id="sleep-long-n-和-wait-long-n-的区别"><a href="#sleep-long-n-和-wait-long-n-的区别" class="headerlink" title="sleep(long n) 和 wait(long n) 的区别"></a>sleep(long n) 和 wait(long n) 的区别</h3><ul>
<li>sleep 是 Thread 方法，而 wait 是 Object 的方法</li>
<li>sleep 不需要强制和 synchronized 配合使用，但 wait 需要 和 synchronized 一起用</li>
<li>sleep 在睡眠的同时，不会释放对象锁的，但 wait 在等待的时候会释放对象锁</li>
<li>它们 状态都是 TIMED_WAITING(共同点)</li>
</ul>
<h2 id="Park-amp-Unpark"><a href="#Park-amp-Unpark" class="headerlink" title="Park &amp; Unpark"></a>Park &amp; Unpark</h2><h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><p>调用park的线程处于wait状态</p>
<p>它们是 LockSupport 类中的方法</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span> 暂停当前线程<br>LockSupport.park(); <br><span class="hljs-regexp">//</span> 恢复某个线程的运行<br>LockSupport.unpark(暂停线程对象)<br></code></pre></td></tr></table></figure>

<p>先 park 再 unpark</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs livescript">Thread t1 = <span class="hljs-keyword">new</span> Thread<span class="hljs-function"><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> log.debug(<span class="hljs-string">&quot;start...&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function"> sleep(<span class="hljs-number">1</span>);</span></span><br><span class="hljs-params"><span class="hljs-function"> log.debug(<span class="hljs-string">&quot;park...&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function"> LockSupport.park();</span></span><br><span class="hljs-params"><span class="hljs-function"> log.debug(<span class="hljs-string">&quot;resume...&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function">&#125;,<span class="hljs-string">&quot;t1&quot;</span>)</span>;</span><br><span class="hljs-function"><span class="hljs-title">t1</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function"><span class="hljs-title">sleep</span><span class="hljs-params">(<span class="hljs-number">2</span>)</span>;</span><br><span class="hljs-function"><span class="hljs-title">log</span>.<span class="hljs-title">debug</span><span class="hljs-params">(<span class="hljs-string">&quot;unpark...&quot;</span>)</span>;</span><br><span class="hljs-function"><span class="hljs-title">LockSupport</span>.<span class="hljs-title">unpark</span><span class="hljs-params">(t1)</span>;</span><br></code></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">18</span>:<span class="hljs-number">42</span>:<span class="hljs-number">52.585</span> c<span class="hljs-selector-class">.TestParkUnpark</span> <span class="hljs-selector-attr">[t1]</span> - start... <br><span class="hljs-number">18</span>:<span class="hljs-number">42</span>:<span class="hljs-number">53.589</span> c<span class="hljs-selector-class">.TestParkUnpark</span> <span class="hljs-selector-attr">[t1]</span> - park... <br><span class="hljs-number">18</span>:<span class="hljs-number">42</span>:<span class="hljs-number">54.583</span> c<span class="hljs-selector-class">.TestParkUnpark</span> <span class="hljs-selector-attr">[main]</span> - unpark... <br><span class="hljs-number">18</span>:<span class="hljs-number">42</span>:<span class="hljs-number">54.583</span> c<span class="hljs-selector-class">.TestParkUnpark</span> <span class="hljs-selector-attr">[t1]</span> - resume... <br></code></pre></td></tr></table></figure>

<p>先 unpark 再 park</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs livescript">Thread t1 = <span class="hljs-keyword">new</span> Thread<span class="hljs-function"><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> log.debug(<span class="hljs-string">&quot;start...&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function"> sleep(<span class="hljs-number">2</span>);</span></span><br><span class="hljs-params"><span class="hljs-function"> log.debug(<span class="hljs-string">&quot;park...&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function"> LockSupport.park();</span></span><br><span class="hljs-params"><span class="hljs-function"> log.debug(<span class="hljs-string">&quot;resume...&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function">&#125;, <span class="hljs-string">&quot;t1&quot;</span>)</span>;</span><br><span class="hljs-function"><span class="hljs-title">t1</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function"><span class="hljs-title">sleep</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span>;</span><br><span class="hljs-function"><span class="hljs-title">log</span>.<span class="hljs-title">debug</span><span class="hljs-params">(<span class="hljs-string">&quot;unpark...&quot;</span>)</span>;</span><br><span class="hljs-function"><span class="hljs-title">LockSupport</span>.<span class="hljs-title">unpark</span><span class="hljs-params">(t1)</span>;</span><br></code></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">18</span>:<span class="hljs-number">43</span>:<span class="hljs-number">50.765</span> c<span class="hljs-selector-class">.TestParkUnpark</span> <span class="hljs-selector-attr">[t1]</span> - start... <br><span class="hljs-number">18</span>:<span class="hljs-number">43</span>:<span class="hljs-number">51.764</span> c<span class="hljs-selector-class">.TestParkUnpark</span> <span class="hljs-selector-attr">[main]</span> - unpark... <br><span class="hljs-number">18</span>:<span class="hljs-number">43</span>:<span class="hljs-number">52.769</span> c<span class="hljs-selector-class">.TestParkUnpark</span> <span class="hljs-selector-attr">[t1]</span> - park... <br><span class="hljs-number">18</span>:<span class="hljs-number">43</span>:<span class="hljs-number">52.769</span> c<span class="hljs-selector-class">.TestParkUnpark</span> <span class="hljs-selector-attr">[t1]</span> - resume... <br></code></pre></td></tr></table></figure>

<p>可以看到不管unpark在park之前还是之后都可以成功唤醒park所在线程</p>
<h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><p>与 Object 的 wait &amp; notify 相比</p>
<ul>
<li>wait，notify 和 notifyAll 必须配合 Object Monitor 一起使用，而 park，unpark 不必</li>
<li>park &amp; unpark 是以线程为单位来【阻塞】和【唤醒】线程，而 notify 只能随机唤醒一个等待线程，notifyAll  是唤醒所有等待线程，就不那么【精确】</li>
<li>park &amp; unpark 可以先 unpark，而 wait &amp; notify 不能先 notify</li>
</ul>
<h2 id="线程状态转换"><a href="#线程状态转换" class="headerlink" title="线程状态转换"></a>线程状态转换</h2><p><img src="/../JUC_pic/42.png" srcset="/img/loading.gif" lazyload></p>
<p>(待详细分析)</p>
<h2 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h2><p>相对于 synchronized 它具备如下特点</p>
<ul>
<li>可打断(synchonized不可打断)，减少死锁发生的 可能性</li>
<li>可以设置超时时间</li>
<li>可以设置为公平锁</li>
<li>支持多个条件变量</li>
</ul>
<p>与 synchronized 一样，都支持可重入</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span> 获取锁<br>reentrantLock.lock();<br>try &#123;<br> <span class="hljs-regexp">//</span> 临界区<br>&#125; finally &#123;<br> <span class="hljs-regexp">//</span> 释放锁<br> reentrantLock.unlock();<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="可重入"><a href="#可重入" class="headerlink" title="可重入"></a>可重入</h3><p>可重入是指同一个线程如果首次获得了这把锁，那么因为它是这把锁的拥有者，因此有权利再次获取这把锁 如果是不可重入锁，那么第二次获得锁时，自己也会被锁挡住</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs csharp">@Slf4j<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ReentrantLockTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ReentrantLock <span class="hljs-keyword">lock</span> = <span class="hljs-keyword">new</span> ReentrantLock();<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> &#123;<br>        <span class="hljs-keyword">lock</span>.<span class="hljs-keyword">lock</span>();<br>        <span class="hljs-keyword">try</span> &#123;<br>            log.debug(<span class="hljs-string">&quot;entry main&quot;</span>);<br>            m1();<br>        &#125;<span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">lock</span>.unlock();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">m1</span>()</span>&#123;<br>        <span class="hljs-keyword">lock</span>.<span class="hljs-keyword">lock</span>();<br>        <span class="hljs-keyword">try</span> &#123;<br>            log.debug(<span class="hljs-string">&quot;entry m1&quot;</span>);<br>            m2();<br>        &#125;<span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">lock</span>.unlock();<br>        &#125;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">m2</span>()</span>&#123;<br>        <span class="hljs-keyword">lock</span>.<span class="hljs-keyword">lock</span>();<br>        <span class="hljs-keyword">try</span> &#123;<br>            log.debug(<span class="hljs-string">&quot;entry m2&quot;</span>);<br>        &#125;<span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">lock</span>.unlock();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">16</span>:<span class="hljs-number">01</span>:<span class="hljs-number">24.390</span> <span class="hljs-selector-attr">[main]</span> DEBUG lock<span class="hljs-selector-class">.ReentrantLockTest</span> - entry <span class="hljs-selector-tag">main</span><br><span class="hljs-number">16</span>:<span class="hljs-number">01</span>:<span class="hljs-number">24.392</span> <span class="hljs-selector-attr">[main]</span> DEBUG lock<span class="hljs-selector-class">.ReentrantLockTest</span> - entry m1<br><span class="hljs-number">16</span>:<span class="hljs-number">01</span>:<span class="hljs-number">24.392</span> <span class="hljs-selector-attr">[main]</span> DEBUG lock<span class="hljs-selector-class">.ReentrantLockTest</span> - entry m2<br></code></pre></td></tr></table></figure>

<h3 id="可打断"><a href="#可打断" class="headerlink" title="可打断"></a>可打断</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">ReentrantLock <span class="hljs-keyword">lock</span> = <span class="hljs-built_in">new</span> ReentrantLock();<br>        Thread t1 = <span class="hljs-built_in">new</span> Thread(()-&gt;&#123;<br>            <span class="hljs-keyword">log</span>.<span class="hljs-keyword">debug</span>(&quot;启动...&quot;);<br>            try &#123;<br>                //如果没有竞争那么将获得<span class="hljs-keyword">lock</span>对象锁<br>                //如果有竞争就进入阻塞队列,可以被其他线程用interrupt()打断<br>                //主线程已经获取锁了，t1线程阻塞并在阻塞队列等待，主线程执行t1.interrupt()将t1等待打断<br>                <span class="hljs-keyword">lock</span>.lockInterruptibly();<br>            &#125; catch (InterruptedException e) &#123;<br>                e.printStackTrace();<br>                <span class="hljs-keyword">log</span>.<span class="hljs-keyword">debug</span>(&quot;等锁的过程中被打断&quot;);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            try &#123;<br>                <span class="hljs-keyword">log</span>.<span class="hljs-keyword">debug</span>(&quot;获得了锁&quot;);<br>            &#125; finally &#123;<br>                <span class="hljs-keyword">lock</span>.unlock();<br>            &#125;<br>        &#125;,&quot;t1&quot;);<br>        <span class="hljs-keyword">lock</span>.<span class="hljs-keyword">lock</span>();<br>        <span class="hljs-keyword">log</span>.<span class="hljs-keyword">debug</span>(&quot;获得了锁&quot;);<br>        t1.<span class="hljs-keyword">start</span>();<br>        try &#123;<br>            Thread.sleep(<span class="hljs-number">1000</span>);<br>            t1.interrupt();<br>            <span class="hljs-keyword">log</span>.<span class="hljs-keyword">debug</span>(&quot;执行打断&quot;);<br>        &#125; finally &#123;<br>            <span class="hljs-keyword">lock</span>.unlock();<br>        &#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">6</span>:<span class="hljs-number">47</span>:<span class="hljs-number">34.169</span> <span class="hljs-selector-attr">[main]</span> DEBUG lock<span class="hljs-selector-class">.ReentrantLockTest2</span> - 获得了锁<br><span class="hljs-number">16</span>:<span class="hljs-number">47</span>:<span class="hljs-number">34.172</span> <span class="hljs-selector-attr">[Thread-0]</span> DEBUG lock<span class="hljs-selector-class">.ReentrantLockTest2</span> - 启动...<br><span class="hljs-number">16</span>:<span class="hljs-number">47</span>:<span class="hljs-number">35.183</span> <span class="hljs-selector-attr">[main]</span> DEBUG lock<span class="hljs-selector-class">.ReentrantLockTest2</span> - 执行打断<br><span class="hljs-number">16</span>:<span class="hljs-number">47</span>:<span class="hljs-number">35.183</span> <span class="hljs-selector-attr">[Thread-0]</span> DEBUG lock<span class="hljs-selector-class">.ReentrantLockTest2</span> - 等锁的过程中被打断<br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.InterruptedException</span><br>	at java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.concurrent</span><span class="hljs-selector-class">.locks</span><span class="hljs-selector-class">.AbstractQueuedSynchronizer</span><span class="hljs-selector-class">.doAcquireInterruptibly</span>(AbstractQueuedSynchronizer<span class="hljs-selector-class">.java</span>:<span class="hljs-number">898</span>)<br>	at java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.concurrent</span><span class="hljs-selector-class">.locks</span><span class="hljs-selector-class">.AbstractQueuedSynchronizer</span><span class="hljs-selector-class">.acquireInterruptibly</span>(AbstractQueuedSynchronizer<span class="hljs-selector-class">.java</span>:<span class="hljs-number">1222</span>)<br>	at java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.concurrent</span><span class="hljs-selector-class">.locks</span><span class="hljs-selector-class">.ReentrantLock</span><span class="hljs-selector-class">.lockInterruptibly</span>(ReentrantLock<span class="hljs-selector-class">.java</span>:<span class="hljs-number">335</span>)<br>	at lock<span class="hljs-selector-class">.ReentrantLockTest2</span>.lambda<span class="hljs-variable">$main</span>$<span class="hljs-number">0</span>(ReentrantLockTest2<span class="hljs-selector-class">.java</span>:<span class="hljs-number">20</span>)<br>	at java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.Thread</span><span class="hljs-selector-class">.run</span>(Thread<span class="hljs-selector-class">.java</span>:<span class="hljs-number">750</span>)<br></code></pre></td></tr></table></figure>

<p>注意如果是不可中断模式，那么即使使用了 interrupt 也不会让等待中断</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs livescript">@Slf4j<br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReentrantLockTest2</span> &#123;<br>    public <span class="hljs-keyword">static</span> <span class="hljs-literal">void</span> main(<span class="hljs-built_in">String</span>[] args) throws InterruptedException &#123;<br>        ReentrantLock lock = <span class="hljs-keyword">new</span> ReentrantLock();<br>        Thread t1 = <span class="hljs-keyword">new</span> Thread<span class="hljs-function"><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">            log.debug(<span class="hljs-string">&quot;启动...&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function">            lock.lock();</span></span><br><span class="hljs-params"><span class="hljs-function">            <span class="hljs-keyword">try</span> &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">                log.debug(<span class="hljs-string">&quot;获得了锁&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function">            &#125; <span class="hljs-keyword">finally</span> &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">                lock.unlock();</span></span><br><span class="hljs-params"><span class="hljs-function">            &#125;</span></span><br><span class="hljs-params"><span class="hljs-function">        &#125;, <span class="hljs-string">&quot;t1&quot;</span>)</span>;</span><br><span class="hljs-function">        <span class="hljs-title">lock</span>.<span class="hljs-title">lock</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">        <span class="hljs-title">log</span>.<span class="hljs-title">debug</span><span class="hljs-params">(<span class="hljs-string">&quot;获得了锁&quot;</span>)</span>;</span><br><span class="hljs-function">        <span class="hljs-title">t1</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">        <span class="hljs-title">try</span> &#123;</span><br><span class="hljs-function">            <span class="hljs-title">sleep</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span>;</span><br><span class="hljs-function">            <span class="hljs-title">t1</span>.<span class="hljs-title">interrupt</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">            <span class="hljs-title">log</span>.<span class="hljs-title">debug</span><span class="hljs-params">(<span class="hljs-string">&quot;执行打断&quot;</span>)</span>;</span><br><span class="hljs-function">            <span class="hljs-title">sleep</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span>;</span><br><span class="hljs-function">        &#125; <span class="hljs-title">finally</span> &#123;</span><br><span class="hljs-function">            <span class="hljs-title">log</span>.<span class="hljs-title">debug</span><span class="hljs-params">(<span class="hljs-string">&quot;释放了锁&quot;</span>)</span>;</span><br><span class="hljs-function">            <span class="hljs-title">lock</span>.<span class="hljs-title">unlock</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">        &#125;</span><br><span class="hljs-function">    &#125;</span><br><span class="hljs-function">&#125;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">18</span>:<span class="hljs-number">06</span>:<span class="hljs-number">56.261</span> <span class="hljs-selector-attr">[main]</span> c<span class="hljs-selector-class">.TestInterrupt</span> - 获得了锁<br><span class="hljs-number">18</span>:<span class="hljs-number">06</span>:<span class="hljs-number">56.265</span> <span class="hljs-selector-attr">[t1]</span> c<span class="hljs-selector-class">.TestInterrupt</span> - 启动... <br><span class="hljs-number">18</span>:<span class="hljs-number">06</span>:<span class="hljs-number">57.266</span> <span class="hljs-selector-attr">[main]</span> c<span class="hljs-selector-class">.TestInterrupt</span> - 执行打断 <span class="hljs-comment">// 这时 t1 并没有被真正打断, 而是仍继续等待锁</span><br><span class="hljs-number">18</span>:<span class="hljs-number">06</span>:<span class="hljs-number">58.267</span> <span class="hljs-selector-attr">[main]</span> c<span class="hljs-selector-class">.TestInterrupt</span> - 释放了锁<br><span class="hljs-number">18</span>:<span class="hljs-number">06</span>:<span class="hljs-number">58.267</span> <span class="hljs-selector-attr">[t1]</span> c<span class="hljs-selector-class">.TestInterrupt</span> - 获得了锁<br></code></pre></td></tr></table></figure>

<p>这是一种被动打断，也就是被别的线程打断，所以接下来介绍主动打断-&gt;锁超时。</p>
<h3 id="锁超时"><a href="#锁超时" class="headerlink" title="锁超时"></a>锁超时</h3><p>立刻失败</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs livescript">ReentrantLock lock = <span class="hljs-keyword">new</span> ReentrantLock();<br>Thread t1 = <span class="hljs-keyword">new</span> Thread<span class="hljs-function"><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">    log.debug(<span class="hljs-string">&quot;启动...&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-keyword">if</span> (!lock.tryLock()) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">        log.debug(<span class="hljs-string">&quot;获取立刻失败，返回&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-keyword">return</span>;</span></span><br><span class="hljs-params"><span class="hljs-function">    &#125;</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-keyword">try</span> &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">        log.debug(<span class="hljs-string">&quot;获得了锁&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function">    &#125; <span class="hljs-keyword">finally</span> &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">        lock.unlock();</span></span><br><span class="hljs-params"><span class="hljs-function">    &#125;</span></span><br><span class="hljs-params"><span class="hljs-function">&#125;, <span class="hljs-string">&quot;t1&quot;</span>)</span>;</span><br><span class="hljs-function">//主线程获得到<span class="hljs-title">lock</span>锁</span><br><span class="hljs-function"><span class="hljs-title">lock</span>.<span class="hljs-title">lock</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function"><span class="hljs-title">log</span>.<span class="hljs-title">debug</span><span class="hljs-params">(<span class="hljs-string">&quot;获得了锁&quot;</span>)</span>;</span><br><span class="hljs-function"><span class="hljs-title">t1</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function"><span class="hljs-title">try</span> &#123;</span><br><span class="hljs-function">    <span class="hljs-title">sleep</span><span class="hljs-params">(<span class="hljs-number">2</span>)</span>;</span><br><span class="hljs-function">&#125; <span class="hljs-title">finally</span> &#123;</span><br><span class="hljs-function">    <span class="hljs-title">lock</span>.<span class="hljs-title">unlock</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">&#125;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">17:05:08.957 [main] <span class="hljs-built_in">DEBUG</span> reentrantlockTest.ReentrantLockTest3 - 获得了锁<br>17:05:08.960 [t1] <span class="hljs-built_in">DEBUG</span> reentrantlockTest.ReentrantLockTest3 - 启动<span class="hljs-built_in">..</span>.<br>17:05:08.960 [t1] <span class="hljs-built_in">DEBUG</span> reentrantlockTest.ReentrantLockTest3 - 获取立刻失败，返回<br></code></pre></td></tr></table></figure>

<p>超时失败</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs livescript">ReentrantLock lock = <span class="hljs-keyword">new</span> ReentrantLock();<br>Thread t1 = <span class="hljs-keyword">new</span> Thread<span class="hljs-function"><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">    log.debug(<span class="hljs-string">&quot;启动...&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-keyword">try</span> &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-keyword">if</span> (!lock.tryLock(<span class="hljs-number">1</span>, TimeUnit.SECONDS)) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">            log.debug(<span class="hljs-string">&quot;获取等待 1s 后失败，返回&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function">            <span class="hljs-keyword">return</span>;</span></span><br><span class="hljs-params"><span class="hljs-function">        &#125;</span></span><br><span class="hljs-params"><span class="hljs-function">    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">        e.printStackTrace();</span></span><br><span class="hljs-params"><span class="hljs-function">    &#125;</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-keyword">try</span> &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">        log.debug(<span class="hljs-string">&quot;获得了锁&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function">    &#125; <span class="hljs-keyword">finally</span> &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">        lock.unlock();</span></span><br><span class="hljs-params"><span class="hljs-function">    &#125;</span></span><br><span class="hljs-params"><span class="hljs-function">&#125;, <span class="hljs-string">&quot;t1&quot;</span>)</span>;</span><br><span class="hljs-function"><span class="hljs-title">lock</span>.<span class="hljs-title">lock</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function"><span class="hljs-title">log</span>.<span class="hljs-title">debug</span><span class="hljs-params">(<span class="hljs-string">&quot;获得了锁&quot;</span>)</span>;</span><br><span class="hljs-function"><span class="hljs-title">t1</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function"><span class="hljs-title">try</span> &#123;</span><br><span class="hljs-function">    <span class="hljs-title">sleep</span><span class="hljs-params">(<span class="hljs-number">2</span>)</span>;</span><br><span class="hljs-function">&#125; <span class="hljs-title">finally</span> &#123;</span><br><span class="hljs-function">    <span class="hljs-title">lock</span>.<span class="hljs-title">unlock</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">&#125;</span><br><span class="hljs-function"></span><br></code></pre></td></tr></table></figure>

<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">17:07:37.062 [main] <span class="hljs-built_in">DEBUG</span> reentrantlockTest.ReentrantLockTest3 - 获得了锁<br>17:07:37.064 [t1] <span class="hljs-built_in">DEBUG</span> reentrantlockTest.ReentrantLockTest3 - 启动<span class="hljs-built_in">..</span>.<br>17:07:38.075 [t1] <span class="hljs-built_in">DEBUG</span> reentrantlockTest.ReentrantLockTest3 - 获取等待 1s 后失败，返回<br></code></pre></td></tr></table></figure>

<h3 id="公平锁"><a href="#公平锁" class="headerlink" title="公平锁"></a>公平锁</h3><p>ReentrantLock 默认是不公平的，什么是公平和不公平？在获取不到锁对象时，线程会进入阻塞队列，当执行线程完毕后，阻塞队列里的线程会一窝蜂来争抢锁对象，谁抢到就是谁的，而不是按进入队列的顺序先来后到。</p>
<h3 id="条件变量"><a href="#条件变量" class="headerlink" title="条件变量"></a>条件变量</h3><p>synchronized 中也有条件变量，就是我们讲原理时那个 waitSet 休息室，当条件不满足时进入 waitSet 等待。</p>
<p>ReentrantLock 的条件变量比 synchronized 强大之处在于，它是支持多个条件变量的，这就好比</p>
<ul>
<li>synchronized 是那些不满足条件的线程都在一间休息室等消息</li>
<li>await 执行后，会释放锁，进入 conditionObject 等待</li>
<li>await 的线程被唤醒（或打断、或超时）取重新竞争 lock 锁</li>
<li>竞争 lock 锁成功后，从 await 后继续执行</li>
</ul>
<p>例子：</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs livescript"><span class="hljs-keyword">static</span> ReentrantLock lock = <span class="hljs-keyword">new</span> ReentrantLock();<br><span class="hljs-keyword">static</span> Condition waitCigaretteQueue = lock.newCondition();<br><span class="hljs-keyword">static</span> Condition waitbreakfastQueue = lock.newCondition();<br><span class="hljs-keyword">static</span> volatile boolean hasCigrette = <span class="hljs-literal">false</span>;<br><span class="hljs-keyword">static</span> volatile boolean hasBreakfast = <span class="hljs-literal">false</span>;<br><br>public <span class="hljs-keyword">static</span> <span class="hljs-literal">void</span> main(<span class="hljs-built_in">String</span>[] args) throws InterruptedException &#123;<br>    <span class="hljs-keyword">new</span> Thread<span class="hljs-function"><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-keyword">try</span> &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">            lock.lock();</span></span><br><span class="hljs-params"><span class="hljs-function">            <span class="hljs-keyword">while</span> (!hasCigrette) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">                <span class="hljs-keyword">try</span> &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">                    log.debug(<span class="hljs-string">&quot;没烟抽，先等一会&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function">                    waitCigaretteQueue.<span class="hljs-keyword">await</span>();</span></span><br><span class="hljs-params"><span class="hljs-function">                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">                    e.printStackTrace();</span></span><br><span class="hljs-params"><span class="hljs-function">                &#125;</span></span><br><span class="hljs-params"><span class="hljs-function">            &#125;</span></span><br><span class="hljs-params"><span class="hljs-function">            log.debug(<span class="hljs-string">&quot;等到了它的烟&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function">        &#125; <span class="hljs-keyword">finally</span> &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">            lock.unlock();</span></span><br><span class="hljs-params"><span class="hljs-function">        &#125;</span></span><br><span class="hljs-params"><span class="hljs-function">    &#125;)</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function"></span><br><span class="hljs-function">    <span class="hljs-title">new</span> <span class="hljs-title">Thread</span><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-keyword">try</span> &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">            lock.lock();</span></span><br><span class="hljs-params"><span class="hljs-function">            <span class="hljs-keyword">while</span> (!hasBreakfast) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">                <span class="hljs-keyword">try</span> &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">                    log.debug(<span class="hljs-string">&quot;没饭吃，先等一会&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function">                    waitbreakfastQueue.<span class="hljs-keyword">await</span>();</span></span><br><span class="hljs-params"><span class="hljs-function">                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">                    e.printStackTrace();</span></span><br><span class="hljs-params"><span class="hljs-function">                &#125;</span></span><br><span class="hljs-params"><span class="hljs-function">            &#125;</span></span><br><span class="hljs-params"><span class="hljs-function">            log.debug(<span class="hljs-string">&quot;等到了它的早餐&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function">        &#125; <span class="hljs-keyword">finally</span> &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">            lock.unlock();</span></span><br><span class="hljs-params"><span class="hljs-function">        &#125;</span></span><br><span class="hljs-params"><span class="hljs-function">    &#125;)</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function"></span><br><span class="hljs-function">    <span class="hljs-title">sleep</span><span class="hljs-params">(<span class="hljs-number">1000</span>)</span>;</span><br><span class="hljs-function">    <span class="hljs-title">sendBreakfast</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">    <span class="hljs-title">sleep</span><span class="hljs-params">(<span class="hljs-number">1000</span>)</span>;</span><br><span class="hljs-function">    <span class="hljs-title">sendCigarette</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">&#125;</span><br><span class="hljs-function"><span class="hljs-title">private</span> <span class="hljs-title">static</span> <span class="hljs-title">void</span> <span class="hljs-title">sendCigarette</span><span class="hljs-params">()</span> &#123;</span><br><span class="hljs-function">    //先获取锁才能使用</span><br><span class="hljs-function">    <span class="hljs-title">lock</span>.<span class="hljs-title">lock</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">    <span class="hljs-title">try</span> &#123;</span><br><span class="hljs-function">        <span class="hljs-title">log</span>.<span class="hljs-title">debug</span><span class="hljs-params">(<span class="hljs-string">&quot;送烟来了&quot;</span>)</span>;</span><br><span class="hljs-function">        <span class="hljs-title">hasCigrette</span> = <span class="hljs-title">true</span>;</span><br><span class="hljs-function">        <span class="hljs-title">waitCigaretteQueue</span>.<span class="hljs-title">signal</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">    &#125; <span class="hljs-title">finally</span> &#123;</span><br><span class="hljs-function">        <span class="hljs-title">lock</span>.<span class="hljs-title">unlock</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">    &#125;</span><br><span class="hljs-function">&#125;</span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-title">private</span> <span class="hljs-title">static</span> <span class="hljs-title">void</span> <span class="hljs-title">sendBreakfast</span><span class="hljs-params">()</span> &#123;</span><br><span class="hljs-function">    <span class="hljs-title">lock</span>.<span class="hljs-title">lock</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">    <span class="hljs-title">try</span> &#123;</span><br><span class="hljs-function">        <span class="hljs-title">log</span>.<span class="hljs-title">debug</span><span class="hljs-params">(<span class="hljs-string">&quot;送早餐来了&quot;</span>)</span>;</span><br><span class="hljs-function">        <span class="hljs-title">hasBreakfast</span> = <span class="hljs-title">true</span>;</span><br><span class="hljs-function">        <span class="hljs-title">waitbreakfastQueue</span>.<span class="hljs-title">signal</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">    &#125; <span class="hljs-title">finally</span> &#123;</span><br><span class="hljs-function">        <span class="hljs-title">lock</span>.<span class="hljs-title">unlock</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">    &#125;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs routeros">19:12:46.838 [Thread-0] <span class="hljs-built_in">DEBUG</span> reentrantlockTest.ReentrantLockTest4 - 没烟抽，先等一会<br>19:12:46.840 [Thread-1] <span class="hljs-built_in">DEBUG</span> reentrantlockTest.ReentrantLockTest4 - 没饭吃，先等一会<br>19:12:47.838 [main] <span class="hljs-built_in">DEBUG</span> reentrantlockTest.ReentrantLockTest4 - 送早餐来了<br>19:12:47.838 [Thread-1] <span class="hljs-built_in">DEBUG</span> reentrantlockTest.ReentrantLockTest4 - 等到了它的早餐<br>19:12:48.852 [main] <span class="hljs-built_in">DEBUG</span> reentrantlockTest.ReentrantLockTest4 - 送烟来了<br>19:12:48.852 [Thread-0] <span class="hljs-built_in">DEBUG</span> reentrantlockTest.ReentrantLockTest4 - 等到了它的烟<br></code></pre></td></tr></table></figure>

<h2 id="同步模式之顺序控制"><a href="#同步模式之顺序控制" class="headerlink" title="同步模式之顺序控制"></a>同步模式之顺序控制</h2><h3 id="固定运行顺序打印"><a href="#固定运行顺序打印" class="headerlink" title="固定运行顺序打印"></a>固定运行顺序打印</h3><h4 id="wait-notify-版"><a href="#wait-notify-版" class="headerlink" title="wait notify 版"></a>wait notify 版</h4><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs livescript"><span class="hljs-keyword">static</span> final <span class="hljs-built_in">Object</span> lock = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Object</span>();<br><span class="hljs-keyword">static</span> volatile boolean  t2runed = <span class="hljs-literal">false</span>;<br><br>Thread t1 = <span class="hljs-keyword">new</span> Thread<span class="hljs-function"><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">            synchronized (lock)&#123;</span></span><br><span class="hljs-params"><span class="hljs-function">                <span class="hljs-keyword">while</span>(t2runed)&#123;</span></span><br><span class="hljs-params"><span class="hljs-function">                    <span class="hljs-keyword">try</span> &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">                        lock.wait();</span></span><br><span class="hljs-params"><span class="hljs-function"></span></span><br><span class="hljs-params"><span class="hljs-function">                    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">                        e.printStackTrace();</span></span><br><span class="hljs-params"><span class="hljs-function">                    &#125;</span></span><br><span class="hljs-params"><span class="hljs-function">                &#125;</span></span><br><span class="hljs-params"><span class="hljs-function"></span></span><br><span class="hljs-params"><span class="hljs-function">                System.out.println(<span class="hljs-string">&quot;1&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function">            &#125;</span></span><br><span class="hljs-params"><span class="hljs-function">        &#125;, <span class="hljs-string">&quot;t1&quot;</span>)</span>;</span><br><span class="hljs-function"></span><br><span class="hljs-function">        <span class="hljs-title">Thread</span> <span class="hljs-title">t2</span> = <span class="hljs-title">new</span> <span class="hljs-title">Thread</span><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">            System.out.println(<span class="hljs-string">&quot;2&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function">            synchronized (lock)&#123;</span></span><br><span class="hljs-params"><span class="hljs-function">                t2runed = <span class="hljs-literal">true</span>;</span></span><br><span class="hljs-params"><span class="hljs-function">                lock.notify();</span></span><br><span class="hljs-params"><span class="hljs-function">            &#125;</span></span><br><span class="hljs-params"><span class="hljs-function">        &#125;, <span class="hljs-string">&quot;t2&quot;</span>)</span>;</span><br><span class="hljs-function"></span><br><span class="hljs-function">        <span class="hljs-title">t1</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">        <span class="hljs-title">t2</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs">2<br>1<br></code></pre></td></tr></table></figure>

<h4 id="Park-Unpark-版"><a href="#Park-Unpark-版" class="headerlink" title="Park Unpark 版"></a>Park Unpark 版</h4><p>可以看到，实现上很麻烦：</p>
<ul>
<li>首先，需要保证先 wait 再 notify，否则 wait 线程永远得不到唤醒。因此使用了『运行标记』来判断该不该 wait，比如先notify再wait就出问题了。</li>
<li>第二，如果有些干扰线程错误地 notify 了 wait 线程，条件不满足时还要重新等待，使用了 while 循环来解决 此问题</li>
<li>最后，唤醒对象上的 wait 线程需要使用 notifyAll，因为『同步对象』上的等待线程可能不止一个</li>
</ul>
<p>可以使用 LockSupport 类的 park 和 unpark 来简化上面的题目：</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs livescript">Thread t1 = <span class="hljs-keyword">new</span> Thread<span class="hljs-function"><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function"> <span class="hljs-keyword">try</span> &#123; Thread.sleep(<span class="hljs-number">1000</span>); &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123; &#125;</span></span><br><span class="hljs-params"><span class="hljs-function"> <span class="hljs-regexp">// 当没有『许可』时，当前线程暂停运行；有『许可』时，用掉这个『许可』，当前线程恢复运行</span></span></span><br><span class="hljs-regexp"><span class="hljs-params"><span class="hljs-function"> LockSupport.park();</span></span></span><br><span class="hljs-regexp"><span class="hljs-params"><span class="hljs-function"> System.out.println(&quot;1&quot;);</span></span></span><br><span class="hljs-regexp"><span class="hljs-params"><span class="hljs-function">&#125;);</span></span></span><br><span class="hljs-regexp"><span class="hljs-params"><span class="hljs-function">Thread t2 = new Thread(() -&gt; &#123;</span></span></span><br><span class="hljs-regexp"><span class="hljs-params"><span class="hljs-function"> System.out.println(&quot;2&quot;);</span></span></span><br><span class="hljs-regexp"><span class="hljs-params"><span class="hljs-function"> //</span> 给线程 t1 发放『许可』（多次连续调用 unpark 只会发放一个『许可』）</span></span><br><span class="hljs-params"><span class="hljs-function"> LockSupport.unpark(t1);</span></span><br><span class="hljs-params"><span class="hljs-function">&#125;)</span>;</span><br><span class="hljs-function"><span class="hljs-title">t1</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function"><span class="hljs-title">t2</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br></code></pre></td></tr></table></figure>

<p>park 和 unpark 方法比较灵活，他俩谁先调用，谁后调用无所谓。并且是以线程为单位进行『暂停』和『恢复』， 不需要『同步对象』和『运行标记』</p>
<h3 id="交替输出"><a href="#交替输出" class="headerlink" title="交替输出"></a>交替输出</h3><p>线程 1 输出 a 5 次，线程 2 输出 b 5 次，线程 3 输出 c 5 次。现在要求输出 abcabcabcabcabc 怎么实现</p>
<h4 id="wait-notify-版-1"><a href="#wait-notify-版-1" class="headerlink" title="wait notify 版"></a>wait notify 版</h4><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs livescript">public <span class="hljs-keyword">class</span> <span class="hljs-title class_">OutPutTest3</span> &#123;<br>    public <span class="hljs-keyword">static</span> <span class="hljs-literal">void</span> main(<span class="hljs-built_in">String</span>[] args) &#123;<br>        SyncWaitNotify syncWaitNotify = <span class="hljs-keyword">new</span> SyncWaitNotify(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>);<br><br>        <span class="hljs-keyword">new</span> Thread<span class="hljs-function"><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">            syncWaitNotify.<span class="hljs-built_in">print</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-string">&quot;a&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function">        &#125;)</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">        <span class="hljs-title">new</span> <span class="hljs-title">Thread</span><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">            syncWaitNotify.<span class="hljs-built_in">print</span>(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-string">&quot;b&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function">        &#125;)</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">        <span class="hljs-title">new</span> <span class="hljs-title">Thread</span><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">            syncWaitNotify.<span class="hljs-built_in">print</span>(<span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&quot;c&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function">        &#125;)</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">    &#125;</span><br><span class="hljs-function">&#125;</span><br><span class="hljs-function"><span class="hljs-title">class</span> <span class="hljs-title">SyncWaitNotify</span> &#123;</span><br><span class="hljs-function">    <span class="hljs-title">private</span> <span class="hljs-title">int</span> <span class="hljs-title">flag</span>;</span><br><span class="hljs-function">    <span class="hljs-title">private</span> <span class="hljs-title">int</span> <span class="hljs-title">loopNumber</span>;</span><br><span class="hljs-function"></span><br><span class="hljs-function">    <span class="hljs-title">public</span> <span class="hljs-title">SyncWaitNotify</span><span class="hljs-params">(int flag, int loopNumber)</span> &#123;</span><br><span class="hljs-function">        <span class="hljs-title">this</span>.<span class="hljs-title">flag</span> = <span class="hljs-title">flag</span>;</span><br><span class="hljs-function">        <span class="hljs-title">this</span>.<span class="hljs-title">loopNumber</span> = <span class="hljs-title">loopNumber</span>;</span><br><span class="hljs-function">    &#125;</span><br><span class="hljs-function"></span><br><span class="hljs-function">    <span class="hljs-title">public</span> <span class="hljs-title">void</span> <span class="hljs-title">print</span><span class="hljs-params">(int waitFlag, int nextFlag, <span class="hljs-built_in">String</span> str)</span> &#123;</span><br><span class="hljs-function">        <span class="hljs-title">for</span> <span class="hljs-params">(int i = <span class="hljs-number">0</span>; i &lt; loopNumber; i++)</span> &#123;</span><br><span class="hljs-function">            <span class="hljs-title">synchronized</span> <span class="hljs-params">(this)</span>&#123;</span><br><span class="hljs-function">                <span class="hljs-title">while</span><span class="hljs-params">(flag != waitFlag)</span>&#123;</span><br><span class="hljs-function">                    <span class="hljs-title">try</span> &#123;</span><br><span class="hljs-function">                        <span class="hljs-title">this</span>.<span class="hljs-title">wait</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">                    &#125; <span class="hljs-title">catch</span> <span class="hljs-params">(InterruptedException e)</span> &#123;</span><br><span class="hljs-function">                        <span class="hljs-title">e</span>.<span class="hljs-title">printStackTrace</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">                    &#125;</span><br><span class="hljs-function">                &#125;</span><br><span class="hljs-function">                <span class="hljs-title">System</span>.<span class="hljs-title">out</span>.<span class="hljs-title">println</span><span class="hljs-params">(str)</span>;</span><br><span class="hljs-function">                <span class="hljs-title">flag</span> = <span class="hljs-title">nextFlag</span>;</span><br><span class="hljs-function">                <span class="hljs-title">this</span>.<span class="hljs-title">notifyAll</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">            &#125;</span><br><span class="hljs-function">        &#125;</span><br><span class="hljs-function">    &#125;</span><br><span class="hljs-function">&#125;</span><br></code></pre></td></tr></table></figure>

<h4 id="ReentrantLock版"><a href="#ReentrantLock版" class="headerlink" title="ReentrantLock版"></a>ReentrantLock版</h4><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs livescript">package output;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.locks.Condition;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.ReentrantLock;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @description: TODO(一句话描述该做什么)</span><br><span class="hljs-comment"> * @Author : </span><br><span class="hljs-comment"> */</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">OutPutTest4</span> &#123;<br>    public <span class="hljs-keyword">static</span> <span class="hljs-literal">void</span> main(<span class="hljs-built_in">String</span>[] args) throws InterruptedException &#123;<br>        AwaitSignal awaitSignal = <span class="hljs-keyword">new</span> AwaitSignal(<span class="hljs-number">5</span>);<br>        Condition a = awaitSignal.newCondition();<br>        Condition b = awaitSignal.newCondition();<br>        Condition c = awaitSignal.newCondition();<br><br>        <span class="hljs-keyword">new</span> Thread<span class="hljs-function"><span class="hljs-params">(()-&gt;&#123;</span></span><br><span class="hljs-params"><span class="hljs-function">            awaitSignal.<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;a&quot;</span>,a,b);</span></span><br><span class="hljs-params"><span class="hljs-function">        &#125;,<span class="hljs-string">&quot;t1&quot;</span>)</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">        <span class="hljs-title">new</span> <span class="hljs-title">Thread</span><span class="hljs-params">(()-&gt;&#123;</span></span><br><span class="hljs-params"><span class="hljs-function">            awaitSignal.<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;b&quot;</span>,b,c);</span></span><br><span class="hljs-params"><span class="hljs-function">        &#125;,<span class="hljs-string">&quot;t1&quot;</span>)</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function"></span><br><span class="hljs-function">        <span class="hljs-title">new</span> <span class="hljs-title">Thread</span><span class="hljs-params">(()-&gt;&#123;</span></span><br><span class="hljs-params"><span class="hljs-function">            awaitSignal.<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;c&quot;</span>,c,a);</span></span><br><span class="hljs-params"><span class="hljs-function">        &#125;,<span class="hljs-string">&quot;t1&quot;</span>)</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function"></span><br><span class="hljs-function">        <span class="hljs-title">Thread</span>.<span class="hljs-title">sleep</span><span class="hljs-params">(<span class="hljs-number">100</span>)</span>;</span><br><span class="hljs-function">        <span class="hljs-title">awaitSignal</span>.<span class="hljs-title">lock</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">        <span class="hljs-title">try</span> &#123;</span><br><span class="hljs-function">            <span class="hljs-title">a</span>.<span class="hljs-title">signal</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">        &#125;<span class="hljs-title">finally</span> &#123;</span><br><span class="hljs-function">            <span class="hljs-title">awaitSignal</span>.<span class="hljs-title">unlock</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">        &#125;</span><br><span class="hljs-function">    &#125;</span><br><span class="hljs-function">&#125;</span><br><span class="hljs-function"><span class="hljs-title">class</span> <span class="hljs-title">AwaitSignal</span> <span class="hljs-title">extends</span> <span class="hljs-title">ReentrantLock</span>&#123;</span><br><span class="hljs-function">    <span class="hljs-title">private</span> <span class="hljs-title">int</span> <span class="hljs-title">loopNumber</span>;</span><br><span class="hljs-function"></span><br><span class="hljs-function">    <span class="hljs-title">public</span> <span class="hljs-title">AwaitSignal</span><span class="hljs-params">(int loopNumber)</span> &#123;</span><br><span class="hljs-function">        <span class="hljs-title">this</span>.<span class="hljs-title">loopNumber</span> = <span class="hljs-title">loopNumber</span>;</span><br><span class="hljs-function">    &#125;</span><br><span class="hljs-function"></span><br><span class="hljs-function">    <span class="hljs-title">public</span> <span class="hljs-title">void</span> <span class="hljs-title">print</span><span class="hljs-params">( <span class="hljs-built_in">String</span> str,Condition cur,Condition next)</span>&#123;</span><br><span class="hljs-function"></span><br><span class="hljs-function">        <span class="hljs-title">for</span> <span class="hljs-params">(int i = <span class="hljs-number">0</span>; i &lt; loopNumber; i++)</span> &#123;</span><br><span class="hljs-function">            <span class="hljs-title">lock</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">            <span class="hljs-title">try</span> &#123;</span><br><span class="hljs-function">                <span class="hljs-title">cur</span>.<span class="hljs-title">await</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">                <span class="hljs-title">System</span>.<span class="hljs-title">out</span>.<span class="hljs-title">println</span><span class="hljs-params">(str)</span>;</span><br><span class="hljs-function">                <span class="hljs-title">next</span>.<span class="hljs-title">signal</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">            &#125; <span class="hljs-title">catch</span> <span class="hljs-params">(InterruptedException e)</span> &#123;</span><br><span class="hljs-function">                <span class="hljs-title">e</span>.<span class="hljs-title">printStackTrace</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">            &#125; <span class="hljs-title">finally</span> &#123;</span><br><span class="hljs-function">                <span class="hljs-title">unlock</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">            &#125;</span><br><span class="hljs-function">        &#125;</span><br><span class="hljs-function">    &#125;</span><br><span class="hljs-function">&#125;</span><br></code></pre></td></tr></table></figure>

<h4 id="park-x2F-unpark"><a href="#park-x2F-unpark" class="headerlink" title="park&#x2F;unpark"></a>park&#x2F;unpark</h4><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs livescript">package output;<br><br><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.locks.LockSupport;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @description: TODO(一句话描述该做什么)</span><br><span class="hljs-comment"> * @Author : 彭建飞</span><br><span class="hljs-comment"> */</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">OutPutTest5</span> &#123;<br>    <span class="hljs-keyword">static</span> Thread a;<br>    <span class="hljs-keyword">static</span> Thread b;<br>    <span class="hljs-keyword">static</span> Thread c;<br>    public <span class="hljs-keyword">static</span> <span class="hljs-literal">void</span> main(<span class="hljs-built_in">String</span>[] args) throws InterruptedException &#123;<br>        SyncPark syncPark = <span class="hljs-keyword">new</span> SyncPark(<span class="hljs-number">5</span>);<br>        a = <span class="hljs-keyword">new</span> Thread<span class="hljs-function"><span class="hljs-params">(()-&gt;&#123;</span></span><br><span class="hljs-params"><span class="hljs-function">            syncPark.<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;a&quot;</span>,b);</span></span><br><span class="hljs-params"><span class="hljs-function">        &#125;)</span>;</span><br><span class="hljs-function"></span><br><span class="hljs-function">        <span class="hljs-title">b</span> = <span class="hljs-title">new</span> <span class="hljs-title">Thread</span><span class="hljs-params">(()-&gt;&#123;</span></span><br><span class="hljs-params"><span class="hljs-function">            syncPark.<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;b&quot;</span>,c);</span></span><br><span class="hljs-params"><span class="hljs-function">        &#125;)</span>;</span><br><span class="hljs-function"></span><br><span class="hljs-function">        <span class="hljs-title">c</span> = <span class="hljs-title">new</span> <span class="hljs-title">Thread</span><span class="hljs-params">(()-&gt;&#123;</span></span><br><span class="hljs-params"><span class="hljs-function">            syncPark.<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;c&quot;</span>,a);</span></span><br><span class="hljs-params"><span class="hljs-function">        &#125;)</span>;</span><br><span class="hljs-function">        <span class="hljs-title">a</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">        <span class="hljs-title">b</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">        <span class="hljs-title">c</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">        <span class="hljs-title">Thread</span>.<span class="hljs-title">sleep</span><span class="hljs-params">(<span class="hljs-number">100</span>)</span>;</span><br><span class="hljs-function">        <span class="hljs-title">LockSupport</span>.<span class="hljs-title">unpark</span><span class="hljs-params">(a)</span>;</span><br><span class="hljs-function">    &#125;</span><br><span class="hljs-function">&#125;</span><br><span class="hljs-function"><span class="hljs-title">class</span> <span class="hljs-title">SyncPark</span>&#123;</span><br><span class="hljs-function">    <span class="hljs-title">private</span> <span class="hljs-title">int</span> <span class="hljs-title">loopNumber</span>;</span><br><span class="hljs-function"></span><br><span class="hljs-function">    <span class="hljs-title">public</span> <span class="hljs-title">SyncPark</span><span class="hljs-params">(int loopNumber)</span> &#123;</span><br><span class="hljs-function">        <span class="hljs-title">this</span>.<span class="hljs-title">loopNumber</span> = <span class="hljs-title">loopNumber</span>;</span><br><span class="hljs-function">    &#125;</span><br><span class="hljs-function"></span><br><span class="hljs-function">    <span class="hljs-title">public</span> <span class="hljs-title">void</span> <span class="hljs-title">print</span><span class="hljs-params">(<span class="hljs-built_in">String</span> str , Thread next)</span>&#123;</span><br><span class="hljs-function">        <span class="hljs-title">for</span> <span class="hljs-params">(int i = <span class="hljs-number">0</span>; i &lt; loopNumber; i++)</span> &#123;</span><br><span class="hljs-function">            <span class="hljs-title">LockSupport</span>.<span class="hljs-title">park</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">            <span class="hljs-title">System</span>.<span class="hljs-title">out</span>.<span class="hljs-title">println</span><span class="hljs-params">(str)</span>;</span><br><span class="hljs-function">            <span class="hljs-title">LockSupport</span>.<span class="hljs-title">unpark</span><span class="hljs-params">(next)</span>;</span><br><span class="hljs-function">        &#125;</span><br><span class="hljs-function">    &#125;</span><br><span class="hljs-function">&#125;</span><br><span class="hljs-function"></span><br></code></pre></td></tr></table></figure>

<h2 id="JMM"><a href="#JMM" class="headerlink" title="JMM"></a>JMM</h2><p>先聊几个问题</p>
<p><img src="C:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230707214957383.png" srcset="/img/loading.gif" lazyload alt="image-20230707214957383"></p>
<p>先来看操作系统中的一个架构</p>
<p><img src="C:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230707215340412.png" srcset="/img/loading.gif" lazyload alt="image-20230707215340412"></p>
<p>因为有那么多级的缓存(CPU和物理主内存的速度不一致的)，CPU的运行并<strong>不是直接操作内存而是先把内存里边的数据读取到缓存</strong>，而内存的读和写操作就会造成不一致的问题</p>
<p><img src="C:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230707220135160.png" srcset="/img/loading.gif" lazyload alt="image-20230707220135160"></p>
<p>JVM规范中试图定义一种Java内存模型(Java Memory Model,简称JMM)来<strong>屏蔽掉各种硬件和操作系统的内存访问差异</strong>以实现让Java程序在各种平台下都能达到一致的<strong>内存访问效果</strong></p>
<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>JMM(Java内存模型Java Memory Model，简称JMM)本身是一种<strong>抽象的</strong>概念<strong>并不真实存在</strong>它仅仅描述的<strong>是一组约定或规范</strong>，通过这组规范定义了程序中(尤其是多线程)各个变量的读写访问方式并决定一个线程对共享变量的写入何时以及如何变成对另一个线程可见，关键技术点都是围绕多线程的<strong>原子性、可见性和有序性</strong>展开的。</p>
<h3 id="原则"><a href="#原则" class="headerlink" title="原则"></a>原则</h3><p>JMM的关键技术点都是围绕多线程的<strong>原子性、可见性和有序性</strong>展开的</p>
<p><strong>能干吗？</strong></p>
<ul>
<li>通过JMM来实现<strong>线程和主内存之间的抽象关系</strong>。</li>
<li>屏蔽各个<strong>硬件平台</strong>和<strong>操作系统</strong>的内存访问差异以实现让Java程序在各种平台下都能达到一致的内存访问效果。</li>
</ul>
<h3 id="JMM规范下的三大特性"><a href="#JMM规范下的三大特性" class="headerlink" title="JMM规范下的三大特性"></a>JMM规范下的三大特性</h3><p><strong>可见性</strong>：是指当一个线程修改了某一个共享变量的值，其他线程是否能够立即知道该变更，JMM规定了所有的变量都存储在<strong>主内存</strong>中</p>
<p><img src="C:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230707222542359.png" srcset="/img/loading.gif" lazyload alt="image-20230707222542359"></p>
<p>系统主内存<strong>共享变量</strong>数据修改被写入的时机是不确定的，<strong>多线程并发下很可能出现”脏读”<strong>，所以每个线程都有自己的工作内存、线程自己的工作内存中保存了该线程使用到的变量的</strong>主内存副本拷贝</strong>，线程对变量的所有操作（读取，赋值等）都必需在线程自己的工作内存中进行，而不能够直接读写主内存中的变量。不同线程之间也无法直接访问对方工作内存中的变量，线程间变量值的传递均需要通过主内存来完成</p>
<p><img src="C:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230707224418765.png" srcset="/img/loading.gif" lazyload alt="image-20230707224418765"></p>
<p><strong>线程脏读</strong></p>
<p><img src="C:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230707224718299.png" srcset="/img/loading.gif" lazyload alt="image-20230707224718299"></p>
<p><strong>原子性</strong>：指一个操作是不可打断的，即多线程环境下，操作是不能被其他线程干扰的</p>
<p><strong>有序性</strong>：</p>
<p>JVM 会在不影响正确性的前提下，可以调整语句的执行顺序，思考下面一段代码</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs abnf">static int i<span class="hljs-comment">;</span><br>static int j<span class="hljs-comment">;</span><br>// 在某个线程内执行如下赋值操作<br><span class="hljs-attribute">i</span> <span class="hljs-operator">=</span> ...<span class="hljs-comment">; </span><br><span class="hljs-attribute">j</span> <span class="hljs-operator">=</span> ...<span class="hljs-comment">; </span><br></code></pre></td></tr></table></figure>

<p>可以看到，至于是先执行 i 还是 先执行 j ，对最终的结果不会产生影响。所以，上面代码真正执行时，既可以是</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">i</span> <span class="hljs-operator">=</span> ...<span class="hljs-comment">; </span><br><span class="hljs-attribute">j</span> <span class="hljs-operator">=</span> ...<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<p>也可以是</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">j</span> <span class="hljs-operator">=</span> ...<span class="hljs-comment">;</span><br><span class="hljs-attribute">i</span> <span class="hljs-operator">=</span> ...<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<p>这种特性称之为『指令重排』，多线程下『指令重排』会影响正确性。为什么要有重排指令这项优化呢？从 CPU 执行指令的原理来理解一下吧</p>
<h3 id="鱼罐头的故事"><a href="#鱼罐头的故事" class="headerlink" title="鱼罐头的故事"></a>鱼罐头的故事</h3><p>加工一条鱼需要 50 分钟，只能一条鱼、一条鱼顺序加工…</p>
<p><img src="C:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230708192343346.png" srcset="/img/loading.gif" lazyload alt="image-20230708192343346"></p>
<p>可以将每个鱼罐头的加工流程细分为 5 个步骤：</p>
<ul>
<li>去鳞清洗 10分钟 </li>
<li>蒸煮沥水 10分钟 </li>
<li>加注汤料 10分钟 </li>
<li>杀菌出锅 10分钟 </li>
<li>真空封罐 10分钟</li>
</ul>
<p><img src="C:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230708192435387.png" srcset="/img/loading.gif" lazyload alt="image-20230708192435387"></p>
<p>即使只有一个工人，最理想的情况是：他能够在 10 分钟内同时做好这 5 件事，因为对第一条鱼的真空装罐，不会 影响对第二条鱼的杀菌出锅…</p>
<h3 id="指令重排序"><a href="#指令重排序" class="headerlink" title="指令重排序"></a>指令重排序</h3><p>对于一个线程的执行代码而言，我们总是习惯性认为代码的执行总是从上到下，有序执行。但为了提升性能，编译器和处理器通常会对指令序列进行<strong>重新排序</strong>。Java规范规定JVM线程内部维持<strong>顺序化语义</strong>，即只要程序的最终结果与它顺序化执行的结果相等，那么指令的执行顺序可以与代码顺序<strong>不一致,此过程叫指令的重排序</strong>。</p>
<p>指令重排序优缺点：</p>
<p>JVM能根据处理器特性:(CPU多级缓存系统、多核处理器等）适当的对机器指令进行重排序，使机器指令能更符合CPU的执行特性，最大限度的发挥机器性能。但是，</p>
<p>指令重排<strong>可以保证串行语义一致</strong>，但没有义务保证<strong>多线程间的语义也一致</strong>(即可能产生”脏读”)，简单说.</p>
<p>两行以上不相干的代码在执行的时候有可能先执行的不是第一条，<strong>不见得是从上到下顺序执行，执行顺序会被优化</strong>。</p>
<p><strong>从源码到最终执行示例图：</strong></p>
<p><img src="C:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230707234808169.png" srcset="/img/loading.gif" lazyload alt="image-20230707234808169"></p>
<p>单线程环境里面确保程序最终执行结果和代码顺序执行的结果一致。处理器在进行重排序时<strong>必须要考虑</strong>指令之间的<strong>数据依赖性</strong>。</p>
<p>多线程环境中线程交替执行,由于编译器优化重排的存在，两个线程中使用的变量能否保证一致性是无法确定的,结果无法预测。</p>
<h3 id="指令重排序优化"><a href="#指令重排序优化" class="headerlink" title="指令重排序优化"></a>指令重排序优化</h3><p>事实上，现代处理器会设计为一个时钟周期完成一条执行时间最长的 CPU 指令。为什么这么做呢？可以想到指令 还可以再划分成一个个更小的阶段，例如，每条指令都可以分为： 取指令 - 指令译码 - 执行指令 - 内存访问 - 数据 写回 这 5 个阶段</p>
<p><img src="C:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230708192534371.png" srcset="/img/loading.gif" lazyload alt="image-20230708192534371"></p>
<p>在不改变程序结果的前提下，这些指令的各个阶段可以通过重排序和组合来实现指令级并行，这一技术在 80’s 中 叶到 90’s 中叶占据了计算架构的重要地位。</p>
<p>提示： 分阶段，分工是提升效率的关键！</p>
<p><strong>指令重排的前提是，重排指令不能影响结果，例如</strong></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span> 可以重排的例子<br>int a = <span class="hljs-number">10</span>; <span class="hljs-regexp">//</span> 指令<span class="hljs-number">1</span><br>int b = <span class="hljs-number">20</span>; <span class="hljs-regexp">//</span> 指令<span class="hljs-number">2</span><br>System.out.println( a + b );<br><span class="hljs-regexp">//</span> 不能重排的例子<br>int a = <span class="hljs-number">10</span>; <span class="hljs-regexp">//</span> 指令<span class="hljs-number">1</span><br>int b = a - <span class="hljs-number">5</span>; <span class="hljs-regexp">//</span> 指令<span class="hljs-number">2</span><br></code></pre></td></tr></table></figure>



<p>现代 CPU 支持多级指令流水线，例如支持同时执行 取指令 - 指令译码 - 执行指令 - 内存访问 - 数据写回 的处理 器，就可以称之为五级指令流水线。这时 CPU 可以在一个时钟周期内，同时运行五条指令的不同阶段（相当于一 条执行时间最长的复杂指令），IPC &#x3D; 1，本质上，流水线技术并不能缩短单条指令的执行时间，但它变相地提高了 指令地吞吐率。</p>
<p><img src="C:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230708192704187.png" srcset="/img/loading.gif" lazyload alt="image-20230708192704187"></p>
<h3 id="诡异的结果"><a href="#诡异的结果" class="headerlink" title="诡异的结果"></a>诡异的结果</h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-type">int</span> num = <span class="hljs-number">0</span>;<br><span class="hljs-type">boolean</span> ready = <span class="hljs-literal">false</span>;<br><span class="hljs-comment">// 线程1 执行此方法</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">actor1</span><span class="hljs-params">(I_Result r)</span> </span>&#123;<br> <span class="hljs-keyword">if</span>(ready) &#123;<br>     r.r1 = num + num;<br> &#125; <span class="hljs-keyword">else</span> &#123;<br>     r.r1 = <span class="hljs-number">1</span>;<br> &#125;<br>&#125;<br><span class="hljs-comment">// 线程2 执行此方法</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">actor2</span><span class="hljs-params">(I_Result r)</span> </span>&#123; <br> num = <span class="hljs-number">2</span>;<br> ready = <span class="hljs-literal">true</span>; <br>&#125;<br></code></pre></td></tr></table></figure>

<p>I_Result 是一个对象，有一个属性 r1 用来保存结果，问，可能的结果有几种？ </p>
<ul>
<li>情况1：线程1 先执行，这时 ready &#x3D; false，所以进入 else 分支结果为 1</li>
<li>情况2：线程2 先执行 num &#x3D; 2，但没来得及执行 ready &#x3D; true，线程1 执行，还是进入 else 分支，结果为1</li>
<li>情况3：线程2 执行到 ready &#x3D; true，线程1 执行，这回进入 if 分支，结果为 4（因为 num 已经执行过了）</li>
</ul>
<p>但我告诉你，结果还有可能是 0 😁😁😁，信不信吧！ 这种情况下是：线程2 执行 ready &#x3D; true，切换到线程1，进入 if 分支，相加为 0，再切回线程2 执行 num &#x3D; 2 相信很多人已经晕了 😵😵😵</p>
<p><strong>这种现象叫做指令重排，是 JIT 编译器在运行时的一些优化，这个现象需要通过大量测试才能复现</strong></p>
<p>那么怎么解决呢？</p>
<p>这里采取的是 volatile boolean ready &#x3D; false;</p>
<p>在ready前加上volatile，意思是在ready之前的都不能重排列到ready之后去</p>
<h3 id="内存屏障"><a href="#内存屏障" class="headerlink" title="内存屏障"></a>内存屏障</h3><p>内存屏障 Memory Barrier（Memory Fence）</p>
<ul>
<li>可见性<ul>
<li>写屏障（sfence）保证在该屏障<strong>之前的</strong>，对共享变量的改动，都同步到主存当中</li>
<li>而读屏障（lfence）保证在该屏障之后，对共享变量的读取，加载的是主存中最新数据</li>
</ul>
</li>
<li>有序性<ul>
<li>写屏障会确保指令重排序时，不会将写屏障之前的代码排在写屏障之后</li>
<li>读屏障会确保指令重排序时，不会将读屏障之后的代码排在读屏障之前</li>
</ul>
</li>
</ul>
<p><img src="C:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230708203312284.png" srcset="/img/loading.gif" lazyload alt="image-20230708203312284"></p>
<h3 id="volatile原理"><a href="#volatile原理" class="headerlink" title="volatile原理"></a>volatile原理</h3><p>volatile 的底层实现原理是内存屏障，Memory Barrier（Memory Fence）</p>
<ul>
<li>对 volatile 变量的写指令后会加入写屏障</li>
<li>对 volatile 变量的读指令前会加入读屏障</li>
</ul>
<h4 id="如何保证可见性"><a href="#如何保证可见性" class="headerlink" title="如何保证可见性"></a>如何保证可见性</h4><ul>
<li>写屏障（sfence）保证在该屏障之前的，对共享变量的改动，都同步到主存当中</li>
</ul>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">actor2</span><span class="hljs-params">(I_Result r)</span> </span>&#123;<br>     num = <span class="hljs-number">2</span>;<br>     ready = <span class="hljs-literal">true</span>; <span class="hljs-comment">// ready 是 volatile 赋值带写屏障</span><br>     <span class="hljs-comment">// 加写屏障</span><br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>而读屏障（lfence）保证在该屏障之后，对共享变量的读取，加载的是主存中最新数据</li>
</ul>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">actor1</span><span class="hljs-params">(I_Result r)</span> </span>&#123;<br>     <span class="hljs-comment">// 读屏障</span><br>     <span class="hljs-comment">// ready 是 volatile 读取值带读屏障</span><br>     <span class="hljs-keyword">if</span>(ready) &#123;<br>        r.r1 = num + num;<br>     &#125; <span class="hljs-keyword">else</span> &#123;<br>        r.r1 = <span class="hljs-number">1</span>;<br>     &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><img src="C:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230708205155910.png" srcset="/img/loading.gif" lazyload alt="image-20230708205155910"></p>
<h4 id="如何保证有序性"><a href="#如何保证有序性" class="headerlink" title="如何保证有序性"></a>如何保证有序性</h4><ul>
<li>写屏障会确保指令重排序时，不会将写屏障之前的代码排在写屏障之后</li>
</ul>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">actor2</span><span class="hljs-params">(I_Result r)</span> </span>&#123;<br>    num = <span class="hljs-number">2</span>;<br>    ready = <span class="hljs-literal">true</span>; <span class="hljs-comment">// ready 是 volatile 赋值带写屏障</span><br>    <span class="hljs-comment">// 加写屏障</span><br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>读屏障会确保指令重排序时，不会将读屏障之后的代码排在读屏障之前</li>
</ul>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">actor1</span><span class="hljs-params">(I_Result r)</span> </span>&#123;<br>    <span class="hljs-comment">//加读屏障</span><br>    <span class="hljs-comment">// ready 是 volatile 读取值带读屏障</span><br>    <span class="hljs-keyword">if</span>(ready) &#123;<br>       r.r1 = num + num;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>       r.r1 = <span class="hljs-number">1</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="C:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230708205902062.png" srcset="/img/loading.gif" lazyload alt="image-20230708205902062"></p>
<p>还是那句话，不能解决指令交错：</p>
<ul>
<li>写屏障仅仅是保证之后的读能够读到最新的结果，但不能保证读跑到它前面去</li>
<li>而有序性的保证也只是保证了本线程内相关代码不被重排序</li>
</ul>
<p><img src="C:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230708211016744.png" srcset="/img/loading.gif" lazyload alt="image-20230708211016744"></p>
<p>volatile只能保证线程的可见性和有序性，不能保证原子性，如上图，而synchronized三者都可保证</p>
<h3 id="单例模式double-checked-locking-问题"><a href="#单例模式double-checked-locking-问题" class="headerlink" title="单例模式double-checked locking 问题"></a>单例模式double-checked locking 问题</h3><p>以著名的 double-checked locking 单例模式为例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton</span><span class="hljs-params">()</span> &#123; &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Singleton</span> <span class="hljs-variable">INSTANCE</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123; <br>        <span class="hljs-keyword">if</span>(INSTANCE == <span class="hljs-literal">null</span>) &#123; <span class="hljs-comment">// t2</span><br>        <span class="hljs-comment">// 首次访问会同步，而之后的使用没有 synchronized</span><br>            <span class="hljs-keyword">synchronized</span>(Singleton.class) &#123;<br>               <span class="hljs-keyword">if</span> (INSTANCE == <span class="hljs-literal">null</span>) &#123; <span class="hljs-comment">// t1</span><br>                 INSTANCE = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();<br>               &#125; <br>             &#125;<br>          &#125;<br>          <span class="hljs-keyword">return</span> INSTANCE;<br>     &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>以上的实现特点是：</p>
<ul>
<li>懒惰实例化</li>
<li>首次使用 getInstance() 才使用 synchronized 加锁，后续使用时无需加锁</li>
<li>有隐含的，但很关键的一点：第一个 if 使用了 INSTANCE 变量，是在同步块之外</li>
</ul>
<p>但在多线程环境下，上面的代码是有问题的，getInstance 方法对应的字节码为：</p>
<figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs ldif"><span class="hljs-attribute">0</span>: getstatic <span class="hljs-comment">#2        // Field INSTANCE:Lcn/itcast/n5/Singleton;</span><br><span class="hljs-attribute">3</span>: ifnonnull 37<br><span class="hljs-attribute">6</span>: ldc <span class="hljs-comment">#3              // class cn/itcast/n5/Singleton</span><br><span class="hljs-attribute">8</span>: dup<br><span class="hljs-attribute">9</span>: astore_0<br><span class="hljs-attribute">10</span>: monitorenter<br><span class="hljs-attribute">11</span>: getstatic <span class="hljs-comment">#2       // Field INSTANCE:Lcn/itcast/n5/Singleton;</span><br><span class="hljs-attribute">14</span>: ifnonnull 27<br><span class="hljs-attribute">17</span>: new <span class="hljs-comment">#3             // class cn/itcast/n5/Singleton</span><br><span class="hljs-attribute">20</span>: dup<br><span class="hljs-attribute">21</span>: invokespecial <span class="hljs-comment">#4   // Method &quot;&lt;init&gt;&quot;:()V</span><br><span class="hljs-attribute">24</span>: putstatic <span class="hljs-comment">#2       // Field INSTANCE:Lcn/itcast/n5/Singleton;</span><br><span class="hljs-attribute">27</span>: aload_0<br><span class="hljs-attribute">28</span>: monitorexit<br><span class="hljs-attribute">29</span>: goto 37<br><span class="hljs-attribute">32</span>: astore_1<br><span class="hljs-attribute">33</span>: aload_0<br><span class="hljs-attribute">34</span>: monitorexit<br><span class="hljs-attribute">35</span>: aload_1<br><span class="hljs-attribute">36</span>: athrow<br><span class="hljs-attribute">37</span>: getstatic <span class="hljs-comment">#2       // Field INSTANCE:Lcn/itcast/n5/Singleton;</span><br><span class="hljs-attribute">40</span>: areturn<br></code></pre></td></tr></table></figure>

<p>其中</p>
<ul>
<li>17 表示创建对象，将对象引用入栈 &#x2F;&#x2F; new Singleton</li>
<li>20 表示复制一份对象引用 &#x2F;&#x2F; 引用地址</li>
<li>21 表示利用一个对象引用，调用构造方法</li>
<li>24 表示利用一个对象引用，赋值给 static INSTANCE</li>
</ul>
<p>也许 jvm 会优化为：先执行 24，再执行 21。如果两个线程 t1，t2 按如下时间序列执行：</p>
<p><img src="C:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230709102151941.png" srcset="/img/loading.gif" lazyload alt="image-20230709102151941"></p>
<p>关键在于 0: getstatic 这行代码在 monitor 控制之外，它就像之前举例中不守规则的人，可以越过 monitor 读取 INSTANCE 变量的值 这时 t1 还未完全将构造方法执行完毕，如果在构造方法中要执行很多初始化操作，那么 t2 拿到的是将是一个<strong>未初 始化完毕的单例</strong> 对 INSTANCE 使用 volatile 修饰即可，可以禁用指令重排，但要注意在 JDK 5 以上的版本的 volatile 才会真正有效</p>
<h3 id="double-checked-locking-解决"><a href="#double-checked-locking-解决" class="headerlink" title="double-checked locking 解决"></a>double-checked locking 解决</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> final <span class="hljs-keyword">class</span> <span class="hljs-title">Singleton</span> &#123;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Singleton</span>()</span> &#123; &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> Singleton INSTANCE = <span class="hljs-literal">null</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title">getInstance</span>()</span> &#123;<br>        <span class="hljs-comment">// 实例没创建，才会进入内部的 synchronized代码块</span><br>        <span class="hljs-keyword">if</span> (INSTANCE == <span class="hljs-literal">null</span>) &#123; <br>           synchronized (Singleton.<span class="hljs-keyword">class</span>) &#123; <span class="hljs-comment">// t2</span><br>              <span class="hljs-comment">// 也许有其它线程已经创建实例，所以再判断一次</span><br>              <span class="hljs-keyword">if</span> (INSTANCE == <span class="hljs-literal">null</span>) &#123; <span class="hljs-comment">// t1</span><br>                 INSTANCE = <span class="hljs-keyword">new</span> Singleton();<br>              &#125;<br>           &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> INSTANCE;<br>     &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>字节码上看不出来 volatile 指令的效果</p>
<figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs ldif">// -------------------------------------&gt; 加入对 INSTANCE 变量的读屏障<br><span class="hljs-attribute">0</span>: getstatic <span class="hljs-comment">#2     // Field INSTANCE:Lcn/itcast/n5/Singleton;</span><br><span class="hljs-attribute">3</span>: ifnonnull 37<br><span class="hljs-attribute">6</span>: ldc <span class="hljs-comment">#3       // class cn/itcast/n5/Singleton</span><br><span class="hljs-attribute">8</span>: dup<br><span class="hljs-attribute">9</span>: astore_0<br><span class="hljs-attribute">10</span>: monitorenter -----------------------&gt; 保证原子性、可见性<br><span class="hljs-attribute">11</span>: getstatic <span class="hljs-comment">#2     // Field INSTANCE:Lcn/itcast/n5/Singleton;</span><br><span class="hljs-attribute">14</span>: ifnonnull 27<br><span class="hljs-attribute">17</span>: new <span class="hljs-comment">#3     // class cn/itcast/n5/Singleton</span><br><span class="hljs-attribute">20</span>: dup<br><span class="hljs-attribute">21</span>: invokespecial <span class="hljs-comment">#4     // Method &quot;&lt;init&gt;&quot;:()V</span><br><span class="hljs-attribute">24</span>: putstatic <span class="hljs-comment">#2     // Field INSTANCE:Lcn/itcast/n5/Singleton;</span><br>// -------------------------------------&gt; 加入对 INSTANCE 变量的写屏障<br><span class="hljs-attribute">27</span>: aload_0<br><span class="hljs-attribute">28</span>: monitorexit ------------------------&gt; 保证原子性、可见性<br><span class="hljs-attribute">29</span>: goto 37<br><span class="hljs-attribute">32</span>: astore_1<br><span class="hljs-attribute">33</span>: aload_0<br><span class="hljs-attribute">34</span>: monitorexit<br><span class="hljs-attribute">35</span>: aload_1<br><span class="hljs-attribute">36</span>: athrow<br><span class="hljs-attribute">37</span>: getstatic <span class="hljs-comment">#2   // Field INSTANCE:Lcn/itcast/n5/Singleton;</span><br><span class="hljs-attribute">40</span>: areturn<br></code></pre></td></tr></table></figure>

<p>如上面的注释内容所示，读写 volatile 变量时会加入内存屏障（Memory Barrier（Memory Fence）），保证下面 两点：</p>
<ul>
<li>可见性<ul>
<li><strong>写屏障（sfence）</strong>保证在该屏障<strong>之前</strong>的 t1 对共享变量的改动，都同步到主存当中</li>
<li>而<strong>读屏障（lfence）</strong>保证在该屏障<strong>之后</strong> t2 对共享变量的读取，加载的是主存中最新数据</li>
</ul>
</li>
<li>有序性<ul>
<li>写屏障会确保指令重排序时，不会将写屏障之前的代码排在写屏障之后</li>
<li>读屏障会确保指令重排序时，不会将读屏障之后的代码排在读屏障之前</li>
</ul>
</li>
<li>更底层是读写变量时使用 lock 指令来多核 CPU 之间的可见性与有序性</li>
</ul>
<p><img src="C:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230709102042785.png" srcset="/img/loading.gif" lazyload alt="image-20230709102042785"></p>
<h3 id="读取过程"><a href="#读取过程" class="headerlink" title="读取过程"></a>读取过程</h3><p>由于JVM运行程序的实体是线醒，而每个线程创建时JVM都会为其创建一个工作内存(有些地方称为栈空间)，工作内存是每个线程的私有数据区域，而Java内存模型中规定所有变量都存储在<strong>主内存</strong>，主内存是共享内存区域，所有线程都可以访问，<strong>但线程对变量的操作(读取赋值等)必须在工作内存中进行，首先要将变量从主内存拷贝到的线程自己的工作内存空间，然后对变量进行操作，操作完成后再将变量写回主内存</strong>，不能直接操作主内存中的变量，各个线程中的工作内存中存储着主内存中的<strong>变量副本拷贝</strong>，因此不同的线程间无法访问对方的工作内存，线程间的通信(传值)必须通过主内存来完成，其简要访问过程如下图:</p>
<p><img src="C:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230708115509974.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="Happens-before-先行发生-原则"><a href="#Happens-before-先行发生-原则" class="headerlink" title="Happens-before(先行发生)原则"></a>Happens-before(先行发生)原则</h3><p>在JMM中，如果一个操作<strong>执行的结果</strong>需要对另一个操作可见性或者代码重排序，那么这两个操作之间必须存在<strong>Happens-before</strong>原则。</p>
<p>逻辑上的先后关系。</p>
<p><img src="C:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230708121608334.png" srcset="/img/loading.gif" lazyload alt="image-20230708121608334"></p>
<p>如果Java内存模型中所有的有序性都仅靠volatile和synchronized来完成，那么有很多操作都将会变得非常啰嗦，但是我们在编写Java并发代码的时候并没有察觉到这一点。</p>
<p>我们没有时时、处处、次次，添加volatile和synchronized来完成程序，这是因为Java语言中JMM原则下有一个“先行发生”(Happens-Before)的原则限制和规矩，给你立好了规矩!</p>
<p>这个原则非常重要:</p>
<p>它是判断数据是否存在竞争，线程是否安全的非常有用的手段。依赖这个原则，我们可以通过几条简单规则一揽子解决并发环境下两个操作之间是否可能存在冲突的所有问题，而不需要陷入Java内存模型苦涩难懂的底层编译原理之中</p>
<p><strong>总原则</strong></p>
<ul>
<li>如果一个操作<strong>happens-before</strong>另一个操作，那么第一个操作的执行结果将对第二个操作可见，而且第一个操作的执行顺序排在第二个操作之前。</li>
<li>两个操作之间存在happens-before关系，并不意味着一定要按照happens-before原则制定的顺序来执行。如果重排序之后的执行结果与按照happens-before关系来执行的<strong>结果一致</strong>，那么这种重排序<strong>并不非法</strong></li>
</ul>
<p><img src="C:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230708124934452.png" srcset="/img/loading.gif" lazyload alt="image-20230708124934452"></p>
<p><img src="C:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230708144718535.png" srcset="/img/loading.gif" lazyload alt="image-20230708144718535"></p>
<h2 id="AQS"><a href="#AQS" class="headerlink" title="AQS"></a>AQS</h2><p>全称是 AbstractQueuedSynchronizer(抽象队列同步器)，是<strong>阻塞式锁</strong>和<strong>相关的同步器工具</strong>的框架</p>
<p>特点：</p>
<ul>
<li>用 state 属性来表示资源的状态（分独占模式和共享模式），子类需要定义如何维护这个状态，控制如何获取 锁和释放锁<ul>
<li>getState - 获取 state 状态</li>
<li>setState - 设置 state 状态</li>
<li>compareAndSetState - cas 机制设置 state 状态</li>
<li>独占模式是只有一个线程能够访问资源，而共享模式可以允许多个线程访问资源</li>
</ul>
</li>
<li>提供了基于 FIFO 的等待队列，类似于 Monitor 的 EntryList</li>
<li>条件变量来实现等待、唤醒机制，支持多个条件变量，类似于 Monitor 的 WaitSet</li>
</ul>
<p>子类主要实现这样一些方法（默认抛出 UnsupportedOperationException）</p>
<ul>
<li>tryAcquire</li>
<li>tryRelease</li>
<li>tryAcquireShared</li>
<li>tryReleaseShared</li>
<li>isHeldExclusively</li>
</ul>
<h3 id="实现不可重入锁"><a href="#实现不可重入锁" class="headerlink" title="实现不可重入锁"></a>实现不可重入锁</h3><p>创建同步器类</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">//同步器类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MySyn</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">AbstractQueuedSynchronizer</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">tryAcquire</span>(<span class="hljs-params">int arg</span>) &#123;<br>       <span class="hljs-keyword">if</span>( <span class="hljs-title function_">compareAndSetState</span>(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>))&#123;<br>           <span class="hljs-title function_">setExclusiveOwnerThread</span>(<span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">currentThread</span>());<br>           <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>       &#125;<br>       <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">tryRelease</span>(<span class="hljs-params">int arg</span>) &#123;<br>        <span class="hljs-title function_">setExclusiveOwnerThread</span>(<span class="hljs-literal">null</span>);<br>        <span class="hljs-title function_">setState</span>(<span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isHeldExclusively</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_">getState</span>() == <span class="hljs-number">1</span> ;<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-title class_">Condition</span> <span class="hljs-title function_">newCondition</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConditionObject</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>创建锁类</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Lock</span> </span>&#123;<br>    MySyn syn = <span class="hljs-keyword">new</span> MySyn();<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">lock</span><span class="hljs-params">()</span> </span>&#123;<br>        syn.acquire(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">lockInterruptibly</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>        syn.acquireInterruptibly(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">tryLock</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-function"><span class="hljs-keyword">return</span> syn.<span class="hljs-title">tryAcquire</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span></span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">tryLock</span><span class="hljs-params">(<span class="hljs-keyword">long</span> time, TimeUnit unit)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>        <span class="hljs-keyword">return</span> syn.tryAcquireNanos(<span class="hljs-number">1</span>, unit.toNanos(time));<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">unlock</span><span class="hljs-params">()</span> </span>&#123;<br>        syn.release(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function">Condition <span class="hljs-title">newCondition</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-function"><span class="hljs-keyword">return</span> syn.<span class="hljs-title">newCondition</span><span class="hljs-params">()</span></span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs livescript">public <span class="hljs-keyword">static</span> <span class="hljs-literal">void</span> main(<span class="hljs-built_in">String</span>[] args) &#123;<br>        MyLock lock = <span class="hljs-keyword">new</span> MyLock();<br>        <span class="hljs-keyword">new</span> Thread<span class="hljs-function"><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">            lock.lock();</span></span><br><span class="hljs-params"><span class="hljs-function">            <span class="hljs-keyword">try</span> &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">                log.debug(<span class="hljs-string">&quot;locking...&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function">                Thread.sleep(<span class="hljs-number">1000</span>);</span></span><br><span class="hljs-params"><span class="hljs-function">            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">                e.printStackTrace();</span></span><br><span class="hljs-params"><span class="hljs-function">            &#125; <span class="hljs-keyword">finally</span> &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">                log.debug(<span class="hljs-string">&quot;unlocking...&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function">                lock.unlock();</span></span><br><span class="hljs-params"><span class="hljs-function">            &#125;</span></span><br><span class="hljs-params"><span class="hljs-function">        &#125;,<span class="hljs-string">&quot;t1&quot;</span>)</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">        <span class="hljs-title">new</span> <span class="hljs-title">Thread</span><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">            lock.lock();</span></span><br><span class="hljs-params"><span class="hljs-function">            <span class="hljs-keyword">try</span> &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">                log.debug(<span class="hljs-string">&quot;locking...&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function">            &#125; <span class="hljs-keyword">finally</span> &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">                log.debug(<span class="hljs-string">&quot;unlocking...&quot;</span>);</span></span><br><span class="hljs-params"><span class="hljs-function">                lock.unlock();</span></span><br><span class="hljs-params"><span class="hljs-function">            &#125;</span></span><br><span class="hljs-params"><span class="hljs-function">        &#125;,<span class="hljs-string">&quot;t2&quot;</span>)</span>.<span class="hljs-title">start</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">    &#125;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-number">20</span>:<span class="hljs-number">24</span>:<span class="hljs-number">43</span>.<span class="hljs-number">861</span> [<span class="hljs-built_in">t1</span>] <span class="hljs-built_in">DEBUG</span> AQSTest.AQStest - locking...<br><span class="hljs-number">20</span>:<span class="hljs-number">24</span>:<span class="hljs-number">44</span>.<span class="hljs-number">875</span> [<span class="hljs-built_in">t1</span>] <span class="hljs-built_in">DEBUG</span> AQSTest.AQStest - unlocking...<br><span class="hljs-number">20</span>:<span class="hljs-number">24</span>:<span class="hljs-number">44</span>.<span class="hljs-number">875</span> [<span class="hljs-built_in">t2</span>] <span class="hljs-built_in">DEBUG</span> AQSTest.AQStest - locking...<br><span class="hljs-number">20</span>:<span class="hljs-number">24</span>:<span class="hljs-number">44</span>.<span class="hljs-number">875</span> [<span class="hljs-built_in">t2</span>] <span class="hljs-built_in">DEBUG</span> AQSTest.AQStest - unlocking...<br></code></pre></td></tr></table></figure>

<h2 id="ReentrantLock-1"><a href="#ReentrantLock-1" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h2><p><img src="C:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230709215715775.png" srcset="/img/loading.gif" lazyload alt="image-20230709215715775"></p>
<h3 id="非公平锁实现原理"><a href="#非公平锁实现原理" class="headerlink" title="非公平锁实现原理"></a>非公平锁实现原理</h3><p><strong>加锁解锁流程</strong></p>
<p>先从构造器开始看，默认为非公平锁实现</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ReentrantLock</span>()</span> &#123;<br>   sync = <span class="hljs-keyword">new</span> NonfairSync();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>NonfairSync 继承自 AQS</p>
<p><img src="C:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230709215859835.png" srcset="/img/loading.gif" lazyload alt="image-20230709215859835"></p>
<p>没有竞争时</p>
<p><img src="C:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230709215920057.png" srcset="/img/loading.gif" lazyload alt="image-20230709215920057"></p>
<p>第一个竞争出现时</p>
<p><img src="C:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230709220045966.png" srcset="/img/loading.gif" lazyload alt="image-20230709220045966"></p>
<p>Thread-1 执行了</p>
<ul>
<li>CAS 尝试将 state 由 0 改为 1，结果失败</li>
</ul>
<p><img src="C:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230709220711944.png" srcset="/img/loading.gif" lazyload alt="image-20230709220711944"></p>
<ul>
<li>进入 tryAcquire 逻辑，这时 state 已经是1，结果仍然失败</li>
</ul>
<p><img src="C:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230709220737276.png" srcset="/img/loading.gif" lazyload alt="image-20230709220737276"></p>
<p><img src="C:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230709220749139.png" srcset="/img/loading.gif" lazyload alt="image-20230709220749139"></p>
<ul>
<li>接下来进入 addWaiter 逻辑，构造 Node 队列<ul>
<li>图中黄色三角表示该 Node 的 waitStatus 状态，其中 0 为默认正常状态</li>
<li>Node 的创建是懒惰的</li>
<li>其中第一个 Node 称为 Dummy（哑元）或哨兵，用来占位，并不关联线程</li>
</ul>
</li>
</ul>
<p><img src="C:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230709220844407.png" srcset="/img/loading.gif" lazyload alt="image-20230709220844407"></p>
<p>当前线程进入 acquireQueued 逻辑</p>
<p><img src="C:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230709221118587.png" srcset="/img/loading.gif" lazyload alt="image-20230709221118587"></p>
<ul>
<li>acquireQueued 会在一个死循环中不断尝试获得锁，失败后进入 park 阻塞</li>
<li>如果自己是紧邻着 head（排第二位），那么再次 tryAcquire 尝试获取锁，当然这时 state 仍为 1，失败</li>
<li>进入 shouldParkAfterFailedAcquire 逻辑，将前驱 node，即 head(Node(null)) 的 waitStatus 改为 -1，这次返回 false</li>
</ul>
<p><img src="C:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230709221724573.png" srcset="/img/loading.gif" lazyload alt="image-20230709221724573"></p>
<ul>
<li>shouldParkAfterFailedAcquire 执行完毕回到 acquireQueued ，再次 tryAcquire 尝试获取锁，当然这时 state 仍为 1，失败</li>
<li>当再次进入 shouldParkAfterFailedAcquire 时，这时因为其前驱 node 的 waitStatus 已经是 -1，这次返回 true</li>
<li>进入 parkAndCheckInterrupt， Thread-1 park（灰色表示）</li>
</ul>
<p><img src="C:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230709221953856.png" srcset="/img/loading.gif" lazyload alt="image-20230709221953856"></p>
<p>再次有多个线程经历上述过程竞争失败，变成这个样子</p>
<p><img src="C:\Users\86185\AppData\Roaming\Typora\typora-user-images\image-20230709222007039.png" srcset="/img/loading.gif" lazyload alt="image-20230709222007039"></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Juc</div>
      <div>http://example.com/2023/02/22/Juc/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>彭</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>February 22, 2023</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/02/22/JavaWeb/" title="SpringMvc">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">SpringMvc</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/02/22/Jvm/" title="Jvm">
                        <span class="hidden-mobile">Jvm</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
